var __spreadArray=this&&this.__spreadArray||function(n,t,i){if(i||arguments.length===2)for(var r=0,f=t.length,u;r<f;r++)!u&&r in t||(u||(u=Array.prototype.slice.call(t,0,r)),u[r]=t[r]);return n.concat(u||Array.prototype.slice.call(t))},WSB;(function(n){var h=2,c=5,i=200,o=864e5,l="/msrewards/api/v1/getuserinfo",a="https://account.microsoft.com/rewards?ref=WSB",v=function(n){return"https://account.microsoft.com/rewards/createuser?publ=CORTIP&crea=MY019H&pn=MULTIWSBACQ201910&returnUrl=%2Frewards%2Fredirect%3Flink%3D%252Frewards%26id%3Dbingtrial_250%26channel%3Dwsb%26type%3D16%26amount%3D"+n+"%26hash%3Db3bc83aeabe24a90fade4e7e81e00d5fda4aeb66abe9f569a27c5a97a75e8f57"},s="RewardsBadgeNotificationLastShownDate",u="RewardsBadgeNotificationTimesShown",y=function(){function l(i,u){var e=this,o;this._page=i;this._accessTokenManager=u;this._balance=new f;this._rewardsBadgeUpdatedHandlers=[];this._retryAttempted=0;r.init();t.init();o=function(){e._currentConversationId||(e._currentConversationId=n.Host.getConversationId(),e.isFeatureEnabled()&&e._msaAccount&&e.refreshBalance())};n.Host.bindConversationStart(function(){return o()});n.Host.bindQueryChangedOrInitialized(function(){return o()});n.Host.bindDismissed(function(){e.clear();e._msaAccount=null;e._currentConversationId=null;t.onDismiss();n.config.enableEduFlyoutRewardsSystem&&e._flyout&&e._flyout.hide();e.shouldShowRewardsFlyout()&&n.RewardsFlyoutViewModel&&n.RewardsFlyoutViewModel.hideRewardsFlyout()});u.bindSelectedAccountChanged(function(n){if(e.isFeatureEnabled()){var t=n&&n.accountProviderAuthority=="consumers"?n:null;e.handleNewAccountAvailable(t)}});u.bindAccountTypesChanged(function(){if(e.isFeatureEnabled()){var t=u.getCachedAccountInfo(0);e.handleNewAccountAvailable(t,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MSFTRewardsViewsModel::handleAccountTypeChanged"]:undefined)}});u.bindAccessTokenAvailable(function(n,t){if(n==0&&e.isFeatureEnabled())if(e._msaAccount)e.refreshBalance();else{var i=u.getCachedAccountInfo(0);e.handleNewAccountAvailable(i)}})}return l.prototype.shouldShowBadgeNotification=function(){var t;if(!this.shouldShowRewardsFlyout()||!n.config.rewardsFlyoutNotification||!this._userIsRewardsMember&&!n.config.rewardsFlyoutNotifNonMember)return!1;if(t=Number(n.LightweightStorage.getItem(s))||0,this._userIsRewardsMember)return t==0||t+o<=n.getCurrentTime();var i=parseInt(n.LightweightStorage.getItem(u))||0,r=i<3,f=t==0||t+o*7<=n.getCurrentTime();return f&&r},l.prototype.onBadgeNotificationShown=function(){var t=parseInt(n.LightweightStorage.getItem(u))||0;n.LightweightStorage.setItem(s,n.getCurrentTime().toString());n.LightweightStorage.setItem(u,(t+1).toString());this.fireRewardsBadgeUpdated()},l.prototype.initializeEducationExperience=function(){var i=this,t;if(this._page!=null&&n.RewardsFlyoutViewModel.EnabledMarketAndRegion()&&n.RuntimeConfig.QfMode==1){if(t=_ge("rewardsBadgeButton"),!this._flyout){if(this._flyout=this._page.createFlyout("RewardsMain"),!this._flyout)return;this._flyout.addMessage(n.Host.getLocString("RewardsEducationMainNewUserText")).button(n.Host.getLocString("RewardsEducationMainButtonMessage"),function(n,t){i.getDataModel().click(n,t)},0,"&#xE970").icon("Rewards").setClass("miniflyout").setSticky().isLinkTextButton(!0).target(t,"Left").showButton(!0)}this._flyout.target(t,"Left").show()}},l.prototype.isFeatureEnabled=function(){return n.contains(n.config.rewardsLanguageEnabled||[],n.uiLanguageCache.toLowerCase())},l.prototype.isCounterFactualLoggingEnabled=function(){return n.contains(n.config.rewardsCounterFactualLoggingLanguageEnabled||[],n.uiLanguageCache.toLowerCase())},l.prototype.handleNewAccountAvailable=function(n,t){t=t&&__spreadArray(__spreadArray([],t,!0),["MSFTRewardsViewsModel::handleNewAccountAvailable"],!1);var i=this._msaAccount;i!=n&&this._currentConversationId&&(this._msaAccount=n,this._msaAccount?i&&this._msaAccount.accountId==i.accountId||(this.clearCurrentBadge(),this.refreshBalance(null,t)):this.clearCurrentBadge())},l.prototype.clearCurrentBadge=function(){var n=this._balance.isSet();this.clear();n&&this.fireRewardsBadgeUpdated()},l.prototype.clear=function(){this._rewardsEnabled=!1;this._userIsRewardsMember=!0;this._userIsGiving=!1;this._fetchInProgress=!1;this._balance=new f;this._retryAttempted=0},l.prototype.refreshBalance=function(t,i){var u=this;if(i=i&&__spreadArray(__spreadArray([],i,!0),["MSFTRewardsViewsModel::refreshBalance"],!1),!this._fetchInProgress&&(!this._currentConversationId||this._userIsRewardsMember)){var s=this._currentConversationId,f=function(){return s==u._currentConversationId},o=function(t){e.getBalanceAsyncRpsToken(t,function(t){u._fetchInProgress=!1;f()&&(t.IsRewardsUser||n.config.rewardsAnidAccrualEnabled)&&(u._rewardsEnabled=!0,u._userIsRewardsMember=t.IsRewardsUser,t.IsRewardsUser?(u._userIsGiving=t.IsGiveUser,u.setNewBalance(t.Balance)):(u._userIsGiving=!1,u.setNewBalance(r.getBalance(u._msaAccount)),n.config.enableEduFlyoutRewardsSystem&&u.initializeEducationExperience()))},function(n){u._fetchInProgress=!1;f()&&u.handleError(t,n)})};this._fetchInProgress=!0;t?o(t):this._accessTokenManager.getAccount(0,n.getBingResourceOrScope(0),!1,!0,function(t){var r=t&&t.Token;r?o(r):(n.logAuthRelatedInfo("getAccountOnFailure","authenticate failed for MSA account.\nCallStack: ".concat(i===null||i===void 0?void 0:i.join(" -> "))),u._fetchInProgress=!1)},undefined,i)}},l.prototype.handleError=function(n,t){t&&t.Retryable&&this._retryAttempted<h&&(++this._retryAttempted,this.refreshBalance(n))},l.prototype.shouldShowRewardsFlyout=function(){var t=n.config.enableEduFlyoutRewardsSystem&&!this._userIsRewardsMember&&n.RewardsFlyoutViewModel.EnabledMarketAndRegion()&&n.RuntimeConfig.QfMode==1,i=n.RuntimeConfig.QfMode===0||n.RuntimeConfig.QfMode===4||n.RuntimeConfig.QfMode===11;return t||n.config.rewFly&&!i&&n.RewardsFlyoutViewModel.EnabledMarketAndRegion()&&(n.config.nonMemberRewFly||this._userIsRewardsMember)},l.prototype.hide=function(){n.RewardsFlyoutViewModel.hideRewardsFlyout()},l.prototype.getDataModel=function(){var r=this,u,f,e;if(!this._balance.isSet())return null;u=this._balance.getValue();f=this._userIsRewardsMember?this._userIsGiving?"RWBG":"RWBD":"RWBN";e=this.shouldShowRewardsFlyout()?function(){r._flyout&&r._flyout.dismiss();n.RewardsFlyoutViewModel.toggleRewardsFlyout(function(){return t.instrumentFlyoutClick()},function(n,i){return t.instrumentClickOnBadge(f,n,i)});r.shouldShowBadgeNotification()&&r.onBadgeNotificationShown()}:function(i,e){n.config.rewFly&&!n.RewardsFlyoutViewModel.EnabledMarketAndRegion()&&t.instrumentRewardsFlyoutMarketBlock();t.instrumentClickOnBadge(f,i,e);var o=r._userIsRewardsMember?a:v(u);n.Host.launchUri(o)};var s=""+u,h=this._userIsRewardsMember?1:u/i,o=t.instrumentBadge(f);return o.setProperty("Balance",s),{counterFactualLoggingEnabled:this.isCounterFactualLoggingEnabled(),balance:u,userIsRewardsMember:this._userIsRewardsMember,userIsGiving:this._userIsGiving,click:e,instItem:o,badgeFillupPercentage:h,showNotification:this.shouldShowBadgeNotification()}},l.prototype.fireRewardsBadgeUpdated=function(){this._rewardsBadgeUpdatedHandlers.forEach(function(n){return n()})},l.prototype.isRewardsEnabled=function(){return this.isCounterFactualLoggingEnabled()?!1:this._rewardsEnabled},l.prototype.notifyPointsRewarded=function(n){var t="notifyPointsRewarded";if(!this.isRewardsEnabled()){SharedLogHelper.LogError(t,null,new Error("Rewards not enabled"));return}if(!this._userIsRewardsMember)if(n<=0)n=this._balance.getValue()+c;else{SharedLogHelper.LogError(t,""+n,new Error("Invalid non rewards member new balance"));return}if(n<0){SharedLogHelper.LogError(t,""+n,new Error("Invalid rewards new balance"));return}this.setNewBalance(n)},l.prototype.setNewBalance=function(n){this._userIsRewardsMember||(n>i&&(n=i),r.setNewBalance(this._msaAccount,n));this._balance.getValue()!=n&&(this._balance.setValue(n),this.fireRewardsBadgeUpdated())},l.prototype.bindRewardsBadgeUpdated=function(n,t){this._rewardsBadgeUpdatedHandlers.push(n);t&&this._balance.isSet()&&n()},l}(),f,e,r,t;n.MicrosoftRewardsViewModel=y;f=function(){function n(){}return n.prototype.getValue=function(){return this._value},n.prototype.setValue=function(n){this._value=typeof n=="number"?n:undefined},n.prototype.isSet=function(){return typeof this._value=="number"},n}(),function(t){function i(n,t,i){var r,u;n?n.RewardsUser?(r=n.Balance&&n.Balance.Available,typeof r=="number"?(u=n.UserProfileAttributes&&n.UserProfileAttributes.give_user&&n.UserProfileAttributes.give_user.toLowerCase()=="true",t({IsRewardsUser:!0,Balance:r,IsGiveUser:u})):i(n.ErrorDetail)):n.ErrorDetail&&n.ErrorDetail.ErrorCode===5003?t({IsRewardsUser:!1}):i(n.ErrorDetail):i(null)}function r(t,r,f){var e={};e["X-Search-RPSToken"]=t;n.fetchUrlJson(l,e,u(),function(n){return i(n,r,f)})}function u(n){var t={PartnerId:"WSB",Channel:"WSB"};return n&&(t.UserId=n),JSON.stringify(t)}t.getBalanceAsyncRpsToken=r}(e||(e={})),function(t){function f(){}function r(n){return"RewardsPoints_"+n.accountUserName}function u(t){var e=r(t),u=n.LightweightStorage.getItem(e),f=u?+u:0;return f>i?i:f}function e(t,f){if(f>i&&(f=i),u(t)!=f){var e=r(t);return f?n.LightweightStorage.setItem(e,""+f):n.LightweightStorage.removeItem(e),!0}return!1}t.init=f;t.getBalance=u;t.setNewBalance=e}(r||(r={})),function(t){function e(){}function o(){i=null;r=-1}function u(t){return i||(i=n.InstrumentedItem.getNonSuggestionInstrumentedItem(t,n.SyntheticQSCodesMaps.KValues,1)),i}function f(t){var i=n.SequenceNumberManager.getSequenceNumber(),f=u(t);return r<i&&(n.InstrumentationHelper.instrumentSyntheticInstrumentedItem(i,t,f),r=i),f}function s(t,i,e){var o=n.SequenceNumberManager.getSequenceNumber();r<o&&f(t);n.InstrumentationHelper.instrumentItemClick(i,u(t),o,null,e,null)}function h(){var t=n.SequenceNumberManager.getSequenceNumber();n.InstrumentationHelper.logClientInstEvent("Select","RewardsFlyoutOpen",t)}function c(){var t=n.SequenceNumberManager.getSequenceNumber(),i={revIp:n.revIpRegionCache,language:n.getCurrentLanguage()};n.InstrumentationHelper.logClientInstEvent("Select","RewardsFlyoutMarketBlock",t,i)}var i,r=-1;t.init=e;t.onDismiss=o;t.instrumentBadge=f;t.instrumentClickOnBadge=s;t.instrumentFlyoutClick=h;t.instrumentRewardsFlyoutMarketBlock=c}(t||(t={}))})(WSB||(WSB={}))