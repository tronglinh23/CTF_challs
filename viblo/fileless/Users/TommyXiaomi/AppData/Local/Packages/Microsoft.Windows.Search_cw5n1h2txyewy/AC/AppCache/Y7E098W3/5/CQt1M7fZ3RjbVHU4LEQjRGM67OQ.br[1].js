var __extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),__awaiter,__generator,__spreadArray,WSB;(function(n){function e(t){return(t==="SSUE"||t==="SREE")&&n.isDocSourceEnabledInQws(t)}function p(n,t){var i,r;switch(t){case"SSUE":return((i=n===null||n===void 0?void 0:n.Groups)===null||i===void 0?void 0:i.length)>0;case"SREE":return((r=n===null||n===void 0?void 0:n.EntitySets)===null||r===void 0?void 0:r.length)>0;default:return!1}}var i="NT",b="NF",k="TO",o="SubstrateSearchService",d="https://outlook.office365.com/autodiscover/autodiscover.json/v1.0/{0}?Protocol={1}",r="AutoDiscoveryKey",w;n.ZqSuggestionsStorageKey="3SZqSuggestionsKey";var s="gwsflt.",g="textdecorations",h="scenario",c="setflight",nt="debug",l="entitytypes",tt="1",it="scopes",rt="people.directorysearch",ut="Authorization",u="Content-Type",ft="X-AnchorMailbox",et="X-Client-Language",ot="X-Client-LocalTime",a="Client-Request-Id",v="User-Agent",st="X-Debug-ExternalExp",ht="X-Client-Flights",f="application/json",ct="WSBScopeZQ15",lt="WSBScopeZQ20",at=15,vt=6048e5,yt=n.MinuteToMs,pt=2e3,t,y=!1,wt="https://substrate.office.com{0}/api/v1/",bt="https://substrate.office365.us{0}/api/v1/";n.qws3SDocsEnabled=e;w=function(w){function kt(i,u,f,e){var o=this,l,a,h,p,v,c;return o=w.call(this,e||kt.getDataSource(u,f))||this,o._accessTokenManager=i,o._authType=u,o._providerType=f,o._autoDiscoveryData={stem:"/search",timestamp:-1},y||(y=!0,h=[],p=function(n){return n.split(",").filter(function(n){return n.toLocaleLowerCase().startsWith(s)}).map(function(n){return n.substr(s.length)})},n.TestHookUrlParameters&&h.push.apply(h,((l=n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters["3sflights"])!==null&&l!==void 0?l:"").split(",")),t=h.join(","),ThresholdUtilities.getCortanaHeaders(function(n){var i,r;n&&(i=n["X-BM-ClientFeatures"],i&&(r=p(i),r.length>0&&(h.push.apply(h,r),t=h.join(","))))})),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.clearAutoDCache)&&n.LightweightStorage.removeItem(r),v=n.LightweightStorage.getItem(r),v&&(c=n.safeExecute(function(){return JSON.parse(v)},"parseAutoDiscovery",null),c&&!c.errorState?o._autoDiscoveryData=c:n.LightweightStorage.removeItem(r)),n.config.msbCleanQwsDocsCache&&n.LightweightStorage.removeItem(n.ZqSuggestionsStorageKey),n.Host.bindAccountChanged(function(){n.LightweightStorage.removeItem(n.ZqSuggestionsStorageKey)}),n.Host.bindAccessTokenAvailable(function(t){var u,f,i;if(t==o._authType){if(o._providerType==0){if(u=n.getCurrentTime(),a&&(f=u-a,f<yt))return;a=u;o.fetchUrl(o.getSubstrateInitUrl(),null,"",function(){},null,function(){return!0})}i=n.getCurrentDate();i.setDate(i.getDate()-1);o._autoDiscoveryData.timestamp<i.getTime()&&o.getStem()(t,function(t){t.timestamp=n.getCurrentTime();o._autoDiscoveryData=t;t.errorState||n.LightweightStorage.setItem(r,JSON.stringify(t))})}}),o}return __extends(kt,w),kt.prototype.getName=function(){return"SubstrateDataProvider "+this._dataSource},kt.prototype.createUrl=function(t){if(this._providerType==1||this._providerType==2)return this.getBaseUrl();if(this._providerType==0){if(t.scope==n.Scope.Documents){var i=n.getEffectiveQuery(t);if(i!=t.queryToFetch)return this.getBaseUrl()+n.encodeQueryParameter(i.toLocaleLowerCase())}return w.prototype.createUrl.call(this,t)}throw new Error("Not implemented");},kt.prototype.getBaseUrl=function(){if(this._providerType==0)return this.getSubstrateSuggestionsUrl();if(this._providerType==1)return this.getSubstrateSearchUrl();if(this._providerType==2)return this.getSubstrateRecomendationsUrl();throw new Error("Not implemented");},kt.prototype.getClientFlights=function(){return this._providerType==2?"recEnableDuplicateMeetingAttachments":null},kt.getDataSource=function(n,t){if(t==0)return n==1?"SSUE":"SSUC";if(t==1)return n==1?"SSEE":"SSEC";if(t==2&&n==1)return"SREE";throw new Error("Not implemented");},kt.prototype.getPostBody=function(t){var r,u,f,i;if(this._providerType==1){r=void 0;u=n.getEffectiveScope(t);switch(u){case n.Scope.Emails:f=[{Score:{SortDirection:"Desc",Count:n.config.maxNumberOfEmailsInTopResult}},{Time:{SortDirection:"Desc"}}];r=this.buildPostBodyForQueryEndpoint(t,"Message",["Exchange"],f);break;case n.Scope.Documents:case n.Scope.All:i=void 0;switch(n.config.queryProvenances){case 0:i=["SharePoint"];break;case 1:i=["OneDriveBusiness"];break;case 2:i=["SharePoint","OneDriveBusiness"];break;default:throw new Error("Unexpected query provenances: "+n.config.queryProvenances);}r=this.buildPostBodyForQueryEndpoint(t,"Documents",i,[{Score:"Desc"}]);break;default:throw new Error("Unsupported scope "+t.scope);}return JSON.stringify(r)}return this._providerType==2?JSON.stringify(this.buildPostBodyForRecommendationsEndpoint(t)):""},kt.prototype.buildPostBodyForQueryEndpoint=function(n,t,i,r){return this.buildPostBody(t,"WindowsSearchBoxL2",undefined,n.queryToFetch,i,r,"ProvenanceOptimized","Forward")},kt.prototype.buildPostBodyForRecommendationsEndpoint=function(t){if(n.config.use3sRecRecommendedFiles&&t.isSearchHomeZI)return this.buildPostBody("Document","WSB.RecommendedFiles");var i=new Date(n.getCurrentTime()).toISOString(),r=new Date(n.getCurrentTime()+at*n.MinuteToMs).toISOString(),u=[{EntityType:"Event",StartDateTime:i,EndDateTime:r,Top:2},{EntityType:"Document",Top:10}];return this.buildPostBody("Document","WSB.MeetingRelatedEntities",u)},kt.prototype.buildPostBody=function(t,i,r,u,f,e,o,s){switch(i){case"WSB.RecommendedFiles":return{EntityRequests:[{}],Cvid:n.Host.getConversationId(),Scenario:{Name:i}};default:return{EntityRequests:[{Query:u?{QueryString:u}:undefined,QueryParameters:r,EntityType:t,Provenances:f,Sort:e,PropertySet:o}],Cvid:n.Host.getConversationId(),TextDecorations:s,Scenario:{Name:i}}}},kt.prototype.getStem=function(){var t=this;return n.Async.safeChainWithGlobalCaching("getStem",function(r){return ThresholdUtilities.createPromise(function(e){t._accessTokenManager.getAccount(r,n.getSubstrateResourceOrScope(r),!1,!0,function(r){var h,s,c;r&&r.UserName?(h=n.formatString(d,[r.UserName,o]),s={},s[u]=f,s[a]=n.Host.getConversationId(),s[v]=navigator.userAgent,c=function(t,i,r){var u,f,s;if(r){e({stem:"",errorState:r});return}if(u=i,!u){e({stem:""});return}if(!u.Url){e({stem:"",errorState:"NAU"});return}if(u.Protocol!=o){e({stem:"",errorState:"NAP"});return}if(f=n.tryParseUrl(u.Url,!0),s=f?f.path:null,!s){e({stem:"",errorState:"NAS"});return}e({stem:s})},w.prototype.fetchUrl.call(t,h,s,"",c,null,function(){return!0})):e({stem:"",errorState:i})},undefined,n.Host.isAuthInvestigation()?["SubstrateDataProvider::getStem"]:undefined)})},function(){return"autoDiscovery"})},kt.prototype.getAllAccountTokens=function(t,r){var u=n.Host.isAuthInvestigation()?["SubstrateDataProvider::getAllAccountTokens"]:undefined,f;t||n.RuntimeConfig.QfMode!=5?this._accessTokenManager.getAccount(this._authType,n.getSubstrateResourceOrScope(this._authType),!1,!0,function(n){n&&n.Token?r([n]):r(null,i)},undefined,u):(f=SearchAppWrapper.CortanaApp.fileExplorerSuggestionPage.currentSyncRootAccount,f?this._accessTokenManager.getAccountByUserName(!0,1,f,!1,!0,function(n){n&&n.Token?r([n]):r(null,i)},u):n.isFileExplorerCurrentPathThisPcOrQuickAccess?this._accessTokenManager.getAllSyncingAccounts(!0,1,!1,!0,function(n){n.length>0?r(n):r(null,i)},u):(SharedLogHelper.LogError("fetchUrl",null,new Error("Substrate provider called without currentSyncRootAccount")),r(null,b)))},kt.prototype.fetchUrl=function(t,i,r,u,f,e){var s=this,c,o,h;if(!this._autoDiscoveryData.stem){u(this._dataSource,null,this._autoDiscoveryData.errorState,null,!0);return}c=t==this.getSubstrateInitUrl();t=n.formatString(t,[this._autoDiscoveryData.stem]);i||(i={});o={numOfPendingResponses:0};n.config.enableFetchStartLogging&&n.InstrumentationHelper.instrumentFetchProviderBegin(n.SequenceNumberManager.getSequenceNumber(),"SSDPU:"+this._dataSource);h=function(h){var c=Object.assign({},i);c[ut]="Bearer "+h.Token;s._authType==1&&(n.SubstrateTenantName!==h.TenantName&&h.TenantName&&(n.SubstrateTenantName=h.TenantName),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.tenantName)&&(n.SubstrateTenantName=n.TestHookUrlParameters.tenantName));c[ft]=h.RoutingHint;w.prototype.fetchUrl.call(s,t,c,r,function(n,t,i,r,f){--o.numOfPendingResponses;u(n,t,i,r,f,o.numOfPendingResponses!=0)},f,e)};this.getAllAccountTokens(c,function(n,t){t?u(s._dataSource,null,t,null,null,!1):n?(o.numOfPendingResponses=n.length,n.forEach(function(n){return h(n)})):(o.numOfPendingResponses=1,h(null))})},kt.prototype.fetch=function(i,r,o,s,h,c){var g=this,ft=n.isDataSourceEnabled(this._dataSource,i),nt=!1,tt,rt,y,it,d,b,ut;ft&&(n.config.enableFetchStartLogging&&n.InstrumentationHelper.instrumentFetchProviderBegin(o,"SSDP:"+this._dataSource),i.isSearchHomeZI&&e(this._dataSource)&&n.isMsbQwsDocsCacheEnabled(i)&&!(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbSHNoRecDocs)&&(tt=this.getQwsDocsCachedResults(),tt.results?(rt=!n.config.msbQwsDocsNoRefreshAfterCachedResults,r(this._dataSource,tt.results,null,undefined,undefined,rt),nt=!0,typeof n.incrementQwsAggregateSuccessRate=="function"&&n.incrementQwsAggregateSuccessRate(!0)):_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search document cache error",tt.cacheState)),y={},y[et]=n.uiLanguageCache,y[ot]=n.getDateWithTimezone(),y[v]=navigator.userAgent,typeof _CachedFlights!="undefined"&&_CachedFlights.sort&&(y[st]=_CachedFlights.sort().join(",")),y[a]=n.InstrumentationHelper.getImpressionGuid(o),y[u]=f,it=this.buildParams(c,i.scope,!i.queryToFetch),this._providerType!=0||it[l])&&(d=this.getClientFlights(),t&&(d=d?d+","+t:t),d&&(y[ht]=d),b=null,i.isSearchHomeZI&&(b=n.safeSetTimeout(function(){sb_ct(b);b=null;n.config.msbQwsDocsNoRefreshAfterCachedResults&&nt||r(g._dataSource,null,k)},pt,"SubstrateDataProvider Fetch")),ut=function(t,u,f,o,s,h){var a=parseInt(f),c,l,v,y;if((a==403||a==401)&&n.safeSetTimeout(function(){return g._accessTokenManager.getAccount(g._authType,n.getSubstrateResourceOrScope(g._authType),!0,!0,function(){},undefined,n.Host.isAuthInvestigation()?["SubstrateDataProvider::onResponseReceived"]:undefined)},0,"SubstrateDataProvider onResponseReceived"),c=h,i.isSearchHomeZI){if(n.isMsbQwsDocsCacheEnabled(i)&&!n.config.msbQwsDocsNoRefreshAfterCachedResults&&(c=!1),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbSHNoRecDocs)&&(u=null),e(t)&&(l=p(u,t),v=l&&b!=null,nt||typeof n.incrementQwsAggregateSuccessRate!="function"||n.incrementQwsAggregateSuccessRate(v),l&&n.isMsbQwsDocsCacheEnabled(i)&&(y={dataSource:t,results:u,lastUpdatedTime:n.getCurrentTime()},n.LightweightStorage.setItem(n.ZqSuggestionsStorageKey,JSON.stringify(y)))),b==null)return;if(sb_ct(b),b=null,n.config.msbQwsDocsNoRefreshAfterCachedResults&&nt)return}r(t,u,f,o,s,c)},w.prototype.fetch.call(this,i,ut,o,s,h,it,y))},kt.prototype.getSubstrateBaseUrl=function(){return _w.BingAtWork&&_w.BingAtWork.wsb&&_w.BingAtWork.wsb.gccRegion===2?bt:wt},kt.prototype.getSubstrateEventsUrl=function(){return this.getSubstrateBaseUrl()+"events"},kt.prototype.getSubstrateInitUrl=function(){return this.getSubstrateBaseUrl()+"init"},kt.prototype.getSubstrateSuggestionsUrl=function(){return this.getSubstrateBaseUrl()+"suggestions?query="},kt.prototype.getSubstrateSearchUrl=function(){return this.getSubstrateBaseUrl()+"query"},kt.prototype.getSubstrateRecomendationsUrl=function(){return this.getSubstrateBaseUrl()+"recommendations"},kt.prototype.getQwsDocsCachedResults=function(){var t={results:null,cacheState:n.CacheState.Empty},i,r=n.LightweightStorage.getItem(n.ZqSuggestionsStorageKey),f;if(!r)return t;try{i=JSON.parse(r)}catch(u){f="[MSB.Error]  QWS docs cache is broken.\n                            cacheString=".concat(r,",\n                            error.message=").concat(u===null||u===void 0?void 0:u.message);t.cacheState=n.CacheState.Error;n.LightweightStorage.removeItem(n.ZqSuggestionsStorageKey)}return i&&i.dataSource==this._dataSource&&(n.getCurrentTime()-i.lastUpdatedTime<vt?p(i.results,this._dataSource)?(t.results=i.results,t.cacheState=n.CacheState.ValidResults):t.cacheState=n.CacheState.NoResults:(n.LightweightStorage.removeItem(n.ZqSuggestionsStorageKey),t.cacheState=n.CacheState.Expired)),t},kt.prototype.buildParams=function(t,i,r){var f,u={},e;return this._providerType==0&&(u[n.Service.QueryParams.ConversationId]=t[n.Service.QueryParams.ConversationId],u[g]=tt,this._authType!=1||r||i!=n.Scope.People?i!=n.Scope.All&&(u[h]=it):u[h]=rt,u[l]=this.getEntityTypes(i,r),i==n.Scope.Documents&&r&&n.config.msbEnableDocumentZQ&&(u[c]=n.config.msbDocumentZQResultsCount==20?lt:ct)),n.TestHookUrlParameters&&(e=(f=n.TestHookUrlParameters["3sflights"])!==null&&f!==void 0?f:"",e&&(u[c]=e),n.TestHookUrlParameters["3sdebug"]&&(u[nt]="1")),u},kt.prototype.getEntityTypes=function(t,i){var r,u,f;switch(t){case n.Scope.Documents:r="Documents";break;case n.Scope.People:r="People";break;case n.Scope.All:u=[];this._authType==1&&u.push("Documents");i||n.RuntimeConfig.QfMode==5||(f=typeof n.isTenantMsbEnabled=="function"&&n.isTenantMsbEnabled(),f||u.push("People"));r=u.join(",");break;default:throw new Error("Unsupported scope "+t);}return r},kt.prototype.instrumentClick=function(t,i){if(t&&i){var e=[{Key:t,Value:[{Name:"entityclicked",Attributes:[{Key:"id",Value:i},{Key:"localtime",Value:n.getDateWithTimezone()}]}]}],r={};r[u]=f;this.fetchUrl(this.getSubstrateEventsUrl(),r,JSON.stringify(e),function(){},null,function(){return!0})}},kt}(n.CortanaJsonDataProvider);n.SubstrateDataProvider=w})(WSB||(WSB={})),function(n){function y(t,i,r){var u=n.OfficeTypeExtensionConfigs[t];u?n.LocalDataProvider.getApps(u.appIds,function(t){var f=!n.Map.isEmpty(t);f?i(u.uri):r()}):r()}function h(t,i,r){var u=t?new URL(t):null;!u||u.pathname&&u.pathname.indexOf(":")!=-1?n.Host.launchUri(i):y(r,function(i){return n.Host.launchUri(i+t)},function(){return n.Host.launchUri(i)})}function p(t,i,r){n.setExtraVerbs(t,function(){var u=[];return u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_OpenInBrowser],displayName:n.Host.getLocString("OpenInBrowser"),executeSync:function(){return n.Host.launchUri(i)},icon:{type:1,content:"&#xE774"}}),t.locationUrl&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_OpenFileLocationInBrowser],displayName:n.Host.getLocString("OpenFileLocationIn",r),executeSync:function(){return n.Host.launchUri(t.locationUrl)},icon:{type:2,content:"&#xE838"}}),t.url&&SearchAppWrapper.CortanaApp.copyToClipboard&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_CopyFullPath],displayName:n.Host.getLocString("CopyFullPath"),executeSync:function(){return SearchAppWrapper.CortanaApp.copyToClipboard(t.url,"")},icon:{type:1,content:"&#xE8C8"}}),u},!1)}function c(t,i,r,u,e,o,s,c,l,a,v,y,w,b,k,d,g,nt,tt,it,rt){var ct=n.ScopeConfig[n.Scope.Documents].icon,et,ut,lt,ot,at,ft,vt,yt,st,ht;return u||(u=r+"?web=1"),o=HitHighlightingParser.removeMarkers(o),s&&(s=s.toLocaleLowerCase()),et="FL",ut=n.createSuggestion(i,e,s&&n.getIconForTypeAsync(ct,"."+s),ct,et,o,n.InstrumentedItem.createInstrumentedItem(d,et),8,d,!0),ut.instrumentPingBack=k,lt=n.isZeroInputAllScope(i),ut.click=function(){lt&&_w.bfbWsbTel&&bfbWsbTel.logSearchHomeClick("Documents");h(r,u,s)},ut.extensionLC="."+s,ut.lastModifiedDate=n.toDate(l),ut.lastModifiedBy=a,ut.lastAccessDate=n.toDate(v),ut.author=y,ut.matchedOnlyOnAuthor=w,ut.matchedOnlyOnContent=b,ut.textContentIfMatched=tt,ut.siteTitle=rt,ut.url=r,ot=c=="OneDriveBusiness"?3:c=="SharePoint"?4:undefined,at=n.nicerCloudFilesEnabled(i,ut),n.setDocumentLocationProperties(ut,o,c,at),w?ut.match=n.createMatch(n.MatchType.Author,y):e.includes(HitHighlightingParser.startMarker)||(ut.match=n.tryGetLocationMatch(ut.path,g)||it),i.isSearchHomeZI||(ut.sourceForGroup=ot),ft=new Date(n.getCurrentDate().toUTCString()),t?(ut.meeting=t,ut.features.push("MeetingRecommendation"),vt=new Date(t.Start),yt=Math.floor((vt.getTime()-ft.getTime())/n.MinuteToMs),ut.explanation=yt>0?n.Host.getLocString("DocumentRelatedToMeeting",HitHighlightingParser.addMarkers(t.Subject.trim()),f(ft,new Date(t.Start))):n.Host.getLocString("DocumentRelatedToMeetingNow",HitHighlightingParser.addMarkers(t.Subject.trim()))):i.isSearchHomeZI&&(st=ut.lastModifiedBy&&ut.lastModifiedDate&&(!ut.lastAccessDate||ut.lastModifiedDate>=ut.lastAccessDate)?f(ut.lastModifiedDate,ft):null,st?ut.explanation=n.Host.getLocString("DocumentLastModifiedBy",HitHighlightingParser.addMarkers(ut.lastModifiedBy),st):ut.lastAccessDate&&(ht=f(ut.lastAccessDate,ft),ht&&(ut.explanation=n.Host.getLocString("DocumentLastAccessed",HitHighlightingParser.addMarkers(n.Host.getLocString("YouLabel")),ht)))),n.setFileTemplate(i,g,nt,ut),p(ut,u,n.getGroupSourceDisplayName(ot)),ut.reactKey=et+e+y+r,ut.classNames.push("fbig"),ut}function f(t,i){var r,u,f,e;return!t||!i?null:(r=i.getTime()-t.getTime(),r<0)?null:(u=r/n.DayToMs,u>=1)?n.Host.getLocString("TimeDayShorthandPattern",Math.floor(u).toString()):(f=r/n.HourToMs,f>=1)?n.Host.getLocString("TimeHourShorthandPattern",Math.floor(f).toString()):(e=r/n.MinuteToMs,n.Host.getLocString("TimeMinuteShorthandPattern",Math.floor(e).toString()))}var r={Word:{appIds:["Microsoft.Office.WINWORD.EXE.15","Microsoft.Office.WINWORD.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\WINWORD.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\WINWORD.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\WINWORD.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\WINWORD.EXE","Microsoft.Office.Word_8wekyb3d8bbwe!microsoft.word"],uri:"ms-word:ofe|u|"},Excel:{appIds:["Microsoft.Office.EXCEL.EXE.15","Microsoft.Office.EXCEL.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\EXCEL.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\EXCEL.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\EXCEL.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\EXCEL.EXE","Microsoft.Office.Excel_8wekyb3d8bbwe!microsoft.excel"],uri:"ms-excel:ofe|u|"},PowerPoint:{appIds:["Microsoft.Office.POWERPNT.EXE.15","Microsoft.Office.POWERPNT.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\POWERPNT.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\POWERPNT.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\POWERPNT.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\POWERPNT.EXE","Microsoft.Office.PowerPoint_8wekyb3d8bbwe!microsoft.pptim"],uri:"ms-powerpoint:ofe|u|"},Visio:{appIds:["{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\VISIO.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office14\\VISIO.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\VISIO.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\VISIO.EXE","Microsoft.Office.VISIO.EXE.15"],uri:"ms-visio:ofe|u|"},OneNote:{appIds:["Microsoft.Office.ONENOTE.EXE.15","Microsoft.Office.ONENOTE.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\ONENOTE.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\ONENOTE.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\ONENOTE.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\ONENOTE.EXE","Microsoft.Office.OneNote_8wekyb3d8bbwe!microsoft.onenoteim"],uri:"onenote:"}},e="sip:",l=["Microsoft.Office.lync.exe.15","{6D809377-6AF0-444B-8957-A3773F02200E}Microsoft OfficeOffice15lync.exe","{6D809377-6AF0-444B-8957-A3773F02200E}Microsoft OfficeOffice16lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}Microsoft OfficeOffice15lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}Microsoft OfficeOffice16lync.exe","{6D809377-6AF0-444B-8957-A3773F02200E}MSOfficeOffice15lync.exe","{6D809377-6AF0-444B-8957-A3773F02200E}MSOfficeOffice16lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}MSOfficeOffice15lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}MSOfficeOffice16lync.exe","Microsoft.Office.Desktop_8wekyb3d8bbwe!Lync","com.squirrel.Teams.Teams",],t=r.Word,i=r.Excel,u=r.PowerPoint,o=r.Visio,a="https://gcchigh.loki.office365.us/api/v1/configuration/cortana",v="https://loki.delve.office.com/api/v1/configuration/cortana",s;n.OfficeTypeExtensionConfigs={doc:t,dot:t,dotx:t,docx:t,docm:t,docb:t,xls:i,xlm:i,xlsx:i,xlsm:i,xlsb:i,xltx:i,ppt:u,pps:u,pptx:u,pptm:u,vsd:o,vsdx:o,one:r.OneNote};s=function(){function t(n,t,i,r){this._substrateSuggestionsDataProvider=n;this._accessTokenManager=t;this._substrateProfilePictureProvider=i;this._authType=r;this._mailboxLocations={}}return t.prototype.parse=function(t,i,r,u,f,e){var s=this,o;if(n.isDataSourceEnabled(r,t)){if(o=[],!u||!u.Groups){e(r,o,null);return}var h=r=="SSUE"?n.config.aadPeopleCardHandoffEnabled&&!(typeof n.isTenantMsbEnabled=="function"&&n.isTenantMsbEnabled()):n.config.msaPeopleCardHandoffEnabled,p=n.getEffectiveQuery(t),a=n.isL2(t),v=n.config.msbQws3sSugHideTimestamp&&t.isSearchHomeZI,y=function(l){for(var y,it,rt,b,nt,ut,ft,et,d,tt,k,w=0,g=u.Groups;w<g.length;w++)if(y=g[w],y.Suggestions&&y.Suggestions.length)switch(y.Type){case"Documents":for(it=y.Suggestions,rt=function(r){var f=n.safeExecute(function(){return c(undefined,t,r.AccessUrl||r.Url,null,r.Text,r.FileName,r.FileExtension,r.FileSourceType=="OneDriveForBusiness"?"OneDriveBusiness":"SharePoint",v?null:r.DateModified?r.DateModified+"Z":null,r.ModifiedByDisplayName,v?null:r.DateAccessed?r.DateAccessed+"Z":null,r.CreatedBy||HitHighlightingParser.removeMarkers(r.Author),r.PropertyHits&&r.PropertyHits[0]=="Author",!1,function(){return s._substrateSuggestionsDataProvider.instrumentClick(u.Instrumentation.TraceId,r.ReferenceId)},i,p,a,"",null,r.SourceTitle)},"buildSubstrateDocumentSuggestion");if(f&&n.isValidSuggestion(f,"SubstrateDocumentsSuggestionsParser")&&(o.push(f),t.isSearchHomeZI&&typeof n.enableQws=="function"&&n.enableQws()&&n.isMsbEnterprise()&&typeof n.isGccHighTenant=="function"&&!n.isGccHighTenant()&&o.length>=(n.config.msbEnableDocumentZQ&&t.scope==n.Scope.Documents?n.config.msbDocumentZQResultsCount:n.config.ziRecommendedDocsResultsParseCount)))return"break"},b=0,nt=it;b<nt.length;b++)if(k=nt[b],ut=rt(k),ut==="break")break;t.isSearchHomeZI||n.decorateSuggestionsWithParentFolder(o);break;case"People":for(ft=y.Suggestions,et=function(f){var e=n.safeExecute(function(){return s.buildPersonSuggestion(h,f,i,u.Instrumentation.TraceId,a,r,t,l)},"buildPersonSuggestion");e&&n.isValidSuggestion(e,"SubstratePeopleSuggestionsParser")&&o.push(e)},d=0,tt=ft;d<tt.length;d++)k=tt[d],et(k);h&&n.safeExecute(function(){return s.prefetchPeopleCards(o.filter(function(n){return n.type=="PPL"}),i,f)},"prefetchPeopleCards");n.isL2(t)||s.decorateContactsWithSameDisplayName(o,t);break;default:SharedLogHelper.LogError("parseSubstrateResponse",y.Type,new Error("Unexpected group type"))}t.isSearchHomeZI&&t.scope===n.Scope.All&&typeof n.enableQws=="function"&&n.enableQws()&&(o===null||o===void 0?void 0:o.length)>0&&_w.bfbWsbTel&&bfbWsbTel.logSearchHomeImpression("Documents");e(r,o,null)};r=="SSUE"?n.LocalDataProvider.getApps(l,function(t){return y(!n.Map.isEmpty(t))}):y(!1)}},t.prototype.prefetchPeopleCards=function(t,i,r){t.length&&this.getPeopleCardTokenAndMailboxLocation(function(u){var o,f,e,s;u&&u.token&&u.location&&i==n.SequenceNumberManager.getSequenceNumber()&&r()&&(o=u.location+"api/v1/personacards/preparePersona",f=SearchAppWrapper.CortanaApp.createStringMap(),f.Authorization="Bearer "+u.token,f["X-ClientCorrelationId"]=n.InstrumentationHelper.getImpressionGuid(i),f["X-ClientType"]="6",e=SearchAppWrapper.CortanaApp.createStringMap(),e["Content-Type"]="application/json",s=JSON.stringify(t.map(function(n){return{Smtp:n.email,PersonaType:"User"}})),n.Async.safeChain("prefetchPeopleCards",function(){return SearchAppWrapper.CortanaApp.makeHttpRequestAsync(1,o,f,s,e)},function(n){if(n.statusCode!=200&&n.statusCode!=204){var t=new Error("Prefetch request failed with status code: "+n.statusCode);SharedLogHelper.LogError("prefetchPeopleCards",null,t)}}))})},t.prototype.buildPersonSuggestion=function(t,i,r,u,f,o,s,h){var w=this,g,l,nt,p,ft;if(!i.EmailAddresses||!i.EmailAddresses[0])return null;var et=i.PeopleType=="Group",tt=i.EmailAddresses[0],a=HitHighlightingParser.removeMarkers(tt),y,it;et?y={content:"&#xE716",type:2}:(y=this._substrateProfilePictureProvider.getPersonDefaultIcon(i.DisplayName),it=this._substrateProfilePictureProvider.getProfilePictureIcon(this._authType,a,y));var rt=o=="SSUE",b="PPL",c=n.createSuggestion(s,i.Text,it,y,b,i.DisplayName,n.InstrumentedItem.createInstrumentedItem(r,b),rt?8:12,r,!0),k=i.Id,d;rt&&(g=i.Id.split("@"),k=g[0],d=g[1]);c.email=a;c.emailHH=tt;c.uniqueName=a;l=i.ImAddress;l&&!l.startsWith(e)&&(l=l.includes(":")?undefined:e+l);l&&(c.imAddress=l,nt=l.substr(e.length),nt!=a&&(c.alternativeEmail=nt));p=k&&d&&!t;c.tooltip=this.getPersonTooltip(i.DisplayName,i.Department,i.JobTitle,i.OfficeLocation,i.CompanyName,a,c.alternativeEmail);c.instrumentPingBack=function(){return w._substrateSuggestionsDataProvider.instrumentClick(u,i.ReferenceId)};c.click=function(n){return w.onPersonSuggestionClick(t,p,a,c.query,r,n,k,d)};var ut=n.Host.getLocString("Email"),ot=function(){return n.Host.launchUri("mailto:"+a)},v={};return v[ut]=[{text:a,click:ot}],c.alternativeEmail&&(ft=function(){return n.Host.launchUri("mailto:"+c.alternativeEmail)},v[ut].push({text:c.alternativeEmail,click:ft})),i.OfficeLocation&&(v[n.Host.getLocString("Location")]=[{text:i.OfficeLocation}]),i.CompanyName&&(v[n.Host.getLocString("Company")]=[{text:i.CompanyName}]),c.previewMetadata=v,c.department=i.Department,this.setPersonTemplate(c,f,i.JobTitle,s),this.setPersonContextMenuItems(c,t||p,h),!n.RuntimeConfig.AlwaysWide&&(t||p)&&(c.calculateChildSuggestions=function(){return w.getPersonChildSuggestions(s,c,r,o,h)}),c.reactKey=b+i.PeopleType+i.DisplayName+i.Id,c},t.prototype.getPersonChildSuggestions=function(t,i,r,u,f){var e=[];e.push(this.getChildSuggestion(t,i,"CortanaAnnotation_Email","&#xE715","mailto:"+i.email,"PPLE",r));i.imAddress&&f&&e.push(this.getChildSuggestion(t,i,"SendInstantMessage","&#xE8BD",i.imAddress,"PPLM",r));i.childSuggestions=e;i.calculateChildSuggestions=null;n.InstrumentationHelper.instrumentDataSource(r,u,i.childSuggestions,null)},t.prototype.getChildSuggestion=function(t,i,r,u,f,e,o){var h=n.Host.getLocString(r),s=n.createSuggestion(t,h,null,{type:2,content:u},e,h,n.InstrumentedItem.createInstrumentedItem(o,e),i.handoffType,o,!1,null,null,!0);return s.parent=i,s.groupType=n.GroupType.Contact,s.click=function(){return n.Host.launchUri(f)},s.instrumentPingBack=i.instrumentPingBack,s.reactKey=e+h+f,s},t.prototype.getPeopleCardTokenAndMailboxLocation=function(t){var i=this;this._accessTokenManager.getAccount(this._authType,this._authType==1?"394866fc-eedb-4f01-8536-3ff84b16be2a":"LiveProfileCard.Access",!1,!0,function(r){var u,e,s,f,o;if(!r||!r.Token){t(null);return}if(u=r.Token,e=i._mailboxLocations[r.RoutingHint],e){t({token:u,location:e});return}s=SearchAppWrapper.CortanaApp.createStringMap();f=SearchAppWrapper.CortanaApp.createStringMap();f.Authorization="Bearer "+u;f["X-ClientType"]="6";o=v;_w.BingAtWork&&_w.BingAtWork.wsb&&_w.BingAtWork.wsb.gccRegion===2&&(o=a);n.Async.safeChain("lokiConfiguration",function(){return SearchAppWrapper.CortanaApp.makeHttpRequestAsync(0,o,f,"",s)},function(f){if(f.statusCode!==200){t(null);return}n.Async.safeChain("lokiConfigurationResponse",function(){return f.readAsStringAsync()},function(f){if(!f){t(null);return}var e=n.safeExecute(function(){return JSON.parse(f)},"parseLokiConfiguration");if(!e||!e.LokiUrl){t(null);return}i._mailboxLocations[r.RoutingHint]=e.LokiUrl;t({token:u,location:e.LokiUrl})},function(){return t(null)})},function(){return t(null)})},undefined,n.Host.isAuthInvestigation()?["SubstrateSuggParser::getPeopleCardTokenAndMailboxLocation"]:undefined)},t.prototype.getSharePointHost=function(n){for(var f,i,e,t,s,l,a,v=new DOMParser,u=0,h=n.value;u<h.length;u++)if(f=h[u],f.serviceElements)for(i=0,e=f.serviceElements;i<e.length;i++){var y=e[i],p=v.parseFromString(y,"text/xml"),r=p.getElementsByTagName("ServiceParameter"),o=void 0,c=!1;for(t=0;t<r.length;t++)if(s=r[t].getElementsByTagName("Name"),s[0].childNodes[0].nodeValue=="IsDefaultDataLocation"?(l=r[t].getElementsByTagName("Value"),l[0].childNodes[0].nodeValue=="True"&&(c=!0)):s[0].childNodes[0].nodeValue=="SPO_MySiteHost_AboutMeUrl"&&(a=r[t].getElementsByTagName("Value"),o=a[0].childNodes[0].nodeValue),c&&o)return o}return null},t.prototype.onPersonSuggestionClick=function(t,i,r,u,f,e,o,s){var c=this,h=function(){return n.Host.launchUri("mailto:"+r)},l=function(){var t=function(){return n.Host.launchUri(c._sharePointSiteHostUrl+"?aadObjectId="+o)};c._sharePointSiteHostUrl?t():c._accessTokenManager.getAccount(1,"https://graph.windows.net/",!1,!0,function(i){if(!i||!i.Token){h();return}var u=SearchAppWrapper.CortanaApp.createStringMap(),r=SearchAppWrapper.CortanaApp.createStringMap();r.Authorization="Bearer "+i.Token;n.Async.safeChain("getSharePointUrl",function(){return SearchAppWrapper.CortanaApp.makeHttpRequestAsync(0,"https://graph.windows.net/"+s+"/tenantDetails/"+s+"/serviceInfo?api-version=1.6-internal",r,"",u)},function(i){if(i.statusCode!==200){h();return}n.Async.safeChain("readSharePointUrlResponse",function(){return i.readAsStringAsync()},function(i){var r=i?n.safeExecute(function(){return JSON.parse(i)},"parseSharePointUrlResponse"):null;if(!r){h();return}c._sharePointSiteHostUrl=c.getSharePointHost(r);c._sharePointSiteHostUrl?t():h()},h)},h)},undefined,n.Host.isAuthInvestigation()?["SubstrateSuggParser::onPersonSuggestionClick"]:undefined)};t?this.getPeopleCardTokenAndMailboxLocation(function(t){if(f==n.SequenceNumberManager.getSequenceNumber())if(t&&t.token&&t.location){var o=t.location+"api/v1/personacard?clientType=Cortana&userSmtp="+r+"&ClientCorrelationId="+n.InstrumentationHelper.getImpressionGuid(f)+"&cts="+e+"&CultureInfoName="+n.uiLanguageCache;n.Host.launchWebContent(o,u,t.token)}else i?l():h()}):i?l():h()},t.prototype.setPersonContextMenuItems=function(t,i,r){n.setExtraVerbs(t,function(){var u=[],f=t.childSuggestions&&t.childSuggestions.some(function(n){return n.displayed});return f||(u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_SendEmail],displayName:n.Host.getLocString("CortanaAnnotation_Email"),executeSync:function(){return n.Host.launchUri("mailto:"+t.email)},isDefault:!i,icon:{content:"&#xE715",type:2}}),t.imAddress&&r&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_SendInstantMessage],displayName:n.Host.getLocString("SendInstantMessage"),executeSync:function(){return n.Host.launchUri(t.imAddress)},icon:{content:"&#xE8BD",type:2}})),SearchAppWrapper.CortanaApp.copyToClipboard&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_CopyPersonDetails],displayName:n.Host.getLocString("CopyDetails"),executeSync:function(){return SearchAppWrapper.CortanaApp.copyToClipboard(t.tooltip.replace(/\n/g,"\r\n"),"")},icon:{type:1,content:"&#xE8C8"}}),u},!0)},t.prototype.setPersonTemplate=function(t,i,r,u){var e=n.getEffectiveQuery(u),f;r?(t.jobTitle=r,t.primaryMetadata=r):t.text!=t.emailHH&&(t.primaryMetadata=t.emailHH);e&&(t.text.includes(HitHighlightingParser.startMarker)||(t.emailHH.includes(HitHighlightingParser.startMarker)?(t.template=1,t.primaryMetadata=t.emailHH):t.alternativeEmail&&(f=HitHighlightingParser.addMarkers(t.alternativeEmail,e),f.includes(HitHighlightingParser.startMarker)&&(t.template=1,t.primaryMetadata=f))));t.narratorText=n.getNarratorText(t);i?(t.template=u.isSearchHomeZI?0:1,u.isSearchHomeZI||t.classNames.push("people","topResultTemplateInGroups")):t.template==1&&t.classNames.push("forceNoWrapOutsideTopResult")},t.prototype.getPersonTooltip=function(n,t,i,r,u,f,e){var h="",c=[n,i,t,r,u],o,l,s;for(n!=f&&c.push(f),e&&n!=e&&c.push(e),o=0,l=c;o<l.length;o++)s=l[o],s&&(h+=h?"\n"+s:s);return h},t.prototype.decorateContactsWithSameDisplayName=function(t,i){for(var r,e,u,f=0;f<t.length-1;++f)if(r=t[f],r.type=="PPL")for(e=f+1;e<t.length;++e)if(u=t[e],u.type=="PPL"&&r.text.toLocaleLowerCase()==u.text.toLocaleLowerCase()){n.isL2(i)||(r.template!=1&&r.classNames.push("forceNoWrapOutsideTopResult"),u.template!=1&&u.classNames.push("forceNoWrapOutsideTopResult"));r.template=u.template=1;r.primaryMetadata=r.emailHH;u.primaryMetadata=u.emailHH;break}},t}();n.SubstrateSuggestionsParser=s;n.launchDocument=h;n.buildSubstrateDocumentSuggestion=c;n.formatDurationShorthand=f}(WSB||(WSB={})),function(n){function r(n,t){return function(){return n(t)}}function u(n){return encodeURIComponent(n.replace(/-/g,"/").replace(/_/g,"+"))}var f=["Microsoft.Office.OUTLOOK.EXE.15","Microsoft.Office.OUTLOOK.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}Microsoft OfficeOffice15OUTLOOK.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}Microsoft OfficeOffice15OUTLOOK.EXE"],t="OutlookLaunchPref",i=[0,1],e="https://outlook.office365.com/mail/deeplink/attachment/{0}/{1}",o=function(){function o(n){this._substrateSuggestionsDataProvider=n;this._outlookLaunchPreference={}}return o.prototype.parse=function(t,i,r,u,f,e){var p=this,c,l,o,s,a,v,d,h,y,g;if(n.isDataSourceEnabled(r,t)){if(o=[],!u||!u.EntitySets){e(r,o,null);return}var w=n.getEffectiveQuery(t),b=n.getEffectiveScope(t),k=!1;for(s=0,a=u.EntitySets;s<a.length;s++)if(v=a[s],v.ResultSets)for(d=function(f){var g,s,y,e,a,nt,v,d,h,tt;if(f.Results)switch(b){case n.Scope.Emails:for(g=function(f){var e=n.safeExecute(function(){return p.buildMessageSuggestion(t,f.Source,i,r,u.Instrumentation?u.Instrumentation.TraceId:null,f.ReferenceId,w)},"buildMessageSuggestion");e&&n.isValidSuggestion(e,"parseSubstrateSearchResponse_emails",!1)&&o.push(e)},s=0,y=f.Results;s<y.length;s++)h=y[s],g(h);break;case n.Scope.Documents:case n.Scope.All:for(e=f.Results,a=r=="SREE"?(l=(c=f.RecommendationsContext)===null||c===void 0?void 0:c.MeetingContext)===null||l===void 0?void 0:l.Source:null,a&&(e=e.filter(function(n,t){if(n.Provenance!="Exchange")return!0;var i=n.Source.FileName;return!e.some(function(n,r){var u,f;return t==r?!1:n.Provenance=="Exchange"?!1:(f=n.Source,((u=f.LastShared)===null||u===void 0?void 0:u.SharingType)=="Attachment"&&f.FileName==i)})})),nt=function(r){if(t.isSearchHomeZI&&n.config.use3sRecRecommendedFiles&&r.Provenance=="Exchange")return"continue";var e=n.safeExecute(function(){return p.buildDocumentSuggestion(a,r.Source,i,u.Instrumentation?u.Instrumentation.TraceId:null,r.ReferenceId,r.Provenance||f.Provenance,w,t)},"buildDocumentSuggestion");if(e&&n.isValidSuggestion(e,"parseSubstrateSearchResponse_documents")&&(o.push(e),t.isSearchHomeZI&&n.config.use3sRecRecommendedFiles&&typeof n.enableQws=="function"&&n.enableQws()&&n.isMsbEnterprise()&&typeof n.isGccHighTenant=="function"&&!n.isGccHighTenant()&&o.length>=n.config.ziRecommendedDocsResultsCount))return"break"},v=0,d=e;v<d.length;v++)if(h=d[v],tt=nt(h),tt==="break")break;k=!a;break;default:SharedLogHelper.LogError("parseSubstrateSearchResponse",b.toString(),new Error("Unexpected scope"))}},h=0,y=v.ResultSets;h<y.length;h++)g=y[h],d(g);k&&n.decorateSuggestionsWithParentFolder(o);e(r,o,null)}},o.prototype.buildDocumentSuggestion=function(t,i,r,f,o,s,h,c){var it=this,p,w,b=h?HitHighlightingParser.addMarkers(i.FileName,h):i.FileName,l=n.config.disableSyntaxHighlight?b.toLocaleLowerCase().includes(h.toLocaleLowerCase()):b.includes(HitHighlightingParser.startMarker),v,y;if(h&&!l&&(!n.config.minLengthForContentMatch||c.queryToFetch.length<n.config.minLengthForContentMatch))return null;var g=i.Author==null?null:i.Author.DisplayName,k=n.matchesOnPropertyHH(g,h),rt=i.Description?n.decodeHtml(i.Description).replace(/<\/?[^>]+(>|$)/g,""):"",nt=n.tryGetTextContentMatch(rt,h),ut=nt[0],tt=nt[1],d=i.LastModifiedBy==null?null:i.LastModifiedBy.DisplayName,a;return l||k||(n.matchesOnPropertyHH(d,h)&&(a=n.createMatch(n.MatchType.LastModifiedBy,d)),a=a||tt),v=i.Url,y=i.WebUrl,s=="Exchange"&&(y=v,v=null,((p=i.LastShared)===null||p===void 0?void 0:p.AttachmentId)&&(t===null||t===void 0?void 0:t.Id)&&(y=n.formatString(e,[u(t.Id),u(i.LastShared.AttachmentId)]))),n.buildSubstrateDocumentSuggestion(t,c,v,y,b,i.FileName,i.FileExtension,s,i.LastModifiedDateTime,d,(w=i.UserRelationship)===null||w===void 0?void 0:w.LastAccessDateTime,g,!l&&k,!l&&!k&&!!tt,function(){return it._substrateSuggestionsDataProvider.instrumentClick(f,o)},r,h,n.isL2(c),ut,a,i.SiteTitle)},o.prototype.buildMessageSuggestion=function(t,i,r,u,f,e,o){var w=this,a,v,c,p;if(i.IsDraft)return null;if(!i.WebLink)return SharedLogHelper.LogError("buildMessageSuggestion",null,new Error("Missing web link")),null;if(a=i.From&&i.From.EmailAddress?i.From.EmailAddress.Name||i.From.EmailAddress.Address:null,v=i.Sender&&i.Sender.EmailAddress?i.Sender.EmailAddress.Name||i.Sender.EmailAddress.Address:null,!a&&!v)return SharedLogHelper.LogError("buildMessageSuggestion",null,new Error("No valid from or sender fields present")),null;var l=a||v,h=i.Subject,b=u=="SSEE",y="OLE",s=n.createSuggestion(t,HitHighlightingParser.addMarkers(l,o),null,null,y,h||l,n.InstrumentedItem.createInstrumentedItem(r,y),b?8:12,r,!0),k=b?1:2;return this.setEmailContextMenuItems(s,i.ItemHexId,i.WebLink,k),s.click=function(){return w.launchEmail(i.ItemHexId,i.WebLink,k)},s.template=1,s.classNames.push("email","forceNoWrapOutsideTopResult","topResultTemplateInGroups"),s.primaryMetadata=HitHighlightingParser.addMarkers(h,o),s.secondaryMetadata=HitHighlightingParser.addMarkers(i.Preview,o),s.tooltip=l+(h?"\n"+h:""),s.hc=i.SortOrderSource=="Relevance",s.previewIcon={content:"&#xE715",type:2,needsAccentColor:!0},i.HasAttachments&&(s.secondaryIcon={content:"&#xE723",type:2}),i.IsRead||s.classNames.push("accentColor"),i.DateTimeReceived&&(c=n.toDate(i.DateTimeReceived),p=n.getTodayTimeString(c),s.dateShort=p?p:c.toLocaleDateString(),s.dateLong=c.toLocaleString(navigator.language,{year:"numeric",month:"numeric",day:"numeric"}),s.dateAndTime=c.toLocaleString(navigator.language,{weekday:"long",month:"long",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"})),s.internetMessageId=i.InternetMessageId,s.instrumentPingBack=function(){return w._substrateSuggestionsDataProvider.instrumentClick(f,e)},s.narratorText=n.getNarratorText(s),s.subject=HitHighlightingParser.addMarkers(h,o),s.from=l,s.to=i.DisplayTo,s.preview=i.Preview,s.hasAttachment=i.HasAttachments,s.importance=i.Importance!="Normal"?n.Host.getLocString("EmailImportance",i.Importance):"",s.reactKey=y+i.WebLink,s},o.prototype.setEmailContextMenuItems=function(t,i,r,u){var e=this;i&&n.setExtraVerbsAsync(t,function(){var t=[];return ThresholdUtilities.createPromise(function(o){n.LocalDataProvider.getApps(f,function(f){var a=!n.Map.isEmpty(f);if(a){var h=e.getOutlookLaunchPreference(u),c="Outlook",l,s=Object.keys(f);s.length==1&&(c=f[s[0]].deviceItem.displayName,l=f[s[0]].getIcon);t.push({verb:"OpenInOutlookWeb",displayName:n.Host.getLocString("OpenIn","Outlook Web"),executeSync:function(){return e.launchOutlookWeb(r,u)},isDefault:h==0,icon:{content:"&#xE774",type:1}});t.push({verb:"LaunchOutlookNative",displayName:n.Host.getLocString("OpenIn",c),executeSync:function(){return e.launchOutlokNative(i,u)},isDefault:h==1,getIcon:l})}o(t)})})},!0)},o.prototype.launchOutlookWeb=function(t,i,r){var u=this;n.Host.launchUri(t,!1,function(){return u.setOutlookLaunchPreference(0,i)},r)},o.prototype.launchOutlokNative=function(t,i,r){var u=this;n.Host.launchOutlook(t,function(){return u.setOutlookLaunchPreference(1,i)},r)},o.prototype.launchEmail=function(t,u,f){for(var c,e,s,l=this,v=this.getOutlookLaunchPreference(f),o=[v],h=0,a=i;h<a.length;h++)c=a[h],n.contains(o,c)||o.push(c);for(s=o.length-1;s>=0;s--)switch(o[s]){case 1:e=r(function(n){return l.launchOutlokNative(t,f,n)},e);break;case 0:e=r(function(n){return l.launchOutlookWeb(u,f,n)},e)}e()},o.prototype.getOutlookLaunchPreference=function(r){if(!this._outlookLaunchPreference[r]){var u=parseInt(n.LightweightStorage.getItem(t+r));this._outlookLaunchPreference[r]=isNaN(u)?i[0]:u}return this._outlookLaunchPreference[r]},o.prototype.setOutlookLaunchPreference=function(i,r){this._outlookLaunchPreference[r]=i;n.LightweightStorage.setItem(t+r,i.toString())},o}();n.SubstrateSearchParser=o}(WSB||(WSB={}));__awaiter=this&&this.__awaiter||function(n,t,i,r){function u(n){return n instanceof i?n:new i(function(t){t(n)})}return new(i||(i=Promise))(function(i,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?i(n.value):u(n.value).then(o,s)}e((r=r.apply(n,t||[])).next())})};__generator=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e},function(n){function h(){return r()||n.config.msbUseCachedMsbState&&vt()&&rt()}function ri(){return r()||n.config.msbUseCachedMsbState&&rt()}function rt(){var t=n.getCurrentTime()-n.MsbStateExpiryTimeInMs;return!!s&&s>t}function ui(){n.config.msbUseAccountBasedCache&&(c=new n.MsbAccountBasedStorage,n.cleanLegacyMsbStorageItems(),n.Host.bindShown(function(){n.safeExecute(function(){var t=n.LightweightStorage.getItem(f);t&&(_w===null||_w===void 0?void 0:_w.bfbWsbTel)&&bfbWsbTel.logError("Wsb access cache without MSB init",t);n.LightweightStorage.removeItem(f)},"initMsbCommon->bindShown->WsbAccessCacheWithoutMsbInit")}))}function ut(){return n.config.msbUseAccountBasedCache?(c||(n.safeExecute(function(){var i=[{stackTrace:(new Error).stack}],r=n.LightweightStorage.getItem(f),t;if(r){t=[];try{t=JSON.parse(r)}catch(u){}t.length<20&&i.push.apply(i,t)}n.LightweightStorage.setItem(f,JSON.stringify(i))},"getMsbAccountBasedStorage->WsbAccessCacheWithoutMsbInit"),c=new n.MsbAccountBasedStorage),c):n.LightweightStorage}function fi(t){return t===n.Scope.People&&u()?!0:!n.config.msbClientQfNoWaitBackfill}function ei(t,i){l=t;var r={Success:t?"1":"0",EventSource:i};n.InstrumentationHelper===null||n.InstrumentationHelper===void 0?void 0:n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbClientQfSyncDoc",n.SequenceNumberManager.getSequenceNumber(),r)}function oi(t){ft=parseInt(t);var i={Started:"1",StartTime:t?t:""};n.InstrumentationHelper===null||n.InstrumentationHelper===void 0?void 0:n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbClientQfTrieRefreshStart",n.SequenceNumberManager.getSequenceNumber(),i)}function si(t,i){var r=ft,u=parseInt(i),f=r&&u&&!isNaN(r)&&!isNaN(u)&&u-r?(u-r).toString():"",e={ReturnStatus:t!==undefined?t:"",TrieRefreshDurationInMS:f,StartTime:r?r.toString():"",FinishTime:i?i:""};n.InstrumentationHelper===null||n.InstrumentationHelper===void 0?void 0:n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbClientQfTrieRefreshFinished",n.SequenceNumberManager.getSequenceNumber(),e)}function hi(){return l}function et(){var t=l||!!n.MockUrlParameters;return ot()&&yt()&&t}function ci(){return n.config.msbEnableDocumentZQ}function li(){return n.config.msbDsbEduEnabled&&o()}function ot(){return u()&&n.config.msbEnableFileMS||n.config.msbEnableFile}function ai(){return n.config.msb3sFileOff&&r()&&et()}function vi(t){var i="Wsb";return t===n.Scope.Work&&(i="WsbBingVertical"),i}function ht(){var i,t,r=!0;try{t=JSON.parse(n.LightweightStorage.getItem(st)||"");r=n.getCurrentTime()-((i=t===null||t===void 0?void 0:t.lastUpdateTime)!==null&&i!==void 0?i:0)>yi}finally{return n.MockUrlParameters&&typeof n.MockQwsSuccessRateStorageValue=="object"?n.MockQwsSuccessRateStorageValue:!r&&t||pi}}function wi(t){if(n.config.msbQwsDynamicDisableAggregateEnabled){var i=ht();i.sessionCount++;t&&i.successCount++;i.lastUpdateTime=n.getCurrentTime();n.LightweightStorage.setItem(st,JSON.stringify(i))}}function ct(){var t=ht();return n.config.msbQwsDynamicDisableAggregateEnabled?n.config.msbQwsAggregateSuccessThreshold*t.sessionCount<t.successCount*100:!0}function e(){return n.config.msbEnableQuickWorkSearch&&!n.shouldShowDSBLayout(null)&&(!o()||n.config.msbQwsEnabledInEdu)&&!k()}function bi(){return e()&&n.config.msbHideTopApp}function ki(){return e()&&n.config.msbQwsShowTopList}function di(){return e()&&n.config.msbEnableQwsCache}function lt(){return e()&&n.config.msbQwsShowRecommendedDocs}function gi(t){var i=lt()&&ct()&&n.isMsbEnterprise(),r=n.config.use3sRecRecommendedFiles&&n.isMsftAccountConnected;switch(t){case"SSUE":return i&&!r;case"SREE":return i&&r;default:return!1}}function at(){return typeof n.isMsbEnterprise=="function"&&n.isMsbEnterprise()&&n.config.msbEnableBrandBar&&typeof n.View.BrandingBar!="undefined"&&n.config.msbEnableQuickWorkSearch&&!k()}function nr(){return n.config.useCobaltCSS&&at()}function r(){return i===t.Enabled}function tr(){return i===t.Disabled}function vt(){return i===t.Unknown}function ir(){i=t.Disabled;w(!1)}function rr(){i=t.Enabled}function ur(){i=t.Unknown;w(!1)}function fr(){return i}function er(){return it}function or(n){it=n}function sr(n){y=n}function hr(){return y}function w(n){p=n}function o(){return(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbEDUTenant)?r():r()&&p}function cr(n){s=n}function lr(){return s}function ar(){if(typeof BingAtWork=="undefined")return"BingAtWorkNotReady";var n=BingAtWork.msbDataContext;if(n){if(n.dataLoadFired)return"DataLoaded";if(n.readyFired)return"Ready"}return"NotReady"}function yt(){if(typeof BingAtWork=="undefined")return!1;if(n.MockUrlParameters)return!0;var t=BingAtWork.msbDataContext;return t&&t.initializeFired&&t.exposedAccessTokenApiFired&&t.readyFired}function b(){var n;return typeof BingAtWork=="undefined"?!1:!!((n=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||n===void 0?void 0:n.gccRegion)}function k(){var n;return typeof BingAtWork=="undefined"?!1:((n=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||n===void 0?void 0:n.gccRegion)===2}function vr(n){pt=n}function d(){return pt}function yr(t){g=!n.config.disableMsbInternalTenants&&n.config.msbInternalTenants&&t!=null&&n.contains(n.config.msbInternalTenants,t)}function u(){var t;return((t=n.getStoredMsbTenantGroup())===null||t===void 0?void 0:t.toLowerCase())==="msft"||g}function pr(){var t;return((t=n.getStoredMsbTenantGroup())===null||t===void 0?void 0:t.toLowerCase())==="lighthouse"}function wr(n,t){return Math.random()*t+n}function br(){var t;try{if(t=n.getStoredMsbIcon(),t==="")return"";var i=atob(t),r=i.startsWith("<svg")||i.startsWith("<?xml"),u=r?"svg+xml":"jpeg";return"data:image/".concat(u,";base64,").concat(t)}catch(e){return""}}function kr(){try{var t=br(),r=n.getStoredMsbIconLargeIsDefault(),u="#".concat(n.getStoredMsbNavColor()),f="#".concat(n.getStoredMsbFontColor()),i=n.getStoredMsbTenantName();return t||i?{logoDataUri:t,iconLargeIsDefault:r,backColor:u,companyName:i,fontColor:f}:undefined}catch(e){return undefined}}function dr(){return n.config.msbEnableAuthLog}function gr(){return n.config.msbEnableClientQFDelayLog}function nu(t){n.LightweightStorage.setItem(a,t?"1":"0")}function tu(){n.LightweightStorage.removeItemsWithKeyPrefix(a)}function iu(){return(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.bfbMock)!=null||n.LightweightStorage.getItem(a)==="1"}function ru(t,i){n.LightweightStorage.setItem(t,i)}function uu(t){var i=n.config.msbUseAccountBasedCache?n.MsbQuickWorkSearchCacheStorageKey:n.LegacyQuickWorkSearchCacheStorageKey;t?n.LightweightStorage.setItem(i,t):n.LightweightStorage.removeItem(i)}function fu(){var t=n.config.msbUseAccountBasedCache?n.MsbQuickWorkSearchCacheStorageKey:n.LegacyQuickWorkSearchCacheStorageKey;return n.LightweightStorage.getItem(t)}function eu(){n.LightweightStorage.removeItemsWithKeyPrefix(n.PersonIconCacheStorageKeyPrefix)}function ou(n){var i,r,t=wt(n),u=(i=t===null||t===void 0?void 0:t.tenant_region_sub_scope)===null||i===void 0?void 0:i.toLowerCase(),f=(r=t===null||t===void 0?void 0:t.tenant_region_scope)===null||r===void 0?void 0:r.toLowerCase();return u==="gcc"?1:f==="usg"||f==="usgov"?u==="dod"?0:2:0}function su(t,i){return v()&&(t===21||i==n.Scope.Work)}function hu(){return n.Host.getLocString(o()?"SchoolResults":"WorkResults")}function v(){return(n.config.msbVerticalWorkScopeEnabledWW||n.config.msbVerticalWorkScopeEnabled&&u()&&!n.config.disableMsbInternalTenants)&&h()&&!n.getStoredMsbIsEdu()&&!b()}function cu(){return v()&&n.config.msbNewWorkScopeEnabled&&n.config.msbWorkScopeDsbRedirectEnabled}function lu(){return(n.config.msbWorkScopeBannerIndicatorEnabledWW||n.config.msbWorkScopeBannerIndicatorEnabled&&u())&&v()&&(!n.MockUrlParameters||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.showWorkUpsell))}function wt(n){if(!n)return undefined;try{var t=n.split(".")[1],i=t.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(i).split("").map(function(n){return"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(r)}catch(u){return undefined}}function au(t,i){var r=n.getSyntheticSuggestion(t,i,"ORB",null,23,null,!1,function(){var t,i,r=n.Host.getQuery(),u=(i=(t=n.ScopeConfig===null||n.ScopeConfig===void 0?void 0:n.ScopeConfig[n.Scope.Documents])===null||t===void 0?void 0:t.prefixes)===null||i===void 0?void 0:i[0],f="".concat(u,": ").concat(r.queryToFetch);n.Host.reformulateNonForcedMiniSerp(f,r.isSearchHomeZI,null);n.InstrumentationHelper.logClientInstEvent("Select","OnRampButtonToDocumentScope",null)});return r.staticGroupType=n.GroupType.MsbOnRampButton,r.query=t.queryToFetch,r.text=n.Host.getLocString("FindMoreDocuments"),r.narratorText=n.getNarratorText(r),r.classNames=["onRampButton"],r.suppressed=!0,r}function vu(t){var i,r,u=(i={},i[0]=n.config.msbApiBaseUrl,i[1]=n.config.msbGccApiBaseUrl,i[2]=n.config.msbGccHighApiBaseUrl,i),f=((r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||r===void 0?void 0:r.gccRegion)?u[BingAtWork.wsb.gccRegion]:n.config.msbApiBaseUrl;return"".concat(f,"/").concat(t)}function yu(t){var i,r,u=n.config.msbDsbUseLocal?n.config.msbDsbApiBaseLocalUrl:n.config.msbDsbApiBaseUrl,f=(i={},i[0]=u,i[1]=n.config.msbDsbGccApiBaseUrl,i[2]=n.config.msbDsbGccHighApiBaseUrl,i),e=((r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||r===void 0?void 0:r.gccRegion)?f[BingAtWork.wsb.gccRegion]:u;return"".concat(e,"/").concat(t)}function pu(t){var r,f,i=n.config.lokiBaseApiUri;return u()&&n.isMsbEnterprise()&&n.config.lokiBaseApiUriOverrideEnabled&&(i=n.config.lokiMsitBaseApiUri),((r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||r===void 0?void 0:r.gccRegion)===1?i=n.config.lokiGccBaseApiUri:((f=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||f===void 0?void 0:f.gccRegion)===2&&(i=n.config.lokiGccHighBaseApiUri),i?"".concat(i,"/").concat(t):undefined}function gu(n){var i,t;if(!n||(i=typeof n.get=="function"?n.get(bt):n[bt],!i)||(t=i.match(wu),(t===null||t===void 0?void 0:t.length)!=bu))return undefined;var r=t[ku],u=t[du],f=new Date(u).getTime();return{traceId:r,timestamp:f}}function nf(n){var i=n===null||n===void 0?void 0:n.trim(),t,r,u;return i?(t=i.indexOf(" "),t<=0)?null:(r=n.substring(0,t),u=n.substring(t+1),{firstName:r,lastName:u}):null}function tf(){var i=n.config.msbDsbPersistOrgChartExpansion==="alwaysOn",t;return n.config.msbDsbPersistOrgChartExpansion==="storage"&&(t=ut().getItem(n.MsbDsb.myOrgChartExpansionStorageKey,!0),i=t?t==="1":n.config.msbDsbColdStartOrgChartOpen),i}function rf(){return n.config.msbLoadQfScriptEarly&&h()&&n.getCurrentTime()-dt<kt}function uf(){return h()&&!o()&&!b()}function ff(t){return t?n.config.msbQwqsLmsQuickWorkQueryKeys:n.config.msbQwqsDefaultQuickWorkQueryKeys}function sf(t,i,r,u,f){return __awaiter(this,void 0,void 0,function(){var h,o,s,c,e;return __generator(this,function(l){switch(l.label){case 0:return!t||!i||!r?[2,""]:(h=encodeURIComponent(i),o="",r!="Person"&&(s={triggeringMode:"Explicit",intent:r},u&&(s.entityId=u),c=JSON.stringify(s),o=encodeURIComponent(c)),e=n.formatString(t.bfbSearchUrl||"",[h,o,f]),[4,nt(e)]);case 1:return e=l.sent(),e=gt(e),[2,e]}})})}function hf(t,i,r){return __awaiter(this,void 0,void 0,function(){var u;return __generator(this,function(f){switch(f.label){case 0:return u=n.formatString(t.bfbSearchUrl||"",[i,"",r]),[4,nt(u)];case 1:return u=f.sent(),u=gt(u),[2,u]}})})}function nt(n){return __awaiter(this,void 0,void 0,function(){var t,r,o,s,h,f,e,u,c,l,i;return __generator(this,function(a){switch(a.label){case 0:if(!n||typeof crypto!="object")return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error",'No "window.crypto" object'),[2,n];if(t=typeof d=="function"?d():undefined,!(t===null||t===void 0?void 0:t.TenantId)||!(t===null||t===void 0?void 0:t.UserAadId))return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error","No user info."),[2,n];if(r=cf(),!r)return[2,n];a.label=1;case 1:return a.trys.push([1,3,,4]),o="".concat(t===null||t===void 0?void 0:t.UserAadId.toLowerCase(),"@").concat(t===null||t===void 0?void 0:t.TenantId.toLowerCase(),"@").concat(r.toLowerCase()),s=Uint8Array.from(o.split("").map(function(n){return n.charCodeAt(0)})),[4,crypto.subtle.digest("SHA-256",s)];case 2:for(h=a.sent(),f=new Uint8Array(h),e="",u=0;u<f.length;u++)c=f[u],e+=c.toString(16).padStart(2,"0");return l="olu=".concat(e,"&olus=").concat(r),[2,ni(n,l)];case 3:return i=a.sent(),_w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error","Exception: ".concat((i===null||i===void 0?void 0:i.message)||JSON.stringify(i))),[2,n];case 4:return[2]}})})}function gt(n){if(!n)return n;var t=_G&&_G.IG?"cvid=".concat(encodeURIComponent(_G.IG)):undefined;return t?ni(n,t):n}function cf(){try{var t=new Uint8Array(16);return _w.crypto.getRandomValues(t),Array.from(t).map(function(n){return n.toString(16).padStart(2,"0")}).join("")}catch(n){return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error","Generate salt throws: ".concat((n===null||n===void 0?void 0:n.message)||JSON.stringify(n))),""}}function ni(n,t){var i=n.indexOf("#"),r,u;return i<0?ti(n,t):(r=n.substring(0,i),u=n.substring(i),"".concat(ti(r,t)).concat(u))}function ti(n,t){var i=n.indexOf("?"),r=i<0?"?":"&";return"".concat(n).concat(r).concat(t)}function lf(n){var t;if((t=n===null||n===void 0?void 0:n.match(/[^\?\#]*/))!==null&&t!==void 0)return t[0]}var t,ii,tt,c,f,l,ft,y,p,pt,g,a,kt,dt,ef;(function(n){n[n.Unknown=0]="Unknown";n[n.Enabled=1]="Enabled";n[n.Disabled=2]="Disabled"})(t=n.TenantMsbStatus||(n.TenantMsbStatus={})),function(n){n.ValidResults="Valid Results";n.Empty="Empty";n.NoResults="No Results";n.Invalid="Invalid";n.Error="Error";n.Expired="Expired";n.NotApplicable="NotApplicable"}(ii=n.CacheState||(n.CacheState={}));tt=["Edu"];n.isPickedTenantVariant=function(n){return tt.indexOf(n)!==-1};var i=t.Unknown,it=[],s=undefined;n.MsbStateExpiryTimeInMs=432e6;n.shouldForceEnterpriseAccount=h;n.hasBeenMsbUser=ri;f="noclean-msb-abs-wo-init";n.initMsbCommon=ui;n.getMsbAccountBasedStorage=ut;n.enableWaitForBackfill=fi;l=!1;n.setClientQfSyncDocEventFired=ei;n.setClientQFTrieRefreshStartedEventFired=oi;n.setClientQFTrieRefreshFinishedEventFired=si;n.getClientQfSyncDocEventFired=hi;n.isMsbFileReady=et;n.isDocumentZeroQueryEnabled=ci;n.isMsbDsbEduEnabled=li;n.isMsbFileEnabled=ot;n.is3sFileDisabled=ai;n.getClientType=vi;var st="MsbQwsSuccessRate",yi=864e6,pi={successCount:16,sessionCount:20,lastUpdateTime:n.getCurrentTime()};n.incrementQwsAggregateSuccessRate=wi;n.isQwsSuccessRateMet=ct;n.enableQws=e;n.shouldHideTopApp=bi;n.qwsShowTopList=ki;n.enableQwsCache=di;n.enableQwsRecDocs=lt;n.isDocSrcEnabledInQws=gi;n.enableBrandingBar=at;n.enableCobaltBranding=nr;n.isTenantMsbEnabled=r;n.isTenantMsbDisabled=tr;n.isTenantMsbStatusUnknown=vt;n.setTenantMsbDisabledStatus=ir;n.setTenantMsbEnabledStatus=rr;n.setTenantMsbUnknownStatus=ur;n.getTenantMsbStatus=fr;n.getMsbTenantVariants=er;n.setMsbTenantVariants=or;y=!1;n.setHasEduAssignmentsFlags=sr;n.getHasEduAssignmentsFlags=hr;p=!1;n.setIsMsbEduTenantEnabled=w;n.getIsMsbEduTenantEnabled=o;n.setLastMsbEnabledTime=cr;n.getLastMsbEnabledTime=lr;n.getMsbClientQfState=ar;n.isClientQfReady=yt;n.isGccTenant=b;n.isGccHighTenant=k;n.setAadUserInfo=vr;n.getAadUserInfo=d;g=!1;n.checkAndSetIsMsbInternalTenant=yr;n.getIsMsbInternalTenant=u;n.getIsLightHouseTenant=pr;n.getRandomNumInRange=wr;n.getMsbBranding=kr;n.isAuthLogEnabled=dr;n.isClientQFDelayLogEnabled=gr;a="MsbQfReady";n.setIsMsbClientQfTokenReady=nu;n.clearIsMsbClientQfTokenReady=tu;n.getIsMsbClientQfTokenReady=iu;n.setValueToLocalStorage=ru;n.LegacyQuickWorkSearchCacheStorageKey="QwsCache";n.MsbQuickWorkSearchCacheStorageKey="MsbQwsCache";n.setQuickWorkSearchCache=uu;n.getQuickWorkSearchCache=fu;n.PersonIconCacheStorageKeyPrefix="MsbPersonIcon";n.clearQuickWorkSearchPersonImageCache=eu;n.getGccRegion=ou;n.isMsbWorkScope=su;n.getWorkSuggestionAnnotation=hu;n.isMsbWorkScopeApplicable=v;n.isMsbWorkScopeDsbRedirectEnabled=cu;n.isMsbWorkUpsellApplicable=lu;n.parseJwt=wt;n.getOnRampButtonSuggestion=au;n.getMsbUrl=vu;n.getDsbUrl=yu;n.getLokiUrl=pu;var wu=/Ref A: ([A-Z0-9]+)\sRef B: ([^\s]+) Ref C: (.+)/,bu=4,ku=1,du=3,bt="x-msedge-ref";n.getMsEdgeRef=gu;n.getFirstAndLastName=nf;n.getIsMyOrgChartExpanded=tf;kt=5e3;dt=n.getCurrentTime();n.isMsbQfInScriptsEarlyLoadState=rf;n.isNonEduNonGccMsbEnterprise=uf;n.getQuickWorkQueryKeys=ff,function(n){n[n.MsbAjaxMakeHttpRequestAsyncError=-1]="MsbAjaxMakeHttpRequestAsyncError";n[n.ResponseJsonParseError=-2]="ResponseJsonParseError";n[n.ReadResponseError=-3]="ReadResponseError";n[n.ReadErrorStatusResponseError=-4]="ReadErrorStatusResponseError";n[n.NoWsbAccessToken=-5]="NoWsbAccessToken";n[n.FetchError=-6]="FetchError";n[n.UncaughtError=-7]="UncaughtError";n[n.NoMsbLokiAccessToken=-8]="NoMsbLokiAccessToken";n[n.Aborted=-9]="Aborted";n[n.TimedOut=-11]="TimedOut";n[n.XhrError=-12]="XhrError";n[n.XhrCompleted=-13]="XhrCompleted";n[n.MsbTokenExpiredBeforeRequest=-14]="MsbTokenExpiredBeforeRequest";n[n.UrlUnavailable=-15]="UrlUnavailable";n[n.RefreshTokenFailure=-16]="RefreshTokenFailure"}(ef=n.ClientErrorCode||(n.ClientErrorCode={}));n.buildBfbSearchUrlAsync=sf;n.buildMsbWorkSearchUrlAsync=hf;n.getUrlBaseInfo=lf;_w.BingAtWork||(_w.BingAtWork={});BingAtWork.Wsb=BingAtWork.Wsb||{};BingAtWork.Wsb.addMsbUserInfoParameterToUrlAsync=nt}(WSB||(WSB={})),function(n){function e(){if(typeof BingAtWork=="undefined")return{inputState:t.NoBingAtWork};var n=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.CQFDebugInfo,i=n===null||n===void 0?void 0:n.trieState;return o(i)}function o(n){if(!n)return{inputState:t.None};var u=s(n),i=undefined;return n.lastRefreshTime&&(i=r(n.lastRefreshTime)),{inputState:n.inputState,inputSources:u,lastRefreshInHours:i,version:n.version}}function r(t){var i=n.getCurrentTime()-t;return Math.ceil(i/f)}function s(n){var r,f=n===null||n===void 0?void 0:n.inputSources,t,e,o;if(!f)return null;if(t={},Array.isArray(f))f.forEach(function(n){var i=u(n);i&&(t[n.sourceType]=i)});else for(e in i)o=u((r=n===null||n===void 0?void 0:n.inputSources)===null||r===void 0?void 0:r[e]),o&&(t[e]=o);return t}function u(n){if(!n)return null;var t=undefined,i=undefined,u=undefined;return n.lastFullSyncTime&&(t=r(n.lastFullSyncTime)),n.lastDeltaSyncTime&&(i=r(n.lastDeltaSyncTime)),n.entityType&&(u=n.entityType),{sourceType:n.sourceType,isComplete:n.isComplete,entityType:u,lastFullSyncInHours:t,lastDeltaSyncInHours:i}}var f=36e5,i,t;(function(n){n[n.None=0]="None";n[n.EdgeWorth=1]="EdgeWorth";n[n.People=2]="People";n[n.Groups=3]="Groups";n[n.Bookmarks=4]="Bookmarks";n[n.Qna=5]="Qna";n[n.Buildings=6]="Buildings";n[n.EducationAssignments=7]="EducationAssignments";n[n.UserHistory=8]="UserHistory";n[n.Connector=9]="Connector";n[n.TopBookmarks=10]="TopBookmarks";n[n.ServerTrie=11]="ServerTrie"})(i||(i={})),function(n){n[n.NoBingAtWork=-2]="NoBingAtWork";n[n.None=-1]="None";n[n.Empty=0]="Empty";n[n.Partial=1]="Partial";n[n.Complete=2]="Complete"}(t||(t={}));n.getMsbClientQfTrieState=e}(WSB||(WSB={})),function(n){function e(){i&&(i.isWsbPrefetchEnabled=n.config.wsbWorkScopeWsbPrefetchEnabled)}function o(r){if((t===null||t===void 0?void 0:t.substrateUnifiedSearch)&&i){i.query=r;var e=n.config.msbWorkScopeScenarioNameEnabled?u:f;t.substrateUnifiedSearch("All",null,!0,e)}}function s(){if((t===null||t===void 0?void 0:t.fetchTenantSettings)&&typeof n.getMsbUrl=="function"){var i=n.getMsbUrl("v2/tenant/my/settings");t.fetchTenantSettings(!0,i);t.isTenantSettingsPrefetchStarted=!1}}function h(){if((t===null||t===void 0?void 0:t.fetchUserConfigs)&&typeof n.getMsbUrl=="function"){var i=n.getMsbUrl("v3/user/data/configs");t.fetchUserConfigs(i)}}var r,t=_w.BingAtWork,i=(r=_w.BingAtWork)===null||r===void 0?void 0:r.context,u="wsb.ux.workserp",f="msb.ux.workserp";n.MiniSerpPrefetchKey="wsminiSerp";n.InitMsbPrefetch=e;n.FetchMsbUnifiedSearch=o;n.FetchTenantSettings=s;n.FetchUserConfigs=h}(WSB||(WSB={})),function(n){function f(t){var i;if(!t)return{error:"BingAtWork.wsb.wsbAccessToken - not set"};if(i=n.parseJwt(t),!i)return{error:"BingAtWork.wsb.wsbAccessToken - failed to parse token"};var r=i.appid,u=i.aud,f=i.iss,e=i.scp,o=i.amr;return{appid:r,aud:u,iss:f,scp:e,amr:o}}function c(t){var i=JSON.stringify(t);n.LightweightStorage.setItem(u,i)}function e(){n.LightweightStorage.removeItem(u)}function t(){var t=n.LightweightStorage.getItem(u);if(t)try{return JSON.parse(t)}catch(i){e()}return null}function l(){var n,i;if((i=(n=t())===null||n===void 0?void 0:n.tenantSettings)!==null&&i!==void 0)return i.tenantDisplayName}function a(){var n,i;if((i=(n=t())===null||n===void 0?void 0:n.tenantSettings)!==null&&i!==void 0)return i.iconLarge}function v(){var n,i;if((i=(n=t())===null||n===void 0?void 0:n.tenantSettings)!==null&&i!==void 0)return i.iconLargeIsDefault}function y(){var n,i;if((i=(n=t())===null||n===void 0?void 0:n.tenantSettings)!==null&&i!==void 0)return i.navColor}function p(){var n,i;if((i=(n=t())===null||n===void 0?void 0:n.tenantSettings)!==null&&i!==void 0)return i.fontColor}function w(){var n,i;return((i=(n=t())===null||n===void 0?void 0:n.tenantSettings)===null||i===void 0?void 0:i.isEdu)||!1}function b(){var n,i;return((i=(n=t())===null||n===void 0?void 0:n.tenantSettings)===null||i===void 0?void 0:i.tenantVariants)||[]}function k(){var n,i;if((i=(n=t())===null||n===void 0?void 0:n.tenantSettings)!==null&&i!==void 0)return i.tenantGroup}var i=1440,r=360,u="MsbTenantSetting",o="000000",s="ffffff",h=function(){function u(i,r){var f=this,u;this._msbTokenManager=i;this._msbDataAccess=r;this._fetchingTenant=!1;this._tenantEnabledHandlers=[];this._tenantDisabledHandlers=[];n.config.msbCleanTenantSettingLocalStorage&&this.cleanLocalTenantSettingState();u=t();n.setLastMsbEnabledTime(u===null||u===void 0?void 0:u.lastMsbEnabledTimestamp);this._msbTokenManager.bindMsbAccountAvailableTenantSettingHandler(function(n,t,i,r){f.checkTenantSettings(n,t,i,r)});this._msbTokenManager.bindAadNotAvailable(function(){f.cleanLocalTenantSettingState()})}return u.prototype.bindTenantEnabled=function(n){this._tenantEnabledHandlers.push(n)},u.prototype.bindTenantDisabled=function(n){this._tenantDisabledHandlers.push(n)},u.prototype.checkTenantSettings=function(t,i,r,u){var s=this,f=t,e,o;typeof n.msbPerfLogger=="object"&&(typeof this._lastPerfMarkCallId=="undefined"&&(this._lastPerfMarkCallId=0),e=this._lastPerfMarkCallId++,n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsStarted,e),f=function(){typeof n.msbPerfLogger=="object"&&n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsReturned,e);t()});o=n.getCurrentTime();this.shouldGetTenantSettings(o,u===null||u===void 0?void 0:u.RoutingHint)?this.checkTenantSettingsFromServer(f,function(n){s.checkTenantSettingsFromCache(f,function(){(n===null||n===void 0?void 0:n.hasNativeIssue)||_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Tenant Settings Auth Fails and No Cached Results Available");i(n)},r,u)},r,u,e):this.checkTenantSettingsFromCache(f,function(){_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Tenant Settings No Cached Results Available");i({})},r,u)},u.prototype.checkTenantSettingsFromCache=function(n,t,i,r){var u=this.getLocalTenantSetting();u?(this.updateTenantFlags(u,r),n()):(this.cleanLocalTenantSettingState(),t({}))},u.prototype.checkTenantSettingsFromServer=function(i,r,u,e,h){var c=this,l,a;this._fetchingTenant||(this._fetchingTenant=!0,l=function(t,f){var l,a,v,y,k,d;if(typeof n.msbPerfLogger=="object"&&n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsResponded,h),t&&t.tenantSettings){var p={isEnabled:t.tenantSettings.isEnabled,isEdu:((l=t.tenantSettings.variants)===null||l===void 0?void 0:l.indexOf("Edu"))>=0,tenantVariants:(a=t.tenantSettings.variants)===null||a===void 0?void 0:a.filter(function(t){return n.isPickedTenantVariant(t)}),tenantDisplayName:t.tenantSettings.tenantDisplayName,iconLarge:t.tenantSettings.iconLargeIsDefault?"":t.tenantSettings.iconLarge,iconLargeIsDefault:t.tenantSettings.iconLargeIsDefault,navColor:((v=t.tenantSettings.themeColors)===null||v===void 0?void 0:v[1])||o,fontColor:((y=t.tenantSettings.themeColors)===null||y===void 0?void 0:y[2])||s,tenantGroup:t.tenantSettings.tenantGroup},w=n.getCurrentTime(),b=t.tenantSettings.isEnabled?w:undefined;c.updateTenantFlags(p,e);n.setLastMsbEnabledTime(b);c.updateTenantSettingStateCache(e===null||e===void 0?void 0:e.RoutingHint,200,w,b,p);c._fetchingTenant=!1;i()}else k="Response: ".concat(JSON.stringify(t)),d=n.getIsMsbInternalTenant()?k:"",_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Empty Tenant Settings","",{serverTraceId:f,statusCode:200,additionalMessage:d},{caller:u}),c._fetchingTenant=!1,r({})},a=function(o,s){var p="[MSB.Error] checkTenantSettings: onError: ".concat(JSON.stringify({statusCode:o,ajaxErrorInfo:s})),h;var l=o===404,a=o===401||o===403,w=o===-1,v=n.getCurrentTime();if(l?(c.handleMsbDisable(),n.setLastMsbEnabledTime(undefined),c.updateTenantSettingStateCache(e===null||e===void 0?void 0:e.RoutingHint,404,v,undefined,{isEnabled:!1,tenantDisplayName:"",iconLarge:"",iconLargeIsDefault:!1,navColor:"",fontColor:"",isEdu:!1,tenantVariants:[],tenantGroup:""})):(h=t(),c.updateTenantSettingStateCache(e===null||e===void 0?void 0:e.RoutingHint,o,v,h===null||h===void 0?void 0:h.lastMsbEnabledTimestamp,h===null||h===void 0?void 0:h.tenantSettings)),o!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){var b=l?"Wsb Fetch Tenant Settings Non MSB":"Wsb Fetch Tenant Settings Failed",k=s.message,d=s.errorMessage,g=s.responseText,nt=s.stackTrace,tt=s.serverTraceId,it=s.requestSentTime,rt=s.responseReceivedTime,y=n.getIsMsbInternalTenant()?"ResponseText: ".concat(g,", ErrorMessages: ").concat(d):"",ut=a?"".concat(y,", token=").concat(JSON.stringify(f(BingAtWork.wsb.wsbAccessToken))):y,ft=n.getIsMsbInternalTenant()?nt:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(b,k,{stackTrace:ft,serverTraceId:tt,statusCode:o,additionalMessage:ut},{caller:u,ReqTS:it,ResTS:rt})}c._fetchingTenant=!1;l?i():r({hasTokenIssue:a,hasNativeIssue:w})},typeof n.msbPerfLogger=="object"&&n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsRequested,h),this._msbDataAccess.getTenantSetting(l,a))},u.prototype.updateTenantSettingStateCache=function(n,i,r,u,f){var s,h;var o=t(),l=o&&o.failedTimes||0,e=l+1;(i===200||i===404||i==-1)&&(e=0);s=this.getNextIntervalWaitTime(i,e);h={lastMsbEnabledTimestamp:u,lastTimestamp:r,nextRequestIntervalInMinutes:s,failedTimes:e,routingHint:n,tenantSettings:f};c(h)},u.prototype.shouldGetTenantSettings=function(n,i){var r=t(),u=!0;if(r){var f=r.lastTimestamp,e=r.nextRequestIntervalInMinutes,o=r.routingHint;i===o&&(u=n>f+e*6e4)}return u},u.prototype.cleanLocalTenantSettingState=function(){e()},u.prototype.handleMsbDisable=function(){n.setTenantMsbDisabledStatus();this._tenantDisabledHandlers&&this._tenantDisabledHandlers.forEach(function(t){n.safeExecute(function(){return t()},"MsbTenantManager::fireTenantDisabled")})},u.prototype.getLocalTenantSetting=function(){var n=t();if(n!==null&&n!==void 0)return n.tenantSettings},u.prototype.updateTenantFlags=function(t,i){var r=t.isEnabled,u=t.isEdu,f=t.tenantVariants;r?(n.setTenantMsbEnabledStatus(),n.setIsMsbEduTenantEnabled(u),n.setMsbTenantVariants(f),this._tenantEnabledHandlers&&this._tenantEnabledHandlers.forEach(function(t){n.safeExecute(function(){return t(i===null||i===void 0?void 0:i.RoutingHint)},"MsbTenantManager::fireTenantEnabled")})):this.handleMsbDisable()},u.prototype.getNextIntervalWaitTime=function(t,u){var f=0,e;return t===200||t===404?f=n.getRandomNumInRange(i,r):u<=n.config.msbTenantSettingRetryNoWaitFailedTimes||t==-1?f=0:(e=(u-n.config.msbTenantSettingRetryNoWaitFailedTimes)*n.config.msbTenantSettingRetryInMin,f=t==503||t==429?f+e*3:f+e*4,f>=i+r&&(f=n.getRandomNumInRange(i,r))),f},u}();n.MsbTenantManager=h;n.getReducedTokenInfo=f;n.getLocalTenantSettingState=t;n.getStoredMsbTenantName=l;n.getStoredMsbIcon=a;n.getStoredMsbIconLargeIsDefault=v;n.getStoredMsbNavColor=y;n.getStoredMsbFontColor=p;n.getStoredMsbIsEdu=w;n.getStoredMsbTenantVariants=b;n.getStoredMsbTenantGroup=k}(WSB||(WSB={}));__spreadArray=this&&this.__spreadArray||function(n,t,i){if(i||arguments.length===2)for(var r=0,f=t.length,u;r<f;r++)!u&&r in t||(u||(u=Array.prototype.slice.call(t,0,r)),u[r]=t[r]);return n.concat(u||Array.prototype.slice.call(t))},function(n){var t;n.LegacyAadUserIdKey="AadUserId";t="MsbWsbAadUserId";n.LegacyWsbVerifyAccountRequiredKey="WsbVerifyAccountRequired";var i="MsbWsbVerifyAccountRequired",r=3e5,u=6e4,f=6e4,e=50,o=function(){function o(t){var i=this,r;this._accessTokenManager=t;this._msbAccount=null;this._substrateAccount=null;this._lokiAccount=null;this._userId=null;this._tenantId=null;this._tokenChanged=!1;this._tokenChangedHandlers=[];this._aadNotAvailableHandlers=[];this._wsbAadReadyNotified=!1;this._accountTypeChangedIsFiring=!1;this._mockToken=null;n.Host.bindAccountChanged(function(){return i.clearMemoryCachedInfo()});t.bindAccountTypesChanged(function(){i.handleAccountTypeChanged()});t.bindVerifyAccountRequired(function(n,t){i.handleWsbVerifyAccountRequired(n,t)});t.bindAccessTokenAvailable(function(n,t){i.handleWsbAccessTokenAvailable(n,t)});t.bindSelectedAccountChanged(function(){i.handleWsbSelectedAccountChanged()});n.config.msbLoadQfScriptEarly&&n.safeSetTimeout(function(){n.shouldForceEnterpriseAccount()&&_w.postMessage({messageType:"BingAtWork:WsbQfScriptLoad"},"*")},e,"MsbTokenManager Constructor");n.config.msbDsbReconnectAad&&(r="mdsb-rclog",t.bindReconnectAadReport(function(t){var u=n.LightweightStorage.getItem(r),i=u?JSON.parse(u):{total:0,error:0,rawReports:[]};i.rawReports.push(t);i.total++;t.success||i.error++;n.LightweightStorage.setItem(r,JSON.stringify(i))}),n.Host.bindBootstrapDone(function(){var t=n.LightweightStorage.getItem(r);t&&(_w.bfbWsbTel&&bfbWsbTel.logValue("MsbDsbReconnectAadReport",t),n.LightweightStorage.removeItem(r))}))}return o.prototype.bindMsbAccountAvailableTenantSettingHandler=function(n){this._msbAccountAvailableTenantSettingHandler=n},o.prototype.bindAadNotAvailable=function(n){this._aadNotAvailableHandlers.push(n)},o.prototype.clearMemoryCachedInfo=function(){this._lokiAccount=null},o.prototype.bindTokenChanged=function(n){this._tokenChangedHandlers.push(n);var t=this.getMsbToken();t&&n(t)},o.prototype.refreshMsbTokenAndCall=function(t,i,r){var o=this,e,u,f;r=r&&__spreadArray(__spreadArray([],r,!0),["MsbTokenManager::refreshMsbTokenAndCall"],!1);typeof n.msbPerfLogger=="object"&&(typeof this._lastPerfMarkCallId=="undefined"&&(this._lastPerfMarkCallId=0),e=this._lastPerfMarkCallId++);u=this.getMsbToken("refreshMsbTokenAndCall:1");!u||(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbAlwaysAuthBaw)?(f=n.getCurrentTime(),this.callGetMsbAccount(!0,function(){var r=o.getMsbToken("refreshMsbTokenAndCall:2"),u=n.getCurrentTime(),e=!r;n.isAuthLogEnabled()&&u-f>100&&_w.bfbWsbTel&&bfbWsbTel.logError("Wsb long token refresh delay","Token error: ".concat(e),undefined,{durationInMs:u-f});r?n.safeExecute(function(){return t(r)},"MsbTokenManager::refreshMsbTokenAndCall:callback - fetched token"):i&&n.safeExecute(i,"MsbTokenManager::refreshMsbTokenAndCall:noTokenCallback")},"refreshMsbTokenAndCall",r,e)):n.safeExecute(function(){return t(u)},"MsbTokenManager::refreshMsbTokenAndCall:callback - cached token")},o.prototype.refresh3sTokenAndCall=function(t,i,r){var f=this,u;r=r&&__spreadArray(__spreadArray([],r,!0),["MsbTokenManager::refresh3sTokenAndCall"],!1);u=this.get3sToken();u?n.safeExecute(function(){return t(u)},"MsbTokenManager::refresh3sTokenAndCall:callback - cached token"):this.refreshMsbTokenAndCall(function(){f.callFetch3sAccount(function(){f.after3sAccountRefreshed(t,i)})},function(){i&&n.safeExecute(function(){return i()},"MsbTokenManager::refresh3sTokenAndCall:noTokenCallback")})},o.prototype.isAadAvailable=function(){return this._accessTokenManager.isAadAvailable()},o.prototype.getSelectedAccountId=function(){return this._accessTokenManager.getSelectedAccountId()},o.prototype.after3sAccountRefreshed=function(t,i){var r=this.get3sToken();r?n.safeExecute(function(){return t(r)},"MsbTokenManager::refresh3sTokenAndCall:callback - fetched token"):i&&n.safeExecute(i,"MsbTokenManager::refresh3sTokenAndCall:noTokenCallback")},o.prototype.getMsbToken=function(t){var i,r,f;return this._msbAccount?(i=n.getCurrentTime(),r=i>this._msbAccount.ExpireDateTime,(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbAuthFailed)||r)?(BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=undefined,BingAtWork.wsb.wsbAccessTokenWamExp=undefined,BingAtWork.wsb.wsbAccessTokenJwtExp=undefined),n.isMsftAccountConnected&&r&&t&&(f="Token expired by ".concat((i-this._msbAccount.ExpireDateTime)/u," mins and caller: ").concat(t),bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logError("MsbTokenExpired",f)),this._msbAccount=null,undefined):this._msbAccount.Token:undefined},o.prototype.get3sToken=function(){if(!this._substrateAccount)return undefined;var t=n.getCurrentTime();return t>this._substrateAccount.ExpireDateTime?(this._substrateAccount=null,BingAtWork.wsb&&(BingAtWork.wsb.wsb3sAccessToken=null),undefined):this._substrateAccount.Token},o.prototype.getMsbAccountRoutingHint=function(){var n;if((n=this._msbAccount)!==null&&n!==void 0)return n.RoutingHint},o.prototype.getLokiToken=function(){if(!this._lokiAccount)return undefined;var t=n.getCurrentTime();return t>this._lokiAccount.ExpireDateTime?(this._lokiAccount=null,(BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)&&(BingAtWork.wsb.wsbLokiAccessToken=null),undefined):this._lokiAccount.Token},o.prototype.refreshLokiTokenAndCall=function(t,i,r){var f=this,e=this.getLokiToken(),u;e?n.safeExecute(function(){return t()},"MsbTokenManager::refreshLokiTokenAndCall:".concat(r," - cached token")):(u=this.getMsbToken("refreshLokiTokenAndCall"),u?this.callFetchLokiAccount(function(){f.afterLokiAccountRefreshed(t,i)}):i&&n.safeExecute(function(){return i("RefreshMsbTokenAndCall:No Msb Token")},"MsbTokenManager::refreshLokiTokenAndCall:noTokenCallback"))},o.prototype.afterLokiAccountRefreshed=function(t,i){var r=this.getLokiToken();r?n.safeExecute(function(){return t()},"MsbTokenManager::refreshLokiTokenAndCall:callback - fetched token"):i&&n.safeExecute(function(){i("AfterLokiAccountRefreshed: No Loki token")},"MsbTokenManager::refreshLokiTokenAndCall:noTokenCallback")},o.prototype.handleLokiAccount=function(n){n&&n.Token&&this.setLokiAccount(n)},o.prototype.fetchMsbLokiAccount=function(t,i){var u=this,r,e=this.getMsbToken("fetchMsbLokiAccount");e||(_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch Loki Token No Msb Token"),i());var o={clientContext:{clientType:n.getClientType(n.Scope.Work)}},s=n.getMsbUrl("v3/user/token/Loki"),h="".concat(s,"?cvid=").concat((r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.context)===null||r===void 0?void 0:r.conversationId),c={url:h,requestType:"POST",body:JSON.stringify(o),checkServerTime:!0,onSuccess:function(r){var e=u.makeAccountInfo(r,f),o,s;e?t(e):(o="[MSB.Error] fetching loki token returns no token. response=".concat(JSON.stringify(r)),s=n.getIsMsbInternalTenant()?o:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch Loki Token Returns Invalid Response","",{additionalMessage:s}),i())},onError:function(t,r){if(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){var e=r.responseText,o=r.message,u=r.stackTrace,f=r.serverTraceId,s=r.requestSentTime,h=r.responseReceivedTime,c="[MSB.Error] fetching loki token has error, details=".concat(JSON.stringify({statusCode:t,responseText:e,message:o,stackTrace:u,serverTraceId:f})),l=n.getIsMsbInternalTenant()?c:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Loki Token Failed","",{stackTrace:u,serverTraceId:f,additionalMessage:l,statusCode:t},{ReqTS:s,ResTS:h})}i()}};n.Msb.sendAjax(c)},o.prototype.setLokiAccount=function(n){this._lokiAccount=n;(BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)&&(BingAtWork.wsb.wsbLokiAccessToken=n.Token)},o.prototype.callFetchLokiAccount=function(t){var i=this;this.fetchMsbLokiAccount(function(r){n.safeExecute(function(){i.handleLokiAccount(r);t()},"Calling handleLokiAccount")},function(){n.safeExecute(function(){t()},"Calling handleMsbAccount with null loki account")})},o.prototype.getTokenExpiry=function(t,i){var r=n.parseJwt(this._msbAccount.Token),u;return(r===null||r===void 0?void 0:r.exp)?(u=n.config.msbTokenExpirySafetyShiftInMins*6e4,(r===null||r===void 0?void 0:r.exp)*1e3-u):i},o.prototype.notifyWsbAadReady=function(){this._wsbAadReadyNotified||!n.isTenantMsbEnabled()||n.isGccHighTenant()||(this._wsbAadReadyNotified=!0,_w.postMessage({messageType:"BingAtWork:WsbAadReady",userId:this._userId,tenantId:this._tenantId},"*"))},o.prototype.callGetMsbAccount=function(t,i,r,u,f){var e=this;if(u=u&&__spreadArray(__spreadArray([],u,!0),["MsbTokenManager::callGetMsbAccount(caller=".concat(r,")")],!1),!this._accessTokenManager.isAadAvailable()&&!n.config.msbMockToken){n.setTenantMsbDisabledStatus();this.clearUserTenantContext();this._aadNotAvailableHandlers.forEach(function(t){setTimeout(function(){return n.safeExecute(function(){return t()},"MsbTokenManager::fireAadNotAvailable")},0)});i&&i(!1);return}n.config.msbForceRefreshToken&&(t=!0);typeof n.msbPerfLogger=="object"&&n.msbPerfLogger.mark(n.MsbPerfProbe.MsbTokenRequested,f);this._accessTokenManager.getAccount(1,n.config.msbDsbUseLocal?"ef47e344-4bff-4e28-87da-6551a21ffbe0":"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7",t,!0,function(t){typeof n.msbPerfLogger=="object"&&n.msbPerfLogger.mark(n.MsbPerfProbe.MsbTokenResponded,f);n.config.msbMockToken&&(t=e.getMsbMockAccount());(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbAuthFailed)&&(t=null);n.safeExecute(function(){e.handleMsbAccount(t,i,r,u)},"Calling handleMsbAccount")},undefined,u)},o.prototype.callFetch3sAccount=function(t){var i=this;this.fetchMsb3sAccount(function(r){n.safeExecute(function(){i.handleSubstrateAccount(r);t()},"Calling handleSubstrateAccount")},function(){n.safeExecute(function(){i.handleSubstrateAccount(null);t()},"Calling handleMsbAccount with null 3s account")})},o.prototype.handleMsbAccount=function(i,r,u,f){var o=this,s,e;if(f=f&&__spreadArray(__spreadArray([],f,!0),["MsbTokenManager::handleMsbAccount"],!1),s=i&&i.Token,e=this.getAadUserInfo(i),n.setAadUserInfo(e),this.updateTelemetryContext(e),e&&e.UserAadId&&this.trySendValueEvents(n.config.msbUseAccountBasedCache?t:n.LegacyAadUserIdKey,i===null||i===void 0?void 0:i.RoutingHint,{name:"LogAadUserId",value:u}),s){this.setMsbAccount(i);var c=this._tokenChanged,h=function(){o.handleMsbTokenChanged();r&&r(c)},l=function(){h()},a=function(n){(n===null||n===void 0?void 0:n.hasTokenIssue)&&(o._msbAccount=null,BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=undefined,BingAtWork.wsb.wsbAccessTokenWamExp=undefined,BingAtWork.wsb.wsbAccessTokenJwtExp=undefined));h()};this._msbAccountAvailableTenantSettingHandler?n.safeExecute(function(){return o._msbAccountAvailableTenantSettingHandler(l,a,u,o._msbAccount)},"MsbTokenManager::msbAccountAvailableTenantSettingHandler"):h()}else n.logAuthRelatedInfo("getAccountOnFailure","authenticate failed ".concat(f===null||f===void 0?void 0:f.join(" -> "))),this.setMsbAccount(null),n.setTenantMsbDisabledStatus(),r&&r(!1)},o.prototype.handleSubstrateAccount=function(t,i){i=i&&__spreadArray(__spreadArray([],i,!0),["MsbTokenManager::handleSubstrateAccount"],!1);var r=t&&t.Token;r?this.setSubstrateAccount(t):n.logAuthRelatedInfo("getAccountOnFailure","authenticate failed ".concat(i===null||i===void 0?void 0:i.join(" -> ")))},o.prototype.fetchMsb3sAccount=function(t,i){var f=this,e=this.getMsbToken("fetchMsb3sAccount");e||(_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token No Msb Token"),i());var o=n.getMsbUrl("v3/user/token/Substrate"),u=BingAtWork.context.conversationId,s="".concat(o,"?cvid=").concat(u),h={url:s,checkServerTime:!0,onSuccess:function(e){var s=f.makeAccountInfo(e,r),o,h;s?t(s):(o="[MSB.Error] fetching 3S token returns no token. response=".concat(JSON.stringify(e)),h=n.getIsMsbInternalTenant()?o:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token Returns Invalid Response","",{additionalMessage:h,cvid:u}),i())},onError:function(t,r){var h;if(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){var c=r.responseText,f=r.message,e=r.stackTrace,o=r.serverTraceId,l=r.requestSentTime,a=r.responseReceivedTime,s="[MSB.Error] fetching 3S token has error, details=".concat(JSON.stringify({statusCode:t,responseText:c,message:f,stackTrace:e,serverTraceId:o}));h=n.getIsMsbInternalTenant()?s:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch 3S Token Failed",f,{stackTrace:e,serverTraceId:o,additionalMessage:h,statusCode:t,cvid:u},{ReqTS:l,ResTS:a})}i()}};n.Msb.sendAjax(h)},o.prototype.makeAccountInfo=function(t,i){if(!t||!t.token||!t.tokenExpiry||!t.tenant||!t.tenant.id||!t.user||!t.user.id||!t.user.displayName)return undefined;var u=t.token,f=t.tokenExpiry,e=t.tenant.id,r=t.user,o=r.id,s=r.displayName;return{Token:u,ExpireDateTime:f-i,UserName:s,RoutingHint:"OID:".concat(e,":").concat(o),LastUpdated:n.getCurrentDate().getTime()}},o.prototype.setMsbAccount=function(t){var c=this._msbAccount&&this._msbAccount.Token,r=t===null||t===void 0?void 0:t.Token,u,f,i,s,h,e,o;this._msbAccount=t;!r||c==r||(this._tokenChanged=!0,BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=r,u=t.ExpireDateTime,BingAtWork.wsb.wsbAccessTokenWamExp=u,f=n.parseJwt(r),i=Number(f===null||f===void 0?void 0:f.exp)*1e3,i||(s="typeof(parsedToken)=".concat(typeof f,", typeof(jwtExp)=").concat(typeof i),h=n.isMsbInternalTenant()?"account=".concat(JSON.stringify(this._msbAccount)):undefined,bfbWsbTel.logError("Wsb WAM-JWT expiry no value",s,{additionalMessage:h})),BingAtWork.wsb.wsbAccessTokenJwtExp=i,BingAtWork.wsb.wsbAccessTokenRefreshTime=n.getCurrentTime(),e=i-u,e<0&&bfbWsbTel.logError("Wsb WAM-JWT expiry mismatch","RefreshTime=".concat(BingAtWork.wsb.wsbAccessTokenRefreshTime," WamExp=").concat(u,", JwtExp=").concat(i)),BingAtWork.wsb.gccRegion=!r?0:n.getGccRegion(r)),o=this.getTokenExpiry(r,this._msbAccount.ExpireDateTime),this._msbAccount.ExpireDateTime<o&&(this._msbAccount.ExpireDateTime=o))},o.prototype.setSubstrateAccount=function(n){this._substrateAccount=n;BingAtWork.wsb&&(BingAtWork.wsb.wsb3sAccessToken=n.Token)},o.prototype.sendMsbProactiveSignIn=function(t){var i,r=(i={},i["Content-Type"]="text/plain",i),u={Authentication:t},f=n.getMsbUrl("v3/user/proactive/signin");n.fetchUrl(f,r,JSON.stringify(u),function(){},undefined,undefined,!0,undefined,!0)},o.prototype.handleMsbTokenChanged=function(){if(this._tokenChanged&&n.isTenantMsbEnabled()){this._tokenChanged=!1;var t=this.getMsbToken();t&&(n.config.msbEnableProactiveSignin&&!n.isGccHighTenant()&&this.sendMsbProactiveSignIn(t),this._tokenChangedHandlers&&this._tokenChangedHandlers.forEach(function(i){n.safeExecute(function(){return i(t)},"MsbTokenManager::fireTokenChanged")}))}},o.prototype.handleWsbAccessTokenAvailable=function(t){var i=this;t==1&&(this._accountTypeChangedIsFiring||this.callGetMsbAccount(!1,function(t){i.notifyWsbAadReady();!t||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.isTest)||(n.Host.refreshCurrentPane(!0),n.config.msbVerticalWorkScopeEnabled&&n.Host.updateScopeList(!0));i.refresh3sTokenAndCall(function(){},undefined,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleWsbAccessTokenAvailable"]:undefined)},"WsbAccessTokenAvailable",(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleWsbAccessTokenAvailable"]:undefined))},o.prototype.handleAccountTypeChanged=function(){var t=this,i;this._accountTypeChangedIsFiring=!0;i=function(i){t.callGetMsbAccount(!0,function(){t.notifyWsbAadReady();t._accountTypeChangedIsFiring=!1;n.Host.refreshCurrentPane(!0);n.config.msbVerticalWorkScopeEnabled&&n.Host.updateScopeList(!0);t.refresh3sTokenAndCall(function(){},undefined,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleAccountTypeChanged"]:undefined)},i,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleAccountTypeChanged"]:undefined)};n.config.msbMockToken?this.getMockToken(function(){i("AccountTypesChanged_withMockToken")}):i("AccountTypesChanged")},o.prototype.handleWsbSelectedAccountChanged=function(){this._msbAccount=null;this._substrateAccount=null;this._lokiAccount=null;this._userId=null;this._tenantId=null},o.prototype.handleWsbVerifyAccountRequired=function(t,r){var f,u,e;switch(t){case 1:f="AAD";break;case 0:f="MSA";break;default:f="Unknown"}if(f!="MSA"){switch(r){case"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7":u="BingAtWork";break;case"https://www.bing.com/cortana":u="Cortana";break;case"https://graph.windows.net/":u="GraphWindowsApi";break;case"394866fc-eedb-4f01-8536-3ff84b16be2a":u="PeopleCard";break;case"https://outlook.office.com/":u="ProfilePictureApi";break;case"https://substrate.office.com":u="SubstrateEnterprise";break;case"service::cortana.bing.com::mbi_ssl":u="Cortana";break;case"LiveProfileCard.Access":u="PeopleCard";break;case"https://outlook.office.com/User.ReadWrite":case"https://outlook.office.com/M365.Access":u="ProfilePictureApi";break;case"https://substrate.office.com/SubstrateSearch-Internal.ReadWrite":case"https://substrate.office.com/M365.Access":u="SubstrateConsumer";break;default:u="Unknown"}e="".concat(f,"@").concat(u);this.trySendValueEvents(n.config.msbUseAccountBasedCache?i:n.LegacyWsbVerifyAccountRequiredKey,e,{name:"WsbVerifyAccountRequired",value:"",kv:{authType:f,resourceOrScope:u}})}},o.prototype.getAadUserInfo=function(n){var t=n===null||n===void 0?void 0:n.RoutingHint,i,r;return t&&t.startsWith("OID:")&&t.length==77?(i=t.substring(4,40),r=t.substring(41),{TenantId:r,TenantName:n.TenantName,UserAadId:i,email:n.UserName}):null},o.prototype.updateTelemetryContext=function(t){this._userId=t===null||t===void 0?void 0:t.UserAadId;this._tenantId=t===null||t===void 0?void 0:t.TenantId;_w.bfbWsbTel&&bfbWsbTel.setUid(this._userId);_w.bfbWsbTel&&bfbWsbTel.setTenantId(this._tenantId);n.checkAndSetIsMsbInternalTenant(this._tenantId)},o.prototype.clearUserTenantContext=function(){_w.bfbWsbTel&&bfbWsbTel.setUid(null);_w.bfbWsbTel&&bfbWsbTel.setTenantId(null);n.checkAndSetIsMsbInternalTenant(null)},o.prototype.isThrottledLogInfoExpired=function(t,i){var f=n.LightweightStorage.getItem(i),r=this.parseCachedLogInfo(f),u;return r==null?!0:r.LogKey!=t?!0:(u=n.config.msbLogThrottlingTimeInHours*36e5,n.getCurrentTime()>r.SavedTimestamp+u)?!0:!1},o.prototype.parseCachedLogInfo=function(n){var t=n&&n.split(";");return!t||t.length!=2?null:{LogKey:t[1],SavedTimestamp:+t[0]}},o.prototype.trySendValueEvents=function(t,i,r){if(this.isThrottledLogInfoExpired(i,t)){_w.bfbWsbTel&&r&&bfbWsbTel.logValue(r.name,r.value,r.kv);var u="".concat(n.getCurrentTime(),";").concat(i);n.LightweightStorage.setItem(t,u)}},o.prototype.getMsbMockAccount=function(){var t=n.getCurrentTime();return{Token:this._mockToken,ExpireDateTime:t+36e5,RoutingHint:"OID:65e1aedd-5fe9-4100-8b57-7973687b78c4@72f988bf-86f1-41af-91ab-2d7cd011db47",UserName:"msbtest",TenantName:"Microsoft",LastUpdated:t}},o.prototype.getMockToken=function(t){var i=this,r=n.config.msbMockTokenUrl;n.fetchUrl(r,undefined,undefined,function(n){if(n.status===200){try{i._mockToken=JSON.parse(n.responseText)}catch(r){i._mockToken=null}t()}else i._mockToken=null,t()},undefined,undefined,!0)},o}();n.MsbTokenManager=o}(WSB||(WSB={})),function(n){var t,i=(t={},t.Person="People",t.Group="Group",t.Bookmark="Bookmark",t.Building="Building",t.Qna="EditorialQnA",t.File="File",t),r=function(){function t(n){this._msbTokenManager=n}return t.prototype.getTenantSetting=function(t,i){var r=this;this._msbTokenManager.refreshMsbTokenAndCall(function(){r.fetchTenantSettings(t,i)},function(){i(n.ClientErrorCode.RefreshTokenFailure,{message:"MsbDataAccess.getTenantSetting"})})},t.prototype.fetchTenantSettings=function(t,i){var r=n.getMsbUrl("v2/tenant/my/settings"),u={url:r,checkServerTime:!0,onSuccess:t,onError:i};n.Msb.sendAjax(u)},t.prototype.fetchServerSuggestion=function(t,i,r,u){var f={query:t,count:i,domains:r,clientContext:{clientType:"Wsb"}},e=JSON.stringify(f),o=n.getMsbUrl("v3/suggestions"),s={url:o,requestType:"POST",body:e,onSuccess:function(n){u(n&&n.results)},onError:function(){u([])}};n.Msb.sendAjax(s)},t.prototype.fetchSearchResponse=function(t,i,r,u,f){var e=this;this._msbTokenManager.refresh3sTokenAndCall(function(){e.fetchMsb3sQueryResponse(t,i,r,u,f)},function(){_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane No Msb 3s Token","");u()},(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbDataAccess::fetchSearchResponse"]:undefined)},t.prototype.fetchMsb3sQueryResponse=function(t,i,r,u,f){var e,o,h=this,s,a=(e={},e[0]=n.config.msb3sQueryUrl,e[1]=n.config.msb3sQueryUrl,e[2]=n.config.msbUsGov3sQueryUrl,e),v=((s=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||s===void 0?void 0:s.gccRegion)?a[BingAtWork.wsb.gccRegion]:n.config.msb3sQueryUrl,c=this.buildMsb3sQueryRequest(t,i),y=JSON.stringify(c),l;this.fireResetSearchOptions(f);l={url:v,useToken:"WSB3S",requestType:"POST",body:y,onSuccess:function(f,e){var o,s;f?h.is3sResponseEmpty(f,i)?(o="[MSB.Error] fetchMsb3sQueryResponse received empty searchResponse or searchResponse.results for query ".concat(t),s=n.getIsMsbInternalTenant()?o:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Search Response Empty Results","",{serverTraceId:e,additionalMessage:s}),u()):r(f,c):(o="[MSB.Error] fetchMsb3sQueryResponse received empty response for query ".concat(t," of intent ").concat(i),_w.bfbWsbTel&&bfbWsbTel.logError("Wsb 3S Query Response is Empty","",{serverTraceId:e}),u())},onError:function(r,f){var e=f.responseText,o=f.message,a=f.errorMessage,s=f.stackTrace,h=f.serverTraceId,v=f.requestSentTime,y=f.responseReceivedTime,p="[MSB.Error] fetchMsb3sQueryResponse failed, details=".concat(JSON.stringify({queryText:t,intent:i,statusCode:r,responseText:e,message:o,stackTrace:s,serverTraceId:h})),c,l;(r!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest)&&(c=n.getIsMsbInternalTenant()?"Query: ".concat(t,", intent: ").concat(i,", responseText: ").concat(e,", errorMEssage: ").concat(a):"",l=n.getIsMsbInternalTenant()?s:"",_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Search Response Failed",o,{stackTrace:l,serverTraceId:h,statusCode:r,additionalMessage:c},{ReqTS:v,ResTS:y}));u()},onRoundTripReport:function(n){h.fireRoundTripTime("SubstrateSearch_RoundTripTime",n)},headers:(o={},o["X-Client-LocalTime"]=n.getDateWithTimezone(),o)};n.Msb.sendAjax(l)},t.prototype.getPersonPhotoData=function(n,t,i){var r=this;this._msbTokenManager.refreshMsbTokenAndCall(function(){return r.fetchPersonPhotoData(n,t,i)},function(){i(null)})},t.prototype.fetchPersonPhotoData=function(t,i,r){var u="",f="",e={},o="GET",s=t.indexOf("@")>-1,h=i?n.getMsbUrl("v3/search/person/photo"):n.getMsbUrl("v3/search/group/photo"),c,l,a;s?(u=h,o="POST",c={clientContext:{clientType:"Wsb"},id:t},f=JSON.stringify(c)):(l="clientType=Wsb&id=".concat(t),u="".concat(h,"?").concat(l),e.Accept="application/json");a={url:u,requestType:o,body:f,headers:e,onSuccess:function(n){var t=n&&(n.imageInBase64||n.ImageInBase64);t?r("data:image/jpeg;base64,".concat(t)):r(null)},onError:function(t,u){var h=u.responseText,f=u.message,c=u.stackTrace,e=u.serverTraceId,l=u.requestSentTime,a=u.responseReceivedTime,o="[MSB.Error] fetching person/group photo, details=".concat(JSON.stringify({statusCode:t,responseText:h,message:f,stackTrace:c,serverTraceId:e}));if(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){var v=n.getIsMsbInternalTenant()?o:"",y=i?"Wsb Fetch Person Photo Failed":"Wsb Fetch Group Photo Failed",p=s?"ByEmail":"ById";_w.bfbWsbTel&&bfbWsbTel.logHttpError(y,"".concat(p,"-").concat(f),{serverTraceId:e,additionalMessage:v,statusCode:t},{ReqTS:l,ResTS:a})}r(null)}};n.Msb.sendAjax(a)},t.prototype.fireResetSearchOptions=function(t){var i,r,u={messageType:"MSB_RESET_SEARCH_OPTIONS",payload:{wsbIG:(i=window===null||window===void 0?void 0:window._G)===null||i===void 0?void 0:i.IG,wsbCvid:n.Host.getConversationId(),wsbLogicalId:(r=window===null||window===void 0?void 0:window._G)===null||r===void 0?void 0:r.IG,clientType:n.getClientType(t)}};n.safeExecute(function(){window.postMessage(u,window.location.origin)},"fireResetSearchOptions")},t.prototype.fireSearchResponse=function(t,i,r){var u=this.buildMsb3sQueryRequest(t),f=n.Host.createGuid(),e={messageType:"MSB_SET_3S_QUERY_RESPONSE",payload:{requestId:f,request:u,response:r,queryText:i}};n.safeExecute(function(){window.postMessage(e,window.location.origin)},"fireSearchResponse")},t.prototype.fireClientQfResponse=function(t,i,r){this.fireResetSearchOptions(r);var u=i,f=this.buildMsb3sQueryRequest(t),e={messageType:"MSB_SET_CLIENT_QF_RESPONSE",payload:{request:f,response:u}};n.safeExecute(function(){window.postMessage(e,window.location.origin)},"fireClientQfResponse")},t.prototype.fireRoundTripTime=function(t,i){var r=Object.assign({eventId:t},i),u;u={messageType:"MSB_SEARCH_RTT",payload:r};n.safeExecute(function(){window.postMessage(u,window.location.origin)},"fireRoundTripTime")},t.prototype.buildMsb3sQueryRequest=function(t,r){var u,f,e=i[r],o=e!=null?[e]:[];switch(r){case"File":return{Cvid:n.Host.getConversationId(),LogicalId:(u=window===null||window===void 0?void 0:window._G)===null||u===void 0?void 0:u.IG,EntityRequests:[{Query:{QueryString:t,DisplayQueryString:t},ContentSources:["SharePoint","OneDriveBusiness"],EntityType:e,From:0,Size:1}],Scenario:{Name:"Wsb.PreviewPane"},TextDecorations:"Off"};default:return{Cvid:n.Host.getConversationId(),LogicalId:(f=window===null||window===void 0?void 0:window._G)===null||f===void 0?void 0:f.IG,AnswerEntityRequests:[{Query:{QueryString:t},EntityTypes:o,From:0,Size:1}],Scenario:{Name:"Wsb.PreviewPane"},TextDecorations:"Off"}}},t.prototype.is3sResponseEmpty=function(n,t){var i,r;return t==="File"?(i=n,!i.EntitySets||i.EntitySets.length===0):(r=n,!r.AnswerEntitySets||r.AnswerEntitySets.length===0)},t}();n.MsbDataAccess=r}(WSB||(WSB={})),function(n){function yt(t){switch(t.cacheState){case n.CacheState.Empty:return b;case n.CacheState.Error:return nt;case n.CacheState.Expired:return g;case n.CacheState.Invalid:return d;case n.CacheState.NoResults:return k;default:return ut}}function t(){var t,u;return{domainOptions:(t={},t.Person={spaceInTheMiddleRequired:!1,minimumMatchCount:n.config.msbMinMatchPerson||i},t.Bookmark={minimumMatchCount:n.config.msbMinMatchBookmark||i},t.Building={minimumMatchCount:n.config.msbMinMatchBuilding||i},t.Group={minimumMatchCount:n.config.msbMinMatchGroup||i},t.Qna={minimumMatchCount:n.config.msbMinMatchQna||i},t.File={minimumMatchCount:n.config.msbMinMatchFile||i},t),ignoreChars:"parenDash",domainTriggerOptions:(u={},u.Person={minimumMatchCount:n.config.msbTGOMinMatchPerson||r},u.Bookmark={minimumMatchCount:n.config.msbTGOMinMatchBookmark||r},u.Building={minimumMatchCount:n.config.msbTGOMinMatchBuilding||r},u.Group={minimumMatchCount:n.config.msbTGOMinMatchGroup||r},u.Qna={minimumMatchCount:n.config.msbTGOMinMatchQna||r},u.File={minimumMatchCount:n.config.msbTGOMinMatchFile||r},u)}}function h(){var i=t().domainOptions,n=Number.MAX_VALUE;for(var r in i)n=i[r].minimumMatchCount<n?i[r].minimumMatchCount:n;return{minimumQueryLength:n}}function pt(t){return t.isSearchHomeZI?n.getIsMsbEduTenantEnabled()&&n.config.msbQwsEnabledInEdu?vt:at:!n.isL2(t)||n.config.msbNewWorkScopeEnabled&&n.isMsbWorkScope(null,t===null||t===void 0?void 0:t.scope)?n.isMsbFileReady()&&!n.config.msbQfNoFile?st:ot:t.scope===n.Scope.People?ht:t.scope===n.Scope.Web?ct:t.scope===n.Scope.Documents?lt:undefined}function c(t){var i=["Person","Bookmark","Group","Qna"];return n.config.msbDisableBuilding||i.push("Building"),t&&i.push("File"),i}function wt(){switch(n.config.msbQwsDomains){case 0:return["Person","Bookmark"];case 2:return["Bookmark"];case 1:return["Person"];default:return["Person","Bookmark"]}}function bt(){return n.config.msbQwsEnablePeopleInEdu?["Person","Bookmark"]:["Bookmark"]}function kt(){var t=["Bookmark","Qna"];return n.config.msbDisableBuilding||t.push("Building"),t}function dt(){return["File"]}function gt(n){return n.length>0&&(n.toLowerCase()==="cancelled"||n.toLowerCase()==="time out")?n:"unknown"}function l(n){return n.length>1&&n[1].eventSource?n[1].eventSource:""}function ni(n){var t=n.length>1?n[1].returnStatus:"";return t!==undefined?t:""}function a(n){return n.length>1&&n[1].timestamp?n[1].timestamp:""}var v="CS",y="NE",u="MAAD",p="VAAD",w="NQO",b="EREC",k="ERNC",d="ERIC",g="ERCX",nt="ERCE",tt="GSF",it="EXSF",rt="ZQSF",ut="ZQUE",i=6,r=6,f="msb:qf:atrdy",ft="msb:qf:sydoc",et="msb:qf:sydoc:fail",e="msb:qf:dld",o="msb:qf:trs",s="msb:qf:trf",ot={suggestionConfidenceOptions:t(),serverSuggestionOptions:h(),domains:c(),count:n.config.msbQfResultsCountL1,scope:"All"},st={suggestionConfidenceOptions:t(),serverSuggestionOptions:h(),domains:c(!0),count:n.config.msbQfResultsCountL1ForFile,scope:"All"},ht={suggestionConfidenceOptions:t(),domains:["Person","Group"],count:n.config.msbQfResultsCountL2,scope:"People"},ct={suggestionConfidenceOptions:t(),domains:kt(),count:n.config.msbQfResultsCountL2,scope:"Web"},lt={suggestionConfidenceOptions:t(),domains:dt(),count:n.config.msbQfResultsCountL2,scope:"Documents"},at={suggestionConfidenceOptions:t(),domains:wt(),count:n.config.msbQfResultsCountQws,dynamicRanking:n.config.msbEnableQwsDynamicRanking},vt={suggestionConfidenceOptions:t(),domains:bt(),count:n.config.msbQfResultsCountQws,dynamicRanking:n.config.msbEnableQwsDynamicRanking},ti=6048e5,ii=function(){function t(t,i){var r=this,u,y,p,h,c,v,w;this._dataSource=t;this._msbTokenManager=i;this._tokenChangedFired=!1;this._clientQfReadyFired=!1;this._clientQfTokenReady=!1;this._clientQfInitTime=0;this._accountChanging=!1;this._logId="".concat(this.getName(),"[").concat(this._dataSource,"]");this._msbDataModule=_w.BingAtWork;n.clearIsMsbClientQfTokenReady();n.Host.bindAccountChanged(function(){r._accountChanging=n.config.msbEnableMultiAad?!0:!1;n.setQuickWorkSearchCache(null);n.clearQuickWorkSearchPersonImageCache()});this._msbTokenManager.bindTokenChanged(function(){r._tokenChangedFired=!0;r.updateClientQfAccessToken()});u=function(){r._clientQfReadyFired=!0;r.updateClientQfAccessToken();sj_evt.unbind(f,u)};sj_evt.bind(f,u,!0,null,!0);y=function(t){var i=l(t);n.setClientQfSyncDocEventFired(!0,i)};sj_evt.bind(ft,y,!0,null,!0);p=function(t){var i=l(t);n.setClientQfSyncDocEventFired(!1,i)};sj_evt.bind(et,p,!0,null,!0);h=function(t){var i=a(t);n.setClientQFTrieRefreshStartedEventFired(i);sj_evt.unbind(o,h)};sj_evt.bind(o,h,!0,null,!0);c=function(t){var i=ni(t),r=a(t);n.setClientQFTrieRefreshFinishedEventFired(i,r);sj_evt.unbind(s,c)};sj_evt.bind(s,c,!0,null,!0);v=function(){r.setLogClintQFDelay();sj_evt.unbind(e,v)};sj_evt.bind(e,v,!0,null,!0);n.config.msbQwsCleanCache&&(w=n.config.msbUseAccountBasedCache?n.MsbQuickWorkSearchCacheStorageKey:n.LegacyQuickWorkSearchCacheStorageKey,n.LightweightStorage.removeItemsWithKeyPrefix(w))}return t.prototype.getName=function(){return"MsbClientQfDataProvider"},t.prototype.fetch=function(t,i,r,f,e){var b,nt,tt,o,c,s,l,h,d,it,a,g;if(nt=this.checkAllowedAadUser(),n.config.msbEnableDeltaSync&&n.isMsbFileEnabled()&&n.isClientQfReady()&&t.isSearchHomeZI&&this._clientQfTokenReady&&!this._accountChanging&&this.initDeltaSyncCall(),!n.isDataSourceEnabled(this._dataSource,t)){n.isAuthLogEnabled()&&t.isSearchHomeZI&&n.enableQws()&&(tt=n.shouldForceEnterpriseAccount()?n.getIsMsbClientQfTokenReady()?"No cached result":"Token not ready":"Not force enterprise account",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search data source disabled",tt));return}if(!n.isSubstrateO365AccountConnected&&!n.config.msbMockToken){n.setQuickWorkSearchCache(null);n.clearQuickWorkSearchPersonImageCache();i(this._dataSource,null,p);return}if(n.config.msbEnableMultiAad&&this._accountChanging){this._accountChanging=!1;i(this._dataSource,null,u);return}if(!n.config.msbEnableMultiAad&&!nt){_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search disabled from multiAad","Not allowedAadUser");i(this._dataSource,null,u);return}if(o={isCachedResultsReturned:!1},s=function(r,u,f,e,o,s){if(t.isSearchHomeZI)try{var h=u,l=(h===null||h===void 0?void 0:h.length)>0;typeof n.msbPerfLogger=="object"&&n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryReturned,c);n.incrementQwsAggregateSuccessRate(l)}catch(a){n.incrementQwsAggregateSuccessRate(!1)}i(r,u,f,e,o,s)},t.isSearchHomeZI&&n.enableQwsCache()&&!(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbSHNoClientQf))if(typeof n.msbPerfLogger=="object"&&(typeof this._lastShZiPerfMarkCallId=="undefined"&&(this._lastShZiPerfMarkCallId=0),c=this._lastShZiPerfMarkCallId++,n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryStarted,c)),l=n.getQuickWorkSearchCache(),l){h=void 0;try{h=JSON.parse(l)}catch(k){d="[MSB.Error]  ".concat(this._logId,".fetch: QWS cache is broken.\n                            cacheString=").concat(l,",\n                            error.message=").concat(k===null||k===void 0?void 0:k.message);a=n.getIsMsbInternalTenant()?d:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search cache broken","",{additionalMessage:a});o.cacheState=n.CacheState.Error;n.setQuickWorkSearchCache(null)}h?n.getCurrentTime()-h.lastUpdatedTime<ti?(it=((b=h.results)===null||b===void 0?void 0:b.length)>0,it?(s(this._dataSource,h.results,null),o.isCachedResultsReturned=!0,o.cacheState=n.CacheState.ValidResults):(o.cacheState=n.CacheState.NoResults,n.isAuthLogEnabled()&&_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work return empty suggestions from cache"))):(o.cacheState=n.CacheState.Expired,n.setQuickWorkSearchCache(null)):o.cacheState!=n.CacheState.Error&&(o.cacheState=n.CacheState.Invalid)}else o.cacheState=n.CacheState.Empty;if(!n.isTenantMsbEnabled()){o.isCachedResultsReturned||(t.isSearchHomeZI&&n.isAuthLogEnabled()&&_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search tenant not enabled",o.cacheState),s(this._dataSource,null,y));return}if(!(n.isClientQfReady()&&(this._clientQfTokenReady||n.isMsbQfInScriptsEarlyLoadState())||n.MockUrlParameters)){o.isCachedResultsReturned||(s(this._dataSource,null,v),n.isAuthLogEnabled()&&(a=t.isSearchHomeZI?"SearchHome":"NotSearchHome",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb no suggestions in cold start",o.cacheState,{additionalMessage:a})));return}if(g=pt(t),!g){o.isCachedResultsReturned||s(this._dataSource,null,w);return}this._clientQfTokenReady&&this._msbTokenManager.refreshMsbTokenAndCall(function(){},undefined,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbClientQfDataProvider::fetch"]:undefined);this.fetchSuggestionsWithServerBackfill(t,s,e,g,o,c)},t.prototype.fetchSuggestionsWithServerBackfill=function(t,i,r,u,f,e){var o=this,s={isFirstStageProcessed:!1,enoughSuggestionsReceived:!1};t.isSearchHomeZI?n.MockUrlParameters&&typeof n.MockQwsResponse=="object"?this.processClientQwsResponse(n.MockQwsResponse,i,r,f):(typeof n.msbPerfLogger=="object"&&n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryRequested,e),this._msbDataModule.getZeroQfSuggestions(function(t){if(typeof n.msbPerfLogger=="object"&&n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryResponded,e),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbSHNoClientQf)&&(t=[]),n.enableQwsCache()){if(f.isCachedResultsReturned||o.processClientQwsResponse(t,i,r,f),t.length>0){var u={results:t,lastUpdatedTime:n.getCurrentTime()};n.setQuickWorkSearchCache(JSON.stringify(u))}}else o.processClientQwsResponse(t,i,r,f)},function(t){var u=JSON.stringify(t),e;e=n.getIsMsbInternalTenant()?u:gt(u);_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search fetch threw error",f.cacheState,{additionalMessage:e});f.isCachedResultsReturned||o.processClientQwsResponse([],i,r,f,!0)},u)):(this._msbDataModule.getExtraSuggestions(t.queryToFetch,function(n){o.processClientQfResponseTwoStage(t,n,i,s,r,u)},function(n){o.processClientQfResponseTwoStage(t,[],i,s,r,u,it)}),this._msbDataModule.getSuggestions(t.queryToFetch,function(n){o.processClientQfResponseTwoStage(t,n,i,s,r,u)},function(n){o.processClientQfResponseTwoStage(t,[],i,s,r,u,tt)},u))},t.prototype.processClientQfResponseTwoStage=function(t,i,r,u,f,e,o){var s=n.enableWaitForBackfill(t===null||t===void 0?void 0:t.scope),h;f()&&!u.enoughSuggestionsReceived&&(!u.isFirstStageProcessed||s)&&(i||(i=[]),u.enoughSuggestionsReceived=e.count&&i.length>=e.count,h=!(u.enoughSuggestionsReceived||u.isFirstStageProcessed||!s),r(this._dataSource,i,o,0,!1,h),u.isFirstStageProcessed=!0)},t.prototype.processClientQwsResponse=function(t,i,r,u,f){if(r()){t||(t=[]);var e=null;t.length===0&&(e=f?rt:yt(u),n.isAuthLogEnabled()&&_w.bfbWsbTel&&!f&&bfbWsbTel.logError("Wsb quick work search return empty suggestions",u.cacheState));i(this._dataSource,t,e,0,!1,!1)}},t.prototype.setLogClintQFDelay=function(){var t=n.getCurrentTime()-this._clientQfInitTime;n.isClientQFDelayLogEnabled()&&bfbWsbTel.logValue("ClientQFDelay",t)},t.prototype.updateClientQfAccessToken=function(){var i=this,t;this._clientQfInitTime==0&&(this._clientQfInitTime=n.getCurrentTime());this._tokenChangedFired&&this._clientQfReadyFired&&n.isTenantMsbEnabled()&&(t=this._msbTokenManager.getMsbToken(),t&&this._msbDataModule.setAccessToken(t,function(){i._clientQfTokenReady=!0;n.setIsMsbClientQfTokenReady(!0)},function(n){}))},t.prototype.initDeltaSyncCall=function(){this._msbDataModule.initDeltaSyncCall(!1,function(){},function(n){})},t.prototype.checkAllowedAadUser=function(){return!this._allowedAadId&&n.isTenantMsbEnabled()?(this._allowedAadId=this._msbTokenManager.getSelectedAccountId(),!0):this._allowedAadId==this._msbTokenManager.getSelectedAccountId()},t}();n.MsbClientQfDataProvider=ii}(WSB||(WSB={}));__spreadArray=this&&this.__spreadArray||function(n,t,i){if(i||arguments.length===2)for(var r=0,f=t.length,u;r<f;r++)!u&&r in t||(u||(u=Array.prototype.slice.call(t,0,r)),u[r]=t[r]);return n.concat(u||Array.prototype.slice.call(t))},function(n){function u(t){return"".concat(n.PersonIconCacheStorageKeyPrefix,"_").concat(t)}function p(n,t){t(y)}var t,i=n.mapOSFormCode("BFBWSL"),r=n.mapOSFormCode("WSBWS0"),f=1,s=.6,h=2,c=4,e=/[0-9a-zA-Z]/,l=/\s+/g,o=(t={},t.Person="MPPL",t.Group="MGRP",t.Bookmark="MBKS",t.Building="MBLD",t.Qna="MQNA",t.File="MFIL",t),a=6048e5,v=25,y={type:0,className:"msb-suggIcon",content:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDQ4IDIwNDgiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+DQogIDxwYXRoIGQ9Ik0xNzYyIDE1OTBxNjYgMzIgMTE4IDgwdDkwIDEwOCA1OCAxMjggMjAgMTQyaC0xMjhxMC03OS0zMC0xNDl0LTgzLTEyMi0xMjItODItMTQ5LTMxcS03OSAwLTE0OSAzMHQtMTIyIDgzLTgyIDEyMi0zMSAxNDloLTEyOHEwLTczIDIwLTE0MXQ1Ny0xMjggOTAtMTA4IDExOS04MXEtNzUtNTQtMTE2LTEzNXQtNDItMTc1cTAtNzkgMzAtMTQ5dDgyLTEyMiAxMjItODMgMTUwLTMwcTc5IDAgMTQ5IDMwdDEyMiA4MiA4MyAxMjMgMzAgMTQ5cTAgOTMtNDEgMTc0dC0xMTcgMTM2em0tMjI2LTU0cTUzIDAgOTktMjB0ODItNTUgNTUtODEgMjAtMTAwcTAtNTMtMjAtOTl0LTU1LTgyLTgxLTU1LTEwMC0yMHEtNTMgMC05OSAyMHQtODIgNTUtNTUgODEtMjAgMTAwcTAgNTMgMjAgOTl0NTUgODIgODEgNTUgMTAwIDIwem01MTItMTQwOHYxMDI0cTAtNDgtOS04NHQtMjUtNjctNDAtNjAtNTQtNjNWMjU2SDEyOHYxMTUyaDI1NnYyNjdsMjY3LTI2N2gzOTBxOCAzNCAyMSA2NnQzMSA2Mkg3MDRsLTQ0OCA0NDh2LTQ0OEgwVjEyOGgyMDQ4eiIgLz4NCjwvc3ZnPg=="},w=function(){function t(n){this._msbDataAccess=n;this.bookmarkIcon={content:"&#xEB8F",type:2};this.locationIcon={content:"&#xECAF",type:2}}return t.prototype.parse=function(t,i,r,u,f,e){var s,o,h;if(n.isDataSourceEnabled(r,t)){if(!u||u.length<1){e(r,[],null);return}s=this.pickUpClientQfResults(t,u);o=this.createClientQfSuggestionsFor(t,i,s);t.isSearchHomeZI&&t.scope===n.Scope.All&&(o===null||o===void 0?void 0:o.length)>0&&(h=this.getSHComponents(o),_w.bfbWsbTel&&bfbWsbTel.logSearchHomeImpression(h));e(r,o,null)}},t.prototype.getSHComponents=function(n){var t=[];return n.findIndex(function(n){return n.msbDomain==="Person"})>-1&&t.push("People"),n.findIndex(function(n){return n.msbDomain==="Bookmark"})>-1&&t.push("Bookmarks"),t.join("_")},t.prototype.setRankingValues=function(n,t,i){n.suggestionLogMeta='40000:"'.concat(t,'";40001:"').concat(i,'"')},t.prototype.createMsbSuggestion=function(t,i,r,u,f,e,s,h,c,l,a,v){var d,nt=this,w=o[s],tt=t.isSearchHomeZI?i:HitHighlightingParser.addMarkers(i,t.originalQuery),y=n.createSuggestion(t,tt,u,f,w,i,n.InstrumentedItem.createInstrumentedItem(e,w),17,e,!0),p,g,b,k;r&&(y.autoOpenPreviewPaneWhenOnTopHit=!0,y.allowedInGroups=!0);c&&(y.primaryMetadata=c);y.previewCallback=a;y.click=this.isQwsRequerysEnabled(t)?function(){nt.reformulateOnQwsSuggestionClick(t,i,s)}:v;y.msbDomain=s;y.msbId=h;y.reactKey=w+s+h;(d=y.classNames).push.apply(d,l);p=t.scope===n.Scope.Work;switch(w){case"MPPL":n.isL2(t)&&(y.sourceForGroup=6);!this.isWorkQFGroupHeaderLabelEnabled()||p||t.isSearchHomeZI||(y.groupDisplayName=this.setWorkQFGroupHeaderLabel(n.SubstrateTenantName,n.getScopeDisplayName(n.ScopeConfig[n.Scope.People])));t.isSearchHomeZI&&n.qwsShowTopList()&&this.adjustPersonName(y);break;case"MGRP":this.isWorkQFGroupHeaderLabelEnabled()&&!p&&(y.groupDisplayName=this.setWorkQFGroupHeaderLabel(n.SubstrateTenantName,n.getScopeDisplayName(n.ScopeConfig[n.Scope.People])));n.isL2(t)&&(y.sourceForGroup=5,p&&(y.groupDisplayName=n.Host.getLocString("MsbVerticalChildGroups")));break;case"MFIL":g=n.getScopeDisplayName(n.ScopeConfig[n.Scope.Documents]);b=n.SubstrateTenantName||"";y.sourceForGroup=7;y.groupDisplayName=this.isWorkQFGroupHeaderLabelEnabled()&&!p?this.setWorkQFGroupHeaderLabel(b,n.getScopeDisplayName(n.ScopeConfig[n.Scope.Documents])):p?n.Host.getLocString("MsbVerticalChildFiles"):g+" - "+b;break;default:t.isSearchHomeZI||(k=n.SubstrateTenantName||"",y.groupDisplayName=this.isWorkQFGroupHeaderLabelEnabled()&&!p?this.setWorkQFGroupHeaderLabel(k,n.Host.getLocString("ResultsList")):n.Host.getLocString("TenantBookmarksGroup",k))}return y},t.prototype.setWorkQFGroupHeaderLabel=function(t,i){return((!t||t&&t.length>v&&n.config.msbHeaderLabelGroupTruncation)&&(t=n.getIsMsbEduTenantEnabled()?n.Host.getLocString("School"):n.Host.getLocString("Work")),n.config.msbHeaderLabelGroupTypePrefix)?i+" - "+t:t+" - "+i},t.prototype.isWorkQFGroupHeaderLabelEnabled=function(){return n.config.msbHeaderLabelGroupTypePrefix||n.config.msbHeaderLabelTenantSourcePrefix},t.prototype.createGetPersonIcon=function(t,i,r,f){var e=this;return function(o,s){var l=!1,c,h,y,p;if(c=n.LightweightStorage.getItem(u(t)),c){h=void 0;try{h=JSON.parse(c)}catch(v){y="[MSB.Error] MsbQfSuggestionsParser.createGetPersonIcon: Person icon cache is broken.\n                            uid=".concat(t,",\n                            cacheString=").concat(c,",\n                            error.message=").concat(v===null||v===void 0?void 0:v.message);p=n.getIsMsbInternalTenant()?y:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb person icon cache broken","",{additionalMessage:p});n.LightweightStorage.removeItem(u(t))}h&&(n.getCurrentTime()-h.lastUpdatedTime<a?(s(h.data),l=!0):n.LightweightStorage.removeItem(u(t)))}l&&f||e._msbDataAccess.getPersonPhotoData(t,i,function(i){var f=r,e;i&&(f=n.toIcon(i,"createGetPersonIcon"),e={data:f,lastUpdatedTime:n.getCurrentTime()},t.indexOf("@")>-1&&n.LightweightStorage.setItem(u(t),JSON.stringify(e)));l||s(f)})}},t.prototype.getDefaultIcon=function(n){var t,i=n.trim().replace(l," ").split(" ",2),r,u;return i.length>0&&(r=i[0][0],e.test(r)&&(t=r),i.length==2&&(u=i[1][0],t&&e.test(u)?t+=u:t="")),{type:t?5:2,content:t?t.toUpperCase():"&#xE77B",className:"peopleIcon"}},t.prototype.pickUpClientQfResults=function(t,i){for(var r,v,o,u,e=!1,y=0,d=n.isL2(t),g=n.isMsbWorkScope(null,t===null||t===void 0?void 0:t.scope),p=[],l=[],w=[],b={},a=0,k=i;a<k.length;a++)(r=k[a],t.isSearchHomeZI&&r.domain==="Person"&&(y>=c||n.getIsMsbEduTenantEnabled()&&!n.config.msbQwsEnablePeopleInEdu))||(r.domain!=="Group"||r.identifiers!=null&&r.identifiers.uniqueName!=null)&&(r.domain!=="File"||r.identifiers.url!=null||r.identifiers.webUrl!=null)&&(r.confidence==="High"?(e=!0,v=!b[r.domain],u={msbSuggestion:r,isHero:(!d||g)&&v,score:f},b[r.domain]=!0,v?p.push(u):w.push(u)):(e||r.confidence==null||(e=!0),u={msbSuggestion:r,isHero:!1,score:s},l.push(u)),r.domain==="Person"&&y++);if(!e)for(o=0;o<h;o++)u=l[o],u&&(u.isHero=!0,u.score=f);return __spreadArray(__spreadArray(__spreadArray([],p,!0),w,!0),l,!0)},t.prototype.createClientQfSuggestionsFor=function(n,t,i){for(var u,f,e=[],r=0;r<i.length;r++)u=i[r],f=this.buildClientQfSuggestion(n,t,u),this.setRankingValues(f,r,u.score),e.push(f);return e},t.prototype.buildClientQfSuggestion=function(t,u,f){var a=this,e=f.msbSuggestion,it=f.isHero,v=e.query,y=e.query,k=t.isSearchHomeZI,w=t.scope===n.Scope.Work,l=undefined,s=undefined,b=["fbig"],h=undefined,d,o,tt,c;switch(e.domain){case"Bookmark":s=this.bookmarkIcon;d=e.identifiers;h=function(){_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(e.domain);n.Host.launchUri(d.url)};break;case"Person":o=this.getDefaultIcon(v);l=this.createGetPersonIcon(e.id,!0,o,k);s=o;b.push("msb-people");h=function(){var t=e.identifiers;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(e.domain);n.buildBfbSearchUrlAsync(n.config,y,"Person",t.uniqueName,w?r:i).then(function(t){return n.Host.launchUri(t)})};break;case"Group":o=this.getDefaultIcon(v);l=this.createGetPersonIcon(e.id,!1,o,k);s=o;b.push("msb-people");h=function(){var t=e.identifiers;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(e.domain);n.buildBfbSearchUrlAsync(n.config,y,"Group",t.uniqueName,w?r:i).then(function(t){return n.Host.launchUri(t)})};break;case"Building":s=this.locationIcon;h=function(){_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(e.domain);n.buildBfbSearchUrlAsync(n.config,y,"Building",undefined,w?r:i).then(function(t){return n.Host.launchUri(t)})};break;case"Qna":o=this.getDefaultIcon(v);l=p;s=o;h=function(){_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(e.domain);n.buildBfbSearchUrlAsync(n.config,y,"Qna",undefined,w?r:i).then(function(t){return n.Host.launchUri(t)})};break;case"File":var o=n.ScopeConfig[n.Scope.Documents].icon,g=e.identifiers,nt=e;l=n.getIconForTypeAsync(o,"."+nt.fileExtension);s=o;h=function(){_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(e.domain);n.launchDocument(g.url,g.webUrl,nt.fileExtension)}}return tt=function(i,r,u){var f=a.getQueryText(e),o;if(e.domain==="File"){if(!(u===null||u===void 0?void 0:u(e.id,e.domain)))return;o=e;o.locationPath=c.parentFolder;a._msbDataAccess.fireClientQfResponse(f,o,t===null||t===void 0?void 0:t.scope);i===null||i===void 0?void 0:i();return}a._msbDataAccess.fetchSearchResponse(f,e.domain,function(n){(u===null||u===void 0?void 0:u(e.id,e.domain))&&(a._msbDataAccess.fireSearchResponse(f,e.query,n),i===null||i===void 0?void 0:i())},function(){var t=n.getIsMsbInternalTenant()?"fetchSearchResponse: previewpane suggestion of ".concat(f,", domain: ").concat(e.domain," is not returned currently"):"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane 3s Fetch Failed",t);r===null||r===void 0?void 0:r(e.query)},t===null||t===void 0?void 0:t.scope)},c=this.createMsbSuggestion(t,v,it,l,s,u,e.domain,e.id,e.title,b,tt,h),e.domain==="File"&&this.updateFileSuggestion(t,e,c),n.isL2(t)&&t.scope===n.Scope.People&&(c.template=1,c.classNames.push("people","topResultTemplateInGroups")),c},t.prototype.getProvenance=function(n){if(!n.source)return null;switch(n.source.toLocaleLowerCase()){case"onedriveforbusiness":return"OneDriveBusiness";case"sharepoint":default:return"SharePoint"}},t.prototype.updateFileSuggestion=function(t,i,r){var f,u,o;r.classNames.push("fbig");r.author=i.author;i.timestamp&&(r.lastAccessDate=n.toDate(i.timestamp));r.lastModifiedBy=i.lastModifiedBy;i.lastModifiedTime&&(r.lastModifiedDate=n.toDate(i.lastModifiedTime));r.url=i.identifiers&&i.identifiers.url;r.siteTitle=(f=i.title)!==null&&f!==void 0?f:"";i.fileExtension&&(u=".".concat(i.fileExtension),r.extensionLC=u.toLocaleLowerCase(),r.query.endsWith(u)||(r.query=r.query+u),r.text!==r.query&&(r.text=r.query));o=this.getProvenance(i);n.setDocumentLocationProperties(r,i.query,o,!1);var s=r.author,h=r.lastModifiedBy,e=n.getEffectiveQuery(t);n.matchesOnPropertyHH(s,e)?r.match=n.createMatch(n.MatchType.Author,s):n.matchesOnPropertyHH(h,e)&&(r.match=n.createMatch(n.MatchType.LastModifiedBy,h));n.setFileTemplate(t,e,n.isL2(t),r)},t.prototype.reformulateOnQwsSuggestionClick=function(t,i,r){var u,f,e,s,l=typeof n.isMsbWorkScopeApplicable=="function"&&n.isMsbWorkScopeApplicable()&&n.config.msbNewWorkScopeEnabled&&n.config.msbEnableSearchHomeWSRedirect,h=l?((f=(u=n.ScopeConfig===null||n.ScopeConfig===void 0?void 0:n.ScopeConfig[n.Scope.Work])===null||u===void 0?void 0:u.prefixes)===null||f===void 0?void 0:f[0])||"Work":n.config.msbEnableQwsRequeryPeoplePrefix&&r==="Person"?(s=(e=n.ScopeConfig[n.Scope.People])===null||e===void 0?void 0:e.prefixes)===null||s===void 0?void 0:s[0]:"",a=h?"".concat(h,": ").concat(i):i,c=o[r],v=r==="Person"?"People":"Bookmarks";_w.bfbWsbTel&&bfbWsbTel.logSearchHomeClick(v);n.Host.reformulateNonForcedMiniSerp(a,t.isSearchHomeZI,c);n.Host.setFocusInSearchBox(null,"".concat(c,".click"))},t.prototype.isQwsRequerysEnabled=function(t){return t.isSearchHomeZI&&n.enableQws()&&n.config.msbEnableQwsRequery},t.prototype.getQueryText=function(n){var t=n.query,i;switch(n.domain){case"Person":case"Group":t=n.identifiers&&n.identifiers.uniqueName||t;break;case"File":i=n;t=t+"."+i.fileExtension}return t},t.prototype.adjustPersonName=function(t){var i=n.getFirstAndLastName(t.text),r,u;i&&(r=i.firstName,u=i.lastName,t.text=r,t.additionalInfoText=u)},t}();n.MsbQfSuggestionsParser=w}(WSB||(WSB={})),function(n){var t;(function(t){function h(t,i){var u,r,f;if(t!=null&&t.url){if(u=function(n,i){if(t.onError!=null)t.onError(n,i)},t.useToken==="WSB3S"){if(r=_w.BingAtWork&&_w.BingAtWork.wsb&&_w.BingAtWork.wsb.wsb3sAccessToken,!r){u(n.ClientErrorCode.NoWsbAccessToken,{message:"MsbAjax.sendAjax: no WSB/3S access token, won't send the request."});return}}else if(t.useToken==="WSBLoki"){if(r=_w.BingAtWork&&_w.BingAtWork.wsb&&_w.BingAtWork.wsb.wsbLokiAccessToken,!r){u(n.ClientErrorCode.NoMsbLokiAccessToken,{message:"MsbAjax.sendAjax: no WSB/Loki access token, won't send the request."});return}}else{if(r=_w.BingAtWork&&_w.BingAtWork.wsb&&_w.BingAtWork.wsb.wsbAccessToken,!r){u(n.ClientErrorCode.NoWsbAccessToken,{message:"MsbAjax.sendAjax: no WSB access token, won't send the request."});return}if(f=c(),f){u(n.ClientErrorCode.MsbTokenExpiredBeforeRequest,f);return}}t.url[0]==="/"&&(t.url=(_w==null?"":_w.location.origin)+t.url);n.config.msbUseXmlHttpRequest?a(t,r,u,i):l(t,r,u,i)}}function c(){var u,f,i=(u=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||u===void 0?void 0:u.wsbAccessTokenJwtExp,t,e,r,o;return i&&(t=n.getCurrentTime(),e=i-t,e<0)?(r=(f=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||f===void 0?void 0:f.wsbAccessTokenRefreshTime,o=t-(r||0),{message:"".concat("Wsb token expired before request"," {[MsbAjax].sendAjax}, rt=").concat(r,", jwtExp=").concat(i,", now=").concat(t)}):undefined}function l(t,i,r,e){var s=0,l;switch(t.requestType){case"POST":s=1;break;case"PUT":s=4}var c=SearchAppWrapper.CortanaApp,v=c.createStringMap(),h=c.createStringMap();h.Authorization="Bearer ".concat(i);h.Accept="*/*";v["Content-Type"]="application/json";for(l in t.headers)h[l]=t.headers[l];var y=performance.now(),a=new Date,o=a.getTime();n.Async.safeChain("makeHttpRequestAsync_MsbAjax_Ajax",function(){return c.makeHttpRequestAsync(s,t.url,h,t.body||"",v)},function(i){var h=n.getCurrentTime(),c=f(i===null||i===void 0?void 0:i.headers),s=c.serverTraceId,l=c.serverTime,v=c.serverLatency;if(u(t,l,o,s,"MsbAjax::sendCortanaAppHttpRequest"),t.onRoundTripReport){var p=i.statusCode==200?undefined:"HTTP".concat(i.statusCode),w=performance.now(),b=new Date,k=i.statusCode;t.onRoundTripReport({startTime:y,endTime:w,startDateTime:a,endDateTime:b,serverLatency:v,errorMessage:p,status:k,traceId:s})}i.statusCode===200?n.Async.safeChain("msbajax_ReadResponse",function(){return i.readAsStringAsync()},function(i){if(t.onSuccess!=null){var u=null;if(i!=="")try{u=e?i:JSON.parse(i)}catch(f){r(n.ClientErrorCode.ResponseJsonParseError,{message:"Bad data",responseText:i,serverTraceId:s,requestSentTime:o,responseReceivedTime:h});return}t.onSuccess(u,s)}},function(t){r(n.ClientErrorCode.ReadResponseError,{message:"readAsStringAsync_makeHttpRequestAsync_MsbAjax Error",errorMessage:"Name: ".concat(t.name,", message: ").concat(t.message),stackTrace:"".concat(t.stack),serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},null,null,0):n.Async.safeChain("readNon200Response",function(){return i.readAsStringAsync()},function(n){r(i.statusCode,{message:"Ajax call failed with status ".concat(i.statusCode.toString(),". No retries attempted."),responseText:n,serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},function(t){r(n.ClientErrorCode.ReadResponseError,{message:"readAsStringAsync_Non200_makeHttpRequestAsync_MsbAjax Error",errorMessage:"Name: ".concat(t.name,", Message: ").concat(t.message),stackTrace:"".concat(t.stack),serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},null,null,0)},function(i){if(t.onRoundTripReport){var u=performance.now(),f=new Date,e=n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError;t.onRoundTripReport({startTime:y,endTime:u,startDateTime:a,endDateTime:f,errorMessage:"Promise error makeHttpRequestAsync_MsbAjax Error",status:e})}r(n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError,{message:"Promise error makeHttpRequestAsync_MsbAjax Error",errorMessage:"Name: ".concat(i.name,", Message: ").concat(i.message,", RequestType: ").concat(s,", RequestUrl: ").concat(t.url," "),stackTrace:"".concat(i.stack)})},null,null,0)}function a(t,i,r,s){var h={},c;h.Authorization="Bearer ".concat(i);h["Content-Type"]="application/json";for(c in t.headers)h[c]=t.headers[c];var y=t.body||"",w=performance.now(),a=new Date,l=a.getTime(),b=function(i){var h=n.getCurrentTime(),o=f(i===null||i===void 0?void 0:i.responseHeaders),e=o.serverTraceId,b=o.serverTime,k=o.serverLatency,c,y;if(u(t,b,l,e,"MsbAjax::sendXmlHttpRequest"),t.onRoundTripReport){var d=(i===null||i===void 0?void 0:i.status)==200?undefined:"HTTP".concat(i===null||i===void 0?void 0:i.status,"-RequestState").concat(i===null||i===void 0?void 0:i.result),g=performance.now(),nt=new Date,tt=i.status;t.onRoundTripReport({startTime:w,endTime:g,startDateTime:a,endDateTime:nt,serverLatency:k,errorMessage:d,status:tt,traceId:e})}if((i===null||i===void 0?void 0:i.result)==0&&i.status==200){try{c=s?i.responseText:JSON.parse(i.responseText);v(t);t.onSuccess(c,e)}catch(it){r(n.ClientErrorCode.ResponseJsonParseError,{message:"[MsbAjax]sendXmlHttpRequest Bad data",responseText:i.responseText,serverTraceId:e,requestSentTime:l,responseReceivedTime:h})}return}y=(i===null||i===void 0?void 0:i.status)?i.status:p(i.result);r(y,{message:"[MsbAjax]sendXmlHttpRequest Error. ResponseStatus=".concat(i===null||i===void 0?void 0:i.status,", ResultCode=").concat(i.result),responseText:i===null||i===void 0?void 0:i.responseText,serverTraceId:e,requestSentTime:l,responseReceivedTime:h})};n.fetchUrl(t.url,h,y,b,null,null,null,o,null,t.requestType,e)}function u(t,i,r,u,f){var c;if(n.config.msbServerClientTimeSkewLimitMins&&t.checkServerTime&&i){var e=i-r,o="[".concat(f,"] returned, ServerTime=").concat(i,", ClientTime=").concat(r,", diff=").concat(e,", urlBase=").concat(n.getUrlBaseInfo(t.url)),h="Target URL: ".concat(t.url);Math.abs(e)>n.config.msbServerClientTimeSkewLimitMins*s&&(c=n.getIsMsbInternalTenant()?h:undefined,bfbWsbTel.logError("Wsb server and client time mismatch",o,{serverTraceId:u,additionalMessage:c}))}}function v(n){var t=y(n.url);!t||bfbWsbTel.logValue("SuccessRequest",t)}function y(n){return n.indexOf("v2/tenant/my/settings")>-1?"v2/tenant/my/settings":n.indexOf("v3/user/token/Substrate")>-1?"v3/user/token/Substrate":n.indexOf("search/api/v2/query")>-1?"search/api/v2/query":null}function p(t){switch(t){case 2:return n.ClientErrorCode.Aborted;case 3:return n.ClientErrorCode.XhrError;case 1:return n.ClientErrorCode.TimedOut;default:return n.ClientErrorCode.XhrCompleted}}function f(t){var u=t===null||t===void 0?void 0:t[i],f=t===null||t===void 0?void 0:t[r];if(u||f)return{serverTraceId:u,serverLatency:f};var o=n.getMsEdgeRef(t),e=o||{},s=e.traceId,h=e.timestamp;return{serverTraceId:s,serverTime:h}}var i="request-id",r="x-end2endlatencyms",e=["x-msedge-ref",i,r],o=1e4,s=6e4;t.sendAjax=h})(t=n.Msb||(n.Msb={}))}(WSB||(WSB={}));__spreadArray=this&&this.__spreadArray||function(n,t,i){if(i||arguments.length===2)for(var r=0,f=t.length,u;r<f;r++)!u&&r in t||(u||(u=Array.prototype.slice.call(t,0,r)),u[r]=t[r]);return n.concat(u||Array.prototype.slice.call(t))},function(n){function t(n){return n===null?null:n===undefined?undefined:typeof n=="number"||typeof n=="string"||typeof n=="boolean"?n:Array.isArray(n)?n.map(t):Object.keys(n).reduce(function(i,r){var u="".concat(r[0].toUpperCase()).concat(r.slice(1));return i[u]=typeof n[r]=="object"?t(n[r]):n[r],i},{})}var u="MSBLS_bfbSubstrateToken",i,r;n.VerticalConfigLocalStorageKey="WsbMsbVerticalConfig";i=6;r=function(){function r(t,i){var r=this;this._msbTokenManager=t;this._cachedVerticalItems=[];n.Host.bindAccountChanged(function(){return r.clearWorkScopeTokenStorage()});i.bindTenantEnabled(function(){return r.refreshVerticalItems(!0)});i.bindTenantDisabled(function(){return r.refreshVerticalItems(!1)})}return r.prototype.getSyntheticSuggestions=function(t,i){return(t===null||t===void 0?void 0:t.queryToFetch)&&t.scope===n.Scope.Work&&n.config.msbVerticalWorkScopeEnabled?this.createSuggestionList(t,i):[]},r.prototype.createSuggestionList=function(t,i){var s=this,e=[],r,h,f,o,c,u,l;if(t.scope===n.Scope.Work&&(r=this._cachedVerticalItems.filter(function(n){var t;return((t=n.verticalId)===null||t===void 0?void 0:t.toLowerCase())==="all"}).map(function(n){return s.createSuggestion(n,t,i)})[0],h=this._cachedVerticalItems.filter(function(n){var t;return((t=n.verticalId)===null||t===void 0?void 0:t.toLowerCase())!=="all"}).map(function(n){return s.createSuggestion(n,t,i)}),r)){for(r.childSuggestions=r.childSuggestions||[],f=0,o=h;f<o.length;f++)c=o[f],u=c,r.childSuggestions.push(u),u.parent=r,u.displayed=!0,u.groupType=n.GroupType.Related;l=n.SequenceNumberManager.getSequenceNumber();e=[r];n.InstrumentationHelper.instrumentDataSource(l,"MSBV",e,null)}return e},r.prototype.cleanupCachedVerticalItems=function(){this._cachedVerticalItems=[]},r.prototype.clearWorkScopeTokenStorage=function(){n.LightweightStorage.removeItem(u)},r.prototype.refreshVerticalItems=function(t){if(t&&typeof n.isMsbWorkScopeApplicable=="function"&&n.isMsbWorkScopeApplicable()){var i="v1-".concat(this._msbTokenManager.getMsbAccountRoutingHint()),r=this.getCachedVerticalConfig(i);r?this.setupVerticalItems(r):this.getAndSetVerticalItems(i)}else this.cleanupCachedVerticalItems(),this.cleanCachedVerticalConfig()},r.prototype.getAndSetVerticalItems=function(n){var t=this;this._msbTokenManager.refreshLokiTokenAndCall(function(){return t.verticalConfigSuccessHandler(n)},this.verticalConfigFailureHandle,"MsbVerticalManager")},r.prototype.verticalConfigSuccessHandler=function(t){var i=this;this.fetchVerticalConfig(function(n){i.setupVerticalItems(n);i.cacheVerticalConfig(n,t)},function(t,r){i.cleanupCachedVerticalItems();var u=r.message,f=r.stackTrace,e=r.serverTraceId,o=r.requestSentTime,s=r.responseReceivedTime;(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest)&&(bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logHttpError("VerticalConfigApiFailure",u,{statusCode:t,stackTrace:f,serverTraceId:e},{ReqTS:o,ResTS:s}))})},r.prototype.verticalConfigFailureHandle=function(n){bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logError("VerticalConfigAccessTokenNotFound",n)},r.prototype.cacheVerticalConfig=function(t,r){if(t){var u=new Date,f={data:t,expiry:u.setHours(u.getHours()+i),routingHint:r};n.LightweightStorage.setItem(n.VerticalConfigLocalStorageKey,JSON.stringify(f))}},r.prototype.cleanCachedVerticalConfig=function(){n.LightweightStorage.removeItem(n.VerticalConfigLocalStorageKey)},r.prototype.getCachedVerticalConfig=function(t){var r=n.LightweightStorage.getItem(n.VerticalConfigLocalStorageKey),u,i;if(r)try{i=JSON.parse(r);i.routingHint===t&&i.expiry>n.getCurrentTime()?u=i.data:this.cleanCachedVerticalConfig()}catch(f){this.cleanCachedVerticalConfig()}return u},r.prototype.getDisplayName=function(t,i,r,u){var f="";switch(i===null||i===void 0?void 0:i.toLowerCase()){case"all":f=u||n.Host.getLocString("MsbVerticalParentPattern");break;case"people":f=u||n.Host.getLocString("MsbVerticalChildPeople");break;case"sites":f=u||n.Host.getLocString("MsbVerticalChildSites");break;case"files":f=u||n.Host.getLocString("MsbVerticalChildFiles");break;case"groups":f=u||n.Host.getLocString("MsbVerticalChildGroups");break;case"messages":f=n.config.msbMessageVerticalWorkScopeLabelEnabledWW||n.config.msbMessageVerticalWorkScopeLabelEnabledMS&&n.isMsbInternalTenant()?n.Host.getLocString("MsbVerticalChildMessages"):n.Host.getLocString("MsbVerticalChildConversations");break;case"yammer":f=n.Host.getLocString("MsbVerticalChildYammer");break;default:r===1&&(f=n.Host.getLocString("MsbVerticalChildConnectorsPattern").replace("{display-name}",u||t))}return f},r.prototype.setupVerticalItems=function(t){var s,h,a,v,y,p,w,b,k,c,e,l,d;if(this.cleanupCachedVerticalItems(),t){for(c=[],e=0,l=t;e<l.length;e++){var o=l[e],i=o.Id,r=o.VerticalType,u=o.DisplayName,f=o.State;switch(i===null||i===void 0?void 0:i.toLowerCase()){case"all":f===1&&(a={verticalId:i,displayName:this.getDisplayName("",i,r,u),verticalHash:"",navDomain:"",navDomainId:""});break;case"people":f===1&&(v={verticalId:i,displayName:this.getDisplayName("Person",i,r,u),verticalHash:"".concat("Person","-").concat(i),navDomain:"Person",navDomainId:i,icon:{content:"&#xE716",type:2}});break;case"sites":f===1&&(p={verticalId:i,displayName:this.getDisplayName("Site",i,r,u),verticalHash:"".concat("Site","-").concat(i),navDomain:"Site",navDomainId:i,icon:{content:"&#xE737",type:2}});break;case"files":f===1&&(w={verticalId:i,displayName:this.getDisplayName("File",i,r,u),verticalHash:"".concat("File","-").concat(i),navDomain:"File",navDomainId:i,icon:{content:"&#xEF6C",type:2}});break;default:f===1&&r===1&&c.push({verticalId:i,displayName:this.getDisplayName("Connectors",i,r,u),verticalHash:"".concat("Connectors","-").concat(i),navDomain:"Connectors",navDomainId:i,icon:{content:"&#xE737",type:2}})}}y={verticalId:"Group",displayName:this.getDisplayName("Group","Groups"),verticalHash:"Group",navDomain:"Group",navDomainId:"",icon:{content:"&#xE902",type:2}};n.config.msbNewConversationVerticalWorkScopeEnabled&&(b={verticalId:"Message",displayName:this.getDisplayName("Message","Messages"),verticalHash:"".concat("Message","-conversations"),navDomain:"Message",navDomainId:"conversations",icon:{content:"&#xE901",type:2}});d=((s=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||s===void 0?void 0:s.gccRegion)===1||((h=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||h===void 0?void 0:h.gccRegion)===2;d||(k={verticalId:"Yammer",displayName:this.getDisplayName("Yammer","Yammer"),verticalHash:"Yammer",navDomain:"Yammer",navDomainId:"yammer",icon:{content:"&#xE901",type:2}});this._cachedVerticalItems=__spreadArray([a,v,y,p,w,b,k],c,!0).filter(function(n){return n!=null})}},r.prototype.createSuggestion=function(t,i,r){var h=typeof n.getStoredMsbTenantName=="function"&&n.getStoredMsbTenantName(),c=n.config.msbNewWorkScopeEnabled?n.Host.getLocString("MsbNewVerticalSuggestionGroupName",h):n.Host.getLocString("MsbVerticalSuggestionGroupName"),f=t.displayName,l=t.verticalId.toLowerCase()==="all",e="".concat(n.config.msbNewWorkScopeEnabled?t.displayName:n.getStoredMsbTenantName()," ").concat(n.getWorkSuggestionAnnotation()),o;l&&(o=t.displayName.replace("{query-text}",encodeURIComponent(i.queryToFetch)),f=HitHighlightingParser.addMarkers(decodeURIComponent(o),i.queryToFetch),e="".concat(n.config.msbNewWorkScopeEnabled?n.Host.getLocString("MsbVerticalAll"):n.getStoredMsbTenantName()," ").concat(n.getWorkSuggestionAnnotation()));var s="MVALL",u=n.createSuggestion(i,f,null,t.icon||{content:"&#xE721",type:2},s,i.queryToFetch,n.InstrumentedItem.createInstrumentedItem(r,s),21,r,!0,t.verticalHash,undefined,undefined,t.verticalHash);return u.navDomain=t.navDomain,u.navDomainId=t.navDomainId,u.autoOpenPreviewPaneWhenOnTopHit=n.config.msbNewWorkScopeEnabled?!1:!0,u.msbVerticalHash=t.verticalHash,u.rankingScore=-9900,u.skipRerank=!0,u.sourceForGroup=0,u.previewPaneType=n.config.msbVerticalDebugDisableMiniSerp?undefined:1,u.primaryMetadata=e,u.id="ws-".concat(t.verticalId.toLowerCase()),n.config.msbNewWorkScopeEnabled&&(u.template=0),u.groupDisplayName=c,u},r.prototype.getVerticalConfigUrl=function(){var t=n.getLokiUrl("v1/search/configuration/verticals");if(t){var r=BingAtWork.context,u=r.conversationId,f=r.sessionId,e={RootCorrelationId:u,conversationId:u,ClientCorrelationId:f,ConvertGetPost:"true"},i=_w.BingAtWork;typeof(i===null||i===void 0?void 0:i.mergeArgsIntoUrl)=="function"&&(t=i.mergeArgsIntoUrl(t,e))}return t},r.prototype.fetchVerticalConfig=function(i,r){var u=this.getVerticalConfigUrl(),f,e,o;u?(f={"X-ClientType":n.getClientType(n.Scope.Work)},e={url:u,useToken:"WSBLoki",requestType:"POST",body:JSON.stringify(f),checkServerTime:!0,onSuccess:function(n){return i(t(n))},onError:function(n,t){return r(n,t)}},n.Msb.sendAjax(e)):(o={message:"Url is undefined because not able to resolve Loki domain"},r(n.ClientErrorCode.UrlUnavailable,o))},r}();n.MsbVerticalManager=r}(WSB||(WSB={}));1