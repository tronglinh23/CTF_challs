"use strict";var WSB;(function(n){let i;(function(n){n[n.MsbAjaxMakeHttpRequestAsyncError=-1]="MsbAjaxMakeHttpRequestAsyncError";n[n.ResponseJsonParseError=-2]="ResponseJsonParseError";n[n.ReadResponseError=-3]="ReadResponseError";n[n.ReadErrorStatusResponseError=-4]="ReadErrorStatusResponseError";n[n.NoToken=-5]="NoToken";n[n.FetchError=-6]="FetchError";n[n.UncaughtError=-7]="UncaughtError";n[n.NoMsbLokiAccessToken=-8]="NoMsbLokiAccessToken";n[n.Aborted=-9]="Aborted";n[n.TimedOut=-11]="TimedOut";n[n.XhrError=-12]="XhrError";n[n.XhrCompleted=-13]="XhrCompleted";n[n.MsbTokenExpiredBeforeRequest=-14]="MsbTokenExpiredBeforeRequest";n[n.UrlUnavailable=-15]="UrlUnavailable";n[n.RefreshTokenFailure=-16]="RefreshTokenFailure";n[n.MsbHttpBuildApiParameterError=-17]="MsbHttpBuildApiParameterError"})(i=n.ClientErrorCode||(n.ClientErrorCode={}));n.MsbStateExpiryTimeInMs=432e6;class t{static init(){this.isMsbSupported()&&(n.msbHost=new t)}static isMsbSupported(){return n.RuntimeConfig.EntryPointApp==0}constructor(){this.tokenManager=new n.MsbTokenManager(n.getAccessTokenManager());this.httpWrapper=new n.MsbHttpWrapper;this.dataAccess=new n.MsbDataAccess;this.tenantManager=new n.MsbTenantManager(this.tokenManager);this.verticalManager=new n.MsbVerticalManager(this.tokenManager,this.tenantManager);this.prefetchManager=new n.MsbPrefetchManager;this.substrateLogger=new n.MsbSubstrateLogger;n.config.msbEnableUserConfigManager&&n.MsbUserConfigManager&&(this.userConfigManager=new n.MsbUserConfigManager(this.tokenManager,this.tenantManager));this.qfUtils=new n.MsbQfUtils;this.urlUtils=new n.MsbUrlUtils}getClientType(t){let i="Wsb";return t===n.Scope.Work&&(i="WsbBingVertical"),i}enableQws(){return!n.shouldShowDSBLayout()&&(!this.tenantManager.getIsMsbEduTenantEnabled()||n.config.msbQwsEnabledInEdu)&&!this.tenantManager.isGccHighTenant()}shouldHideTopApp(){return this.enableQws()&&n.config.msbHideTopApp}qwsShowTopList(){return this.enableQws()&&n.config.msbQwsShowTopList}enableQwsCache(){return this.enableQws()&&n.config.msbEnableQwsCache}enableQwsRecDocs(){return this.enableQws()&&n.config.msbQwsShowRecommendedDocs}isDocSrcEnabledInQws(t){const i=this.enableQwsRecDocs()&&n.isMsbEnterprise(),r=n.config.use3sRecRecommendedFiles&&n.isMsftAccountConnected;switch(t){case"SSUE":return i&&!r;case"SREE":return i&&r;default:return!1}}enableTopBrandingBar(){return!n.config.useCobaltCSS&&this.enableBranding()}enableScopeListBrandingLogo(){return n.config.useCobaltCSS&&this.enableBranding()&&(!this.tenantManager.getIsMsbInternalTenant()||n.config.msbCompanyLogoScopeBarEnabledMS)}enableBranding(){return this.tenantManager.shouldForceEnterpriseAccount()&&!this.tenantManager.isGccHighTenant()}isAuthLogEnabled(){return n.config.msbEnableAuthLog}isThorProxyEnabled(){return n.msbHost.tenantManager.getIsMsbInternalTenant()?n.config.msbEnabledThorProxyMS:n.msbHost.tenantManager.getIsMsbEduTenantEnabled()?n.config.msbEnabledThorProxyEdu:n.config.msbEnabledThorProxy}shouldUseServerGleam(){return n.msbHost.tenantManager.getIsMsbInternalTenant()?n.config.msbDsbUseServerGleamMS:n.config.msbDsbUseServerGleam}}n.MsbHost=t})(WSB||(WSB={})),function(n){function r(n,t){return Math.random()*t+n}function t(n){if(!n)return undefined;try{const t=n.split(".")[1],i=t.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(i).split("").map(n=>"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}catch(t){return undefined}}function u(n){if(!n)return{error:"BingAtWork.wsb.wsbAccessToken - not set"};const i=t(n);if(!i)return{error:"BingAtWork.wsb.wsbAccessToken - failed to parse token"};const{appid:r,aud:u,iss:f,scp:e,amr:o}=i;return{appid:r,aud:u,iss:f,scp:e,amr:o}}function f(n){const i=n===null||n===void 0?void 0:n.trim();if(!i)return undefined;const t=i.indexOf(" ");if(t<=0)return undefined;const r=n.substring(0,t),u=n.substring(t+1);return{firstName:r,lastName:u}}function e(n){var r,u;const i=t(n),f=(r=i===null||i===void 0?void 0:i.tenant_region_sub_scope)===null||r===void 0?void 0:r.toLowerCase(),e=(u=i===null||i===void 0?void 0:i.tenant_region_scope)===null||u===void 0?void 0:u.toLowerCase();return f==="gcc"?1:e==="usg"||e==="usgov"?f==="dod"?0:2:0}function l(n){if(!n)return undefined;const r=typeof n.get=="function"?n.get(i):n[i];if(!r)return undefined;const t=r.match(o);if((t===null||t===void 0?void 0:t.length)!=s)return undefined;const u=t[h],f=t[c],e=new Date(f).getTime();return{traceId:u,timestamp:e}}function a(n){try{return n instanceof Error?JSON.stringify(n,Object.getOwnPropertyNames(n)):JSON.stringify(n)}catch(t){return"<failed to stringify error>"}}function v(n){const i=n<0?4294967296+n:n,r="0x"+i.toString(16);let t="";switch(n){case-2147024891:t="E_ACCESSDENIED";break;case-2147012865:t="WININET_E_CONNECTION_RESET"}return`${n}|${r}|${t}`}n.getRandomNumInRange=r;n.parseJwt=t;n.getReducedTokenInfo=u;n.getFirstAndLastName=f;n.getGccRegionFromToken=e;const o=/Ref A: ([A-Z0-9]+)\sRef B: ([^\s]+) Ref C: (.+)/,s=4,h=1,c=3,i="x-msedge-ref";n.getMsEdgeRef=l;n.stringifyError=a;n.formatHResultString=v}(WSB||(WSB={})),function(n){class t{constructor(){_w.BingAtWork||(_w.BingAtWork={});BingAtWork.Wsb=BingAtWork.Wsb||{};BingAtWork.Wsb.addMsbUserInfoParameterToUrlAsync=this.addMsbUserInfoParameterToUrlAsync.bind(this)}getMsbUrl(t){var i;const r={[0]:n.config.msbApiBaseUrl,[1]:n.config.msbGccApiBaseUrl,[2]:n.config.msbGccHighApiBaseUrl},u=((i=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||i===void 0?void 0:i.gccRegion)?r[BingAtWork.wsb.gccRegion]:n.config.msbApiBaseUrl;return`${u}/${t}`}getDsbUrl(t){var i;const r=n.config.msbDsbUseLocal?n.config.msbDsbApiBaseLocalUrl:n.config.msbDsbApiBaseUrl,u={[0]:r,[1]:n.config.msbDsbGccApiBaseUrl,[2]:n.config.msbDsbGccHighApiBaseUrl},f=((i=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||i===void 0?void 0:i.gccRegion)?u[BingAtWork.wsb.gccRegion]:r;return`${f}/${t}`}getLokiUrl(t){var r,u;let i=n.config.lokiBaseApiUri;return n.msbHost.tenantManager.getIsMsbInternalTenant()&&n.isMsbEnterprise()&&n.config.lokiBaseApiUriOverrideEnabled&&(i=n.config.lokiMsitBaseApiUri),((r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||r===void 0?void 0:r.gccRegion)===1?i=n.config.lokiGccBaseApiUri:((u=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||u===void 0?void 0:u.gccRegion)===2&&(i=n.config.lokiGccHighBaseApiUri),i?`${i}/${t}`:undefined}async buildBfbSearchUrlAsync(t,i,r,u){if(!n.config||!t||!i)return"";const o=encodeURIComponent(t);let e="";if(i!="Person"){const n={triggeringMode:"Explicit",intent:i};r&&(n.entityId=r);const t=JSON.stringify(n);e=encodeURIComponent(t)}let f=n.formatString(n.config.bfbSearchUrl||"",[o,e,u]);return f=await this.addMsbUserInfoParameterToUrlAsync(f),this.addConversationIdToUrl(f)}async buildMsbWorkSearchUrlAsync(t,i,r){let u=n.formatString(t.bfbSearchUrl||"",[i,"",r]);return u=await this.addMsbUserInfoParameterToUrlAsync(u),this.addConversationIdToUrl(u)}async addMsbUserInfoParameterToUrlAsync(t){if(!t||typeof crypto!="object")return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error",`No "window.crypto" object`),t;const i=n.msbHost.tokenManager.getAadUserInfo();if(!(i===null||i===void 0?void 0:i.tenantId)||!(i===null||i===void 0?void 0:i.userAadId))return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error",`No user info.`),t;const u=this.getSecureSalt();if(!u)return t;try{const r=`${i===null||i===void 0?void 0:i.userAadId.toLowerCase()}@${i===null||i===void 0?void 0:i.tenantId.toLowerCase()}@${u.toLowerCase()}`,f=Uint8Array.from(r.split("").map(n=>n.charCodeAt(0))),e=await crypto.subtle.digest("SHA-256",f),o=new Uint8Array(e);let n="";for(const t of o)n+=t.toString(16).padStart(2,"0");const s=`olu=${n}&olus=${u}`;return this.insertParameter(t,s)}catch(r){return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error",`Exception: ${(r===null||r===void 0?void 0:r.message)||JSON.stringify(r)}`),t}}addConversationIdToUrl(n){if(!n)return n;const t=(_G===null||_G===void 0?void 0:_G.IG)?`cvid=${encodeURIComponent(_G.IG)}`:undefined;return t?this.insertParameter(n,t):n}getSecureSalt(){try{const n=new Uint8Array(16);return _w.crypto.getRandomValues(n),Array.from(n).map(n=>n.toString(16).padStart(2,"0")).join("")}catch(n){return _w.bfbWsbTel&&bfbWsbTel.logError("Wsb add user info to URL error",`Generate salt throws: ${(n===null||n===void 0?void 0:n.message)||JSON.stringify(n)}`),""}}insertParameter(n,t){const i=n.indexOf("#");if(i<0)return this.appendParameter(n,t);else{const r=n.substring(0,i),u=n.substring(i);return`${this.appendParameter(r,t)}${u}`}}appendParameter(n,t){const i=n.indexOf("?"),r=i<0?"?":"&";return`${n}${r}${t}`}getUrlBaseInfo(n){var t;if((t=n===null||n===void 0?void 0:n.match(/[^\?\#]*/))!==null&&t!==void 0)return t[0]}}n.MsbUrlUtils=t}(WSB||(WSB={})),function(n){const t="X-Client-Language",i="X-Client-LocalTime",r="Client-Request-Id",u="User-Agent",f="6ba82e35-cb33-52a3-710a-75b1290faba1.1000.01",e="https://substrate.office.com/search/api/v1/events?scenario=",o="SearchEntityActions";class s{logSearchEntityActions(s){var l,a,v,y,p,w;const h=n.msbHost.tokenManager.getAadUserInfo(),b=[{Key:(l=window===null||window===void 0?void 0:window._G)===null||l===void 0?void 0:l.IG,Value:[{Name:o,Attributes:[{Key:"Id",Value:f},{Key:"LocalTime",Value:n.getDateWithTimezone()},{Key:"EventType",Value:"EntityClicked"},{Key:"UserId",Value:(a=h===null||h===void 0?void 0:h.userAadId)!==null&&a!==void 0?a:""},{Key:"TenantId",Value:(v=h===null||h===void 0?void 0:h.tenantId)!==null&&v!==void 0?v:""},{Key:"TraceId",Value:(y=window===null||window===void 0?void 0:window._G)===null||y===void 0?void 0:y.IG},{Key:"LogicalId",Value:(p=window===null||window===void 0?void 0:window._G)===null||p===void 0?void 0:p.IG},{Key:"Version",Value:"2"}]}]}],k=e+s,c={};c[r]=(w=window===null||window===void 0?void 0:window._G)===null||w===void 0?void 0:w.IG;c[t]=n.uiLanguageCache;c[i]=n.getDateWithTimezone();c[u]=navigator.userAgent;const d={url:k,requestType:"POST",headers:c,body:JSON.stringify(b),useToken:"WSB3S"};n.msbHost.tokenManager.refresh3sTokenAndCall(()=>{n.Msb.sendAjax(d)})}}n.MsbSubstrateLogger=s}(WSB||(WSB={})),function(n){const t="AadUserId",i="WsbVerifyAccountRequired",r=3e5,u=6e4,f=6e4,e=50;class o{constructor(n){this.codeLocation=n}}n.MsbNoMsbTokenError=o;class s{constructor(t){if(this.accessTokenManager=t,this.tokenChanged=!1,this.tokenChangedHandlers=[],this.aadNotAvailableHandlers=[],this.wsbAadReadyNotified=!1,this.accountTypeChangedIsFiring=!1,n.Host.bindAccountChanged(()=>this.clearMemoryCachedInfo()),t.bindAccountTypesChanged(()=>{this.handleAccountTypeChanged()}),t.bindVerifyAccountRequired((n,t)=>{this.handleWsbVerifyAccountRequired(n,t)}),t.bindAccessTokenAvailable((n,t)=>{this.handleWsbAccessTokenAvailable(n,t)}),t.bindSelectedAccountChanged(()=>{this.handleWsbSelectedAccountChanged()}),n.config.msbLoadQfScriptEarly&&n.safeSetTimeout(()=>{n.msbHost.tenantManager.shouldForceEnterpriseAccount()&&_w.postMessage({messageType:"BingAtWork:WsbQfScriptLoad"},"*")},e,"MsbTokenManager Constructor"),n.config.msbDsbReconnectAad){const i="mdsb-rclog";t.bindReconnectAadReport(t=>{const u=n.LightweightStorage.getItem(i),r=u?JSON.parse(u):{total:0,error:0,rawReports:[]};r.rawReports.push(t);r.total++;t.success||r.error++;n.LightweightStorage.setItem(i,JSON.stringify(r))});n.Host.bindBootstrapDone(()=>{const t=n.LightweightStorage.getItem(i);t&&(_w.bfbWsbTel&&bfbWsbTel.logValue("MsbDsbReconnectAadReport",t),n.LightweightStorage.removeItem(i))})}}bindMsbAccountAvailableTenantSettingHandler(n){this.msbAccountAvailableTenantSettingHandler=n}bindAadNotAvailable(n){this.aadNotAvailableHandlers.push(n)}clearMemoryCachedInfo(){this.lokiAccount=undefined}bindTokenChanged(n){this.tokenChangedHandlers.push(n);const t=this.getMsbToken();t&&n(t)}refreshMsbTokenAndCall(t,i,r,u){r=r&&[...r,`MsbTokenManager::refreshMsbTokenAndCall`];let f;n.msbPerfLogger&&(typeof this.lastPerfMarkCallId=="undefined"&&(this.lastPerfMarkCallId=0),f=this.lastPerfMarkCallId++);const e=this.getMsbToken("refreshMsbTokenAndCall:1");if(!e||(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbAlwaysAuthBaw)){const e=n.getCurrentTime();this.callGetMsbAccount(!0,()=>{const r=this.getMsbToken("refreshMsbTokenAndCall:2"),u=n.getCurrentTime(),f=!r;n.msbHost.isAuthLogEnabled()&&u-e>100&&_w.bfbWsbTel&&bfbWsbTel.logError("Wsb long token refresh delay",`Token error: ${f}`,undefined,{durationInMs:u-e});r?n.safeExecute(()=>t(r),"MsbTokenManager::refreshMsbTokenAndCall:callback - fetched token"):i&&n.safeExecute(i,"MsbTokenManager::refreshMsbTokenAndCall:noTokenCallback")},`${u}:refreshMsbTokenAndCall`,r,f)}else n.safeExecute(()=>t(e),"MsbTokenManager::refreshMsbTokenAndCall:callback - cached token")}refresh3sTokenAndCall(t,i,r){r=r&&[...r,`MsbTokenManager::refresh3sTokenAndCall`];const u=this.get3sToken();u?n.safeExecute(()=>t(u),"MsbTokenManager::refresh3sTokenAndCall:callback - cached token"):this.refreshMsbTokenAndCall(()=>{this.callFetch3sAccount(()=>{this.after3sAccountRefreshed(t,i)})},()=>{i&&n.safeExecute(()=>i(),"MsbTokenManager::refresh3sTokenAndCall:noTokenCallback")},undefined,"Refresh3sTokenAndCall")}isAadAvailable(){return this.accessTokenManager.isAadAvailable()}getSelectedAccountId(){return this.accessTokenManager.getSelectedAccountId()}after3sAccountRefreshed(t,i){const r=this.get3sToken();r?n.safeExecute(()=>t(r),"MsbTokenManager::refresh3sTokenAndCall:callback - fetched token"):i&&n.safeExecute(i,"MsbTokenManager::refresh3sTokenAndCall:noTokenCallback")}getMsbToken(t){if(!this.msbAccount)return undefined;const i=n.getCurrentTime(),r=i>this.msbAccount.ExpireDateTime;if((n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbAuthFailed)||r){if(BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=undefined,BingAtWork.wsb.wsbAccessTokenWamExp=undefined,BingAtWork.wsb.wsbAccessTokenJwtExp=undefined),n.isMsftAccountConnected&&r&&t){const n=`Token expired by ${(i-this.msbAccount.ExpireDateTime)/u} mins and caller: ${t}`;bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logError("MsbTokenExpired",n)}return this.msbAccount=undefined,undefined}return this.msbAccount.Token}get3sToken(){if(!this.substrateAccount)return undefined;const t=n.getCurrentTime();return t>this.substrateAccount.ExpireDateTime?(this.substrateAccount=undefined,BingAtWork.wsb&&(BingAtWork.wsb.wsb3sAccessToken=undefined),undefined):this.substrateAccount.Token}getMsbAccountRoutingHint(){var n;if((n=this.msbAccount)!==null&&n!==void 0)return n.RoutingHint}getLokiToken(){if(!this.lokiAccount)return undefined;const t=n.getCurrentTime();return t>this.lokiAccount.ExpireDateTime?(this.lokiAccount=undefined,(BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)&&(BingAtWork.wsb.wsbLokiAccessToken=undefined),undefined):this.lokiAccount.Token}refreshLokiTokenAndCall(t,i,r){const u=this.getLokiToken();if(u)n.safeExecute(()=>t(),`MsbTokenManager::refreshLokiTokenAndCall:${r} - cached token`);else{const r=this.getMsbToken("refreshLokiTokenAndCall");r?this.callFetchLokiAccount(()=>{this.afterLokiAccountRefreshed(t,i)}):i&&n.safeExecute(()=>i("RefreshMsbTokenAndCall:No Msb Token"),"MsbTokenManager::refreshLokiTokenAndCall:noTokenCallback")}}afterLokiAccountRefreshed(t,i){const r=this.getLokiToken();r?n.safeExecute(()=>t(),"MsbTokenManager::refreshLokiTokenAndCall:callback - fetched token"):i&&n.safeExecute(()=>{i("AfterLokiAccountRefreshed: No Loki token")},"MsbTokenManager::refreshLokiTokenAndCall:noTokenCallback")}handleLokiAccount(n){(n===null||n===void 0?void 0:n.Token)&&this.setLokiAccount(n)}fetchMsbLokiAccount(t,i){var r;const u=this.getMsbToken("fetchMsbLokiAccount");u||(_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch Loki Token No Msb Token"),i());const e={clientContext:{clientType:n.msbHost.getClientType(n.Scope.Work)}},o=n.msbHost.urlUtils.getMsbUrl("v3/user/token/Loki"),s=`${o}?cvid=${(r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.context)===null||r===void 0?void 0:r.conversationId}`,h={url:s,requestType:"POST",body:JSON.stringify(e),checkServerTime:!0,onSuccess:r=>{const u=this.makeAccountInfo(r,f);if(u)t(u);else{const t=`[MSB.Error] fetching loki token returns no token. response=${JSON.stringify(r)}`,u=n.msbHost.tenantManager.getIsMsbInternalTenant()?t:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch Loki Token Returns Invalid Response","",{additionalMessage:u});i()}},onError:(t,r)=>{if(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const{responseText:f,message:e,stackTrace:i,serverTraceId:u,requestSentTime:o,responseReceivedTime:s,isBrowserOnline:h,hResultString:c}=r,l=`[MSB.Error] fetching loki token has error, details=${JSON.stringify({statusCode:t,responseText:f,message:e,stackTrace:i,serverTraceId:u})}`,a=n.msbHost.tenantManager.getIsMsbInternalTenant()?l:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Loki Token Failed","",{stackTrace:i,serverTraceId:u,additionalMessage:a,statusCode:t},{Online:h,HResult:c,ReqTS:o,ResTS:s})}i()}};n.Msb.sendAjax(h)}setLokiAccount(n){this.lokiAccount=n;(BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)&&(BingAtWork.wsb.wsbLokiAccessToken=n.Token)}callFetchLokiAccount(t){this.fetchMsbLokiAccount(i=>{n.safeExecute(()=>{this.handleLokiAccount(i),t()},"Calling handleLokiAccount")},()=>{n.safeExecute(()=>{t()},"Calling handleMsbAccount with null loki account")})}getTokenExpiry(t,i){var u;const r=n.parseJwt((u=this.msbAccount)===null||u===void 0?void 0:u.Token);if(r===null||r===void 0?void 0:r.exp){const t=n.config.msbTokenExpirySafetyShiftInMins*6e4;return(r===null||r===void 0?void 0:r.exp)*1e3-t}return i}notifyWsbAadReady(){this.wsbAadReadyNotified||!n.msbHost.tenantManager.isTenantMsbEnabled()||n.msbHost.tenantManager.isGccHighTenant()||(this.wsbAadReadyNotified=!0,BingAtWork.wsb&&(BingAtWork.wsb.isBackgroundRefreshEnabledInInit=n.isDynamicSearchContentPossible()),_w.postMessage({messageType:"BingAtWork:WsbAadReady",userId:this.userId,tenantId:this.tenantId},"*"))}callGetMsbAccount(t,i,r,u,f){if(u=u&&[...u,`MsbTokenManager::callGetMsbAccount(caller=${r})`],!this.accessTokenManager.isAadAvailable()&&!n.config.msbMockToken){n.msbHost.tenantManager.setTenantMsbDisabledStatus();this.clearUserTenantContext();this.aadNotAvailableHandlers.forEach(t=>{sb_st(()=>n.safeExecute(()=>t(),"MsbTokenManager::fireAadNotAvailable"),1)});i===null||i===void 0?void 0:i(!1);return}n.config.msbForceRefreshToken&&(t=!0);n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.MsbTokenRequested,f);this.accessTokenManager.getAccount(1,n.config.msbDsbUseLocal?"ef47e344-4bff-4e28-87da-6551a21ffbe0":"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7",t,!0,t=>{let e=t;n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.MsbTokenResponded,f);n.config.msbMockToken&&(e=this.getMsbMockAccount());(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbAuthFailed)&&(e=undefined);n.safeExecute(()=>{this.handleMsbAccount(e,i,r,u)},"Calling handleMsbAccount")},undefined,u)}callFetch3sAccount(t){this.fetchMsb3sAccount(i=>{n.safeExecute(()=>{this.handleSubstrateAccount(i),t===null||t===void 0?void 0:t()},"Calling handleSubstrateAccount")},()=>{n.safeExecute(()=>{this.handleSubstrateAccount(undefined),t===null||t===void 0?void 0:t()},"Calling handleMsbAccount with null 3s account")})}handleMsbAccount(i,r,u,f){f=f&&[...f,"MsbTokenManager::handleMsbAccount"];const o=i===null||i===void 0?void 0:i.Token;const e=this.createAadUserInfo(i);if(this.setAadUserInfo(e),this.updateTelemetryContext(e),(e===null||e===void 0?void 0:e.userAadId)&&(i===null||i===void 0?void 0:i.RoutingHint)&&this.trySendValueEvents(t,i.RoutingHint,{name:"LogAadUserId",value:u}),o){this.setMsbAccount(i);const f=this.tokenChanged,t=()=>{this.handleMsbTokenChanged(),r===null||r===void 0?void 0:r(f)},e=()=>{t()},o=n=>{(n===null||n===void 0?void 0:n.hasTokenIssue)&&(this.msbAccount=undefined,BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=undefined,BingAtWork.wsb.wsbAccessTokenWamExp=undefined,BingAtWork.wsb.wsbAccessTokenJwtExp=undefined)),t()};this.msbAccountAvailableTenantSettingHandler?n.safeExecute(()=>this.msbAccountAvailableTenantSettingHandler(e,o,u,this.msbAccount),"MsbTokenManager::msbAccountAvailableTenantSettingHandler"):t()}else n.logAuthRelatedInfo("getAccountOnFailure",`authenticate failed ${f===null||f===void 0?void 0:f.join(" -> ")}`),this.setMsbAccount(undefined),n.msbHost.tenantManager.setTenantMsbDisabledStatus(),r===null||r===void 0?void 0:r(!1)}handleSubstrateAccount(t,i){i=i&&[...i,"MsbTokenManager::handleSubstrateAccount"];const r=t===null||t===void 0?void 0:t.Token;r?this.setSubstrateAccount(t):n.logAuthRelatedInfo("getAccountOnFailure",`authenticate failed ${i===null||i===void 0?void 0:i.join(" -> ")}`)}fetchMsb3sAccount(t,i){const f=this.getMsbToken("fetchMsb3sAccount");f||(_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token No Msb Token"),i());const e=n.msbHost.urlUtils.getMsbUrl("v3/user/token/Substrate"),u=BingAtWork.context.conversationId,o=`${e}?cvid=${u}`,s={url:o,checkServerTime:!0,onSuccess:f=>{const e=this.makeAccountInfo(f,r);if(e)t(e);else{const t=`[MSB.Error] fetching 3S token returns no token. response=${JSON.stringify(f)}`;const r=n.msbHost.tenantManager.getIsMsbInternalTenant()?t:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token Returns Invalid Response","",{additionalMessage:r,cvid:u});i()}},onError:(t,r)=>{if(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const{responseText:s,message:i,stackTrace:f,serverTraceId:e,requestSentTime:h,responseReceivedTime:c,isBrowserOnline:l,hResultString:a}=r,o=`[MSB.Error] fetching 3S token has error, details=${JSON.stringify({statusCode:t,responseText:s,message:i,stackTrace:f,serverTraceId:e})}`;const v=n.msbHost.tenantManager.getIsMsbInternalTenant()?o:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch 3S Token Failed",i,{stackTrace:f,serverTraceId:e,additionalMessage:v,statusCode:t,cvid:u},{Online:l,HResult:a,ReqTS:h,ResTS:c})}i()}};n.Msb.sendAjax(s)}makeAccountInfo(t,i){if(!t||!t.token||!t.tokenExpiry||!t.tenant||!t.tenant.id||!t.user||!t.user.id||!t.user.displayName)return undefined;const{token:f,tokenExpiry:e,tenant:{id:r},user:{id:u,displayName:o}}=t;return{Token:f,ExpireDateTime:e-i,UserName:o,RoutingHint:`OID:${r}:${u}`,LastUpdated:n.getCurrentDate().getTime(),TenantId:r,UserObjectId:u}}setMsbAccount(t){var r;const u=(r=this.msbAccount)===null||r===void 0?void 0:r.Token,i=t===null||t===void 0?void 0:t.Token;if(this.msbAccount=t,!!i&&u!=i){if(this.tokenChanged=!0,BingAtWork.wsb){BingAtWork.wsb.wsbAccessToken=i;const u=t.ExpireDateTime;BingAtWork.wsb.wsbAccessTokenWamExp=u;const f=n.parseJwt(i),r=Number(f===null||f===void 0?void 0:f.exp)*1e3;if(!r){const t=`typeof(parsedToken)=${typeof f}, typeof(jwtExp)=${typeof r}`,i=n.msbHost.tenantManager.getIsMsbInternalTenant()?`account=${JSON.stringify(this.msbAccount)}`:undefined;bfbWsbTel.logError("Wsb WAM-JWT expiry no value",t,{additionalMessage:i})}BingAtWork.wsb.wsbAccessTokenJwtExp=r;BingAtWork.wsb.wsbAccessTokenRefreshTime=n.getCurrentTime();const e=r-u;e<0&&bfbWsbTel.logError("Wsb WAM-JWT expiry mismatch",`RefreshTime=${BingAtWork.wsb.wsbAccessTokenRefreshTime} WamExp=${u}, JwtExp=${r}`);BingAtWork.wsb.gccRegion=n.getGccRegionFromToken(i)}if(this.msbAccount){const n=this.getTokenExpiry(i,this.msbAccount.ExpireDateTime);n&&this.msbAccount.ExpireDateTime<n&&(this.msbAccount.ExpireDateTime=n)}}}setSubstrateAccount(n){this.substrateAccount=n;BingAtWork.wsb&&(BingAtWork.wsb.wsb3sAccessToken=n.Token)}sendMsbProactiveSignIn(t){const i={Authentication:t},r=n.msbHost.urlUtils.getMsbUrl("v3/user/proactive/signin");n.fetchUrl(r,{["Content-Type"]:"text/plain"},JSON.stringify(i),undefined,undefined,undefined,!0,undefined,!0)}handleMsbTokenChanged(){if(this.tokenChanged&&n.msbHost.tenantManager.isTenantMsbEnabled()){this.tokenChanged=!1;const t=this.getMsbToken();t&&(n.msbHost.tenantManager.isGccHighTenant()||this.sendMsbProactiveSignIn(t),this.tokenChangedHandlers&&this.tokenChangedHandlers.forEach(i=>{n.safeExecute(()=>i(t),"MsbTokenManager::fireTokenChanged")}))}}handleWsbAccessTokenAvailable(t){t==1&&(this.accountTypeChangedIsFiring||this.callGetMsbAccount(!1,t=>{this.notifyWsbAadReady(),!t||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.isTest)||(n.Host.refreshCurrentPane(!0),n.config.msbVerticalWorkScopeEnabled&&n.Host.updateScopeList(!0)),this.refresh3sTokenAndCall(()=>undefined,undefined,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleWsbAccessTokenAvailable"]:undefined)},"WsbAccessTokenAvailable",(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleWsbAccessTokenAvailable"]:undefined))}handleAccountTypeChanged(){this.accountTypeChangedIsFiring=!0;const t=t=>{this.callGetMsbAccount(!0,()=>{this.notifyWsbAadReady(),this.accountTypeChangedIsFiring=!1,n.Host.refreshCurrentPane(!0),n.config.msbVerticalWorkScopeEnabled&&n.Host.updateScopeList(!0),this.refresh3sTokenAndCall(()=>undefined,undefined,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleAccountTypeChanged"]:undefined)},t,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbTokenManager::handleAccountTypeChanged"]:undefined)};n.config.msbMockToken?this.getMockToken(()=>{t("AccountTypesChanged_withMockToken")}):t("AccountTypesChanged")}handleWsbSelectedAccountChanged(){this.msbAccount=undefined;this.substrateAccount=undefined;this.lokiAccount=undefined;this.userId=undefined;this.tenantId=undefined}handleWsbVerifyAccountRequired(n,t){let u;switch(n){case 1:u="AAD";break;case 0:u="MSA";break;default:u="Unknown"}if(u!="MSA"){let r;switch(t){case"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7":r="BingAtWork";break;case"https://www.bing.com/cortana":r="Cortana";break;case"https://graph.windows.net/":r="GraphWindowsApi";break;case"394866fc-eedb-4f01-8536-3ff84b16be2a":r="PeopleCard";break;case"https://outlook.office.com/":r="ProfilePictureApi";break;case"https://substrate.office.com":r="SubstrateEnterprise";break;case"service::cortana.bing.com::mbi_ssl":r="Cortana";break;case"LiveProfileCard.Access":r="PeopleCard";break;case"https://outlook.office.com/User.ReadWrite":case"https://outlook.office.com/M365.Access":r="ProfilePictureApi";break;case"https://substrate.office.com/SubstrateSearch-Internal.ReadWrite":case"https://substrate.office.com/M365.Access":r="SubstrateConsumer";break;default:r="Unknown"}const f=`${u}@${r}`;this.trySendValueEvents(i,f,{name:"WsbVerifyAccountRequired",value:"",kv:{authType:u,resourceOrScope:r}})}}setAadUserInfo(n){this.aadUserInfo=n}getAadUserInfo(){return this.aadUserInfo}createAadUserInfo(n){var t,i,r;return n?{tenantId:(t=n.TenantId)!==null&&t!==void 0?t:"",tenantName:(i=n.TenantName)!==null&&i!==void 0?i:"",userAadId:(r=n.UserObjectId)!==null&&r!==void 0?r:"",email:n.UserName}:undefined}updateTelemetryContext(t){var i,r;this.userId=t===null||t===void 0?void 0:t.userAadId;this.tenantId=t===null||t===void 0?void 0:t.tenantId;_w.bfbWsbTel&&bfbWsbTel.setUid((i=this.userId)!==null&&i!==void 0?i:"");_w.bfbWsbTel&&bfbWsbTel.setTenantId((r=this.tenantId)!==null&&r!==void 0?r:"");n.msbHost.tenantManager.checkAndSetIsMsbInternalTenant(this.tenantId)}clearUserTenantContext(){_w.bfbWsbTel&&bfbWsbTel.setUid("");_w.bfbWsbTel&&bfbWsbTel.setTenantId("");n.msbHost.tenantManager.checkAndSetIsMsbInternalTenant(undefined)}isThrottledLogInfoExpired(t,i){const u=n.LightweightStorage.getItem(i),r=this.parseCachedLogInfo(u);if(r==null||r.LogKey!=t)return!0;const f=n.config.msbLogThrottlingTimeInHours*36e5;return n.getCurrentTime()>r.SavedTimestamp+f?!0:!1}parseCachedLogInfo(n){const t=n===null||n===void 0?void 0:n.split(";");return!t||t.length!=2?undefined:{LogKey:t[1],SavedTimestamp:+t[0]}}trySendValueEvents(t,i,r){if(this.isThrottledLogInfoExpired(i,t)){_w.bfbWsbTel&&r&&bfbWsbTel.logValue(r.name,r.value,r.kv);const u=`${n.getCurrentTime()};${i}`;n.LightweightStorage.setItem(t,u)}}getMsbMockAccount(){var t;const i=n.getCurrentTime();return{Token:(t=this.mockToken)!==null&&t!==void 0?t:"",ExpireDateTime:i+36e5,RoutingHint:"OID:65e1aedd-5fe9-4100-8b57-7973687b78c4@72f988bf-86f1-41af-91ab-2d7cd011db47",UserObjectId:"65e1aedd-5fe9-4100-8b57-7973687b78c4",UserName:"msbtest",TenantId:"72f988bf-86f1-41af-91ab-2d7cd011db47",TenantName:"Microsoft",LastUpdated:i}}getMockToken(t){var i;const r=(i=n.config.msbMockTokenUrl)!==null&&i!==void 0?i:"";n.fetchUrl(r,undefined,undefined,n=>{if(n.status===200){try{this.mockToken=JSON.parse(n.responseText)}catch(i){this.mockToken=undefined}t()}else this.mockToken=undefined,t()},undefined,undefined,!0)}}n.MsbTokenManager=s}(WSB||(WSB={})),function(n){let t;(function(n){n[n.Unknown=0]="Unknown";n[n.Enabled=1]="Enabled";n[n.Disabled=2]="Disabled"})(t=n.TenantMsbStatus||(n.TenantMsbStatus={}));const f=["Edu"],e=n=>f.indexOf(n)!==-1,i=1440,r=360,u="MsbTenantSetting",o="000000",s="ffffff";class h{constructor(i){this.fetchingTenant=!1;this.tenantEnabledHandlers=[];this.tenantDisabledHandlers=[];this.tenantMsbStatus=t.Unknown;this.msbTenantVariants=[];this.isMsbEduTenantEnabled=!1;this.setTenantMsbUnknownStatus();n.config.msbCleanTenantSettingLocalStorage&&this.cleanLocalTenantSettingState();const r=this.getLocalTenantSettingState();this.setLastMsbEnabledTime(r===null||r===void 0?void 0:r.lastMsbEnabledTimestamp);i.bindMsbAccountAvailableTenantSettingHandler((n,t,i,r)=>{this.checkTenantSettings(n,t,i,r)});i.bindAadNotAvailable(()=>{this.cleanLocalTenantSettingState()})}bindTenantEnabled(n){this.tenantEnabledHandlers.push(n)}bindTenantDisabled(n){this.tenantDisabledHandlers.push(n)}shouldForceEnterpriseAccount(){return this.isTenantMsbEnabled()||n.config.msbUseCachedMsbState&&this.isTenantMsbStatusUnknown()&&this.isLastEnabledTimeValid()}hasBeenMsbUser(){return this.isTenantMsbEnabled()||n.config.msbUseCachedMsbState&&this.isLastEnabledTimeValid()}isLastEnabledTimeValid(){const t=n.getCurrentTime()-n.MsbStateExpiryTimeInMs;return typeof this.lastMsbEnabledTime=="number"&&this.lastMsbEnabledTime>t}setLastMsbEnabledTime(n){this.lastMsbEnabledTime=n}getLastMsbEnabledTime(){return this.lastMsbEnabledTime}getTenantMsbStatus(){return this.tenantMsbStatus}isTenantMsbEnabled(){return this.tenantMsbStatus===t.Enabled}isTenantMsbDisabled(){return this.tenantMsbStatus===t.Disabled}isTenantMsbStatusUnknown(){return this.tenantMsbStatus===t.Unknown}setTenantMsbEnabledStatus(){this.tenantMsbStatus=t.Enabled}setTenantMsbDisabledStatus(){this.tenantMsbStatus=t.Disabled;this.setIsMsbEduTenantEnabled(!1)}setTenantMsbUnknownStatus(){this.tenantMsbStatus=t.Unknown;this.setIsMsbEduTenantEnabled(!1)}getMsbTenantVariants(){return this.msbTenantVariants.join(",")}setMsbTenantVariants(n){this.msbTenantVariants=n}isMsbDsbEduEnabled(){return n.config.msbDsbEduEnabled&&this.getIsMsbEduTenantEnabled()}getIsMsbEduTenantEnabled(){return(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbEDUTenant)?this.isTenantMsbEnabled():this.isTenantMsbEnabled()&&this.isMsbEduTenantEnabled}setIsMsbEduTenantEnabled(n){this.isMsbEduTenantEnabled=n}setLocalTenantSettingState(t){const i=JSON.stringify(t);n.LightweightStorage.setItem(u,i)}cleanLocalTenantSettingState(){n.LightweightStorage.removeItem(u)}getLocalTenantSettingState(){const t=n.LightweightStorage.getItem(u);if(t)try{return JSON.parse(t)}catch(i){this.cleanLocalTenantSettingState()}return null}getStoredMsbTenantName(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.tenantDisplayName}getStoredMsbIcon(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.iconLarge}getStoredMsbIconLargeIsDefault(){var n,t;return((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)===null||t===void 0?void 0:t.iconLargeIsDefault)||!1}getStoredMsbNavColor(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.navColor}getStoredMsbFontColor(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.fontColor}getStoredMsbIsEdu(){var n,t;return((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)===null||t===void 0?void 0:t.isEdu)||!1}getStoredMsbTenantVariants(){var n,t;return((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)===null||t===void 0?void 0:t.tenantVariants)||[]}getStoredMsbTenantGroup(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.tenantGroup}checkAndSetIsMsbInternalTenant(t){this.isMsbInternalTenant=n.config.msbInternalTenants&&!!t&&n.contains(n.config.msbInternalTenants,t)}getIsMsbInternalTenant(){var t;return!n.config.disableMsbInternalTenants&&(((t=this.getStoredMsbTenantGroup())===null||t===void 0?void 0:t.toLowerCase())==="msft"||this.isMsbInternalTenant)}getIsLightHouseTenant(){var n;return((n=this.getStoredMsbTenantGroup())===null||n===void 0?void 0:n.toLowerCase())==="lighthouse"}isGccTenant(){var n;return typeof BingAtWork=="undefined"?!1:!!((n=BingAtWork.wsb)===null||n===void 0?void 0:n.gccRegion)}isGccHighTenant(){var n;return typeof BingAtWork=="undefined"?!1:((n=BingAtWork.wsb)===null||n===void 0?void 0:n.gccRegion)===2}isMsbEnterpriseScopeEnabled(){return this.isWorkScopeApplicable(!0)}isWorkScopeZiPageContentEnabled(){return(n.config.msbWorkScopeZiPageContentEnabled||n.config.msbWorkScopeZiPageContentEnabledMS&&this.getIsMsbInternalTenant())&&this.isWorkScopeApplicable()&&!this.isEduTenant(!0)}isWorkMruEnabled(){return(n.config.msbWorkScopeZiPageWorkMruEnabled||n.config.msbWorkSearchMruInShDsbEnabled)&&!this.isEduTenant(!0)}isEduMessagesCardEnabled(){return n.config.msbEduMessagesCardEnabled}isWorkScopeApplicable(t){return(n.config.msbVerticalWorkScopeEnabled&&!this.isEduTenant(t)||this.isEduScopeApplicable(t))&&this.shouldForceEnterpriseAccount()&&!this.isGccTenant()}isEduScopeApplicable(t){return this.isEduTenant(t)&&n.config.msbWorkScopeEduEnabled}isEduImageOfTheDayEnabled(t){return this.isEduTenant(t)&&n.config.msbDsbEduImageOfTheDayEnabled}isEduTenant(n){return n?this.getStoredMsbIsEdu():this.getIsMsbEduTenantEnabled()}isMsbWorkScope(t,i){return this.isWorkScopeApplicable()&&(t===21||i==n.Scope.Work)}isMsbWorkScopeDsbRedirectEnabled(){return this.isWorkScopeApplicable()&&(n.config.msbWorkScopeDsbRedirectEnabled&&this.getIsMsbInternalTenant()||n.config.msbWorkScopeDsbRedirectEnabledWW)}isMsbWorkScopeSHRedirectEnabled(){return this.isWorkScopeApplicable()&&(n.config.msbEnableSearchHomeWSRedirect&&this.getIsMsbInternalTenant()||n.config.msbEnableSearchHomeWSRedirectWW)}isMsbWorkUpsellApplicable(){return(n.config.msbWorkScopeBannerIndicatorEnabledWW||n.config.msbWorkScopeBannerIndicatorEnabled&&this.getIsMsbInternalTenant())&&this.isWorkScopeApplicable()&&(!n.MockUrlParameters||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.showWorkUpsell))}isWorkScopeListViewEnabled(){return this.isWorkScopeApplicable()&&(n.config.msbWorkScopeListEnabledWW||n.config.msbWorkScopeListEnabled&&this.getIsMsbInternalTenant())}redirectScope(n){switch(n){case"RecommendedPeople":case"ExpandedOrgChart":return this.isMsbWorkScopeDsbRedirectEnabled()?"Work":"People";case"PopularSearchesFeedFallback":return this.isMsbWorkScopeDsbRedirectEnabled()?"Work":"Web";case"People":case"Bookmarks":return this.isMsbWorkScopeSHRedirectEnabled()?"Work":"People";case"MFIL":return"Documents";case"MPPL":case"MGRP":return"People";case"MBKS":return"Web";default:return undefined}}getMsbBrandUri(){var n;try{const t=(n=this.getStoredMsbIcon())!==null&&n!==void 0?n:"";if(t==="")return"";const i=atob(t),r=i.startsWith("<svg")||i.startsWith("<?xml"),u=r?"svg+xml":"jpeg";return`data:image/${u};base64,${t}`}catch(t){return""}}getMsbBranding(){try{const t=this.getMsbBrandUri(),i=this.getStoredMsbIconLargeIsDefault(),r=`#${this.getStoredMsbNavColor()}`,u=`#${this.getStoredMsbFontColor()}`,n=this.getStoredMsbTenantName();return t||n?{logoDataUri:t,iconLargeIsDefault:i,backColor:r,companyName:n!==null&&n!==void 0?n:"",fontColor:u}:undefined}catch(n){return undefined}}tenantHasLogo(){var n,t;const i=(n=this.getMsbBranding())===null||n===void 0?void 0:n.logoDataUri,r=(t=this.getMsbBranding())===null||t===void 0?void 0:t.iconLargeIsDefault;return!!(i&&!r)}checkTenantSettings(t,i,r,u){let f=t,e;n.msbPerfLogger&&(typeof this.lastPerfMarkCallId=="undefined"&&(this.lastPerfMarkCallId=0),e=this.lastPerfMarkCallId++,n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsStarted,e),f=()=>{n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsReturned,e),t()});const o=n.getCurrentTime();this.shouldGetTenantSettings(o,u===null||u===void 0?void 0:u.RoutingHint)?this.checkTenantSettingsFromServer(f,n=>{this.checkTenantSettingsFromCache(f,()=>{(n===null||n===void 0?void 0:n.hasNativeIssue)||_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Tenant Settings Auth Fails and No Cached Results Available"),i(n)},r,u)},r,u,e):this.checkTenantSettingsFromCache(f,()=>{_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Tenant Settings No Cached Results Available"),i({})},r,u)}checkTenantSettingsFromCache(n,t,i,r){const u=this.getLocalTenantSetting();u?(this.updateTenantFlags(u,r,i),n()):(this.cleanLocalTenantSettingState(),t({}))}checkTenantSettingsFromServer(t,i,r,u,f){if(!this.fetchingTenant){this.fetchingTenant=!0;const h=(h,c)=>{var l,a,v,y;if(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsResponded,f),h===null||h===void 0?void 0:h.tenantSettings){const i={tenantId:h.tenantSettings.id,isEnabled:h.tenantSettings.isEnabled,isEdu:((l=h.tenantSettings.variants)===null||l===void 0?void 0:l.indexOf("Edu"))>=0,tenantVariants:(a=h.tenantSettings.variants)===null||a===void 0?void 0:a.filter(n=>e(n)),tenantDisplayName:h.tenantSettings.tenantDisplayName,iconLarge:h.tenantSettings.iconLargeIsDefault?"":h.tenantSettings.iconLarge,iconLargeIsDefault:h.tenantSettings.iconLargeIsDefault,navColor:((v=h.tenantSettings.themeColors)===null||v===void 0?void 0:v[1])||o,fontColor:((y=h.tenantSettings.themeColors)===null||y===void 0?void 0:y[2])||s,tenantGroup:h.tenantSettings.tenantGroup},f=n.getCurrentTime(),c=h.tenantSettings.isEnabled?f:undefined;this.updateTenantFlags(i,u,r);this.setLastMsbEnabledTime(c);this.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,200,f,c,i);this.fetchingTenant=!1;t()}else{const t=`Response: ${JSON.stringify(h)}`;const u=n.msbHost.tenantManager.getIsMsbInternalTenant()?t:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Empty Tenant Settings","",{serverTraceId:c,statusCode:200,additionalMessage:u},{caller:r});this.fetchingTenant=!1;i({})}},c=(f,e)=>{const c=`[MSB.Error] checkTenantSettings: onError: ${JSON.stringify({statusCode:f,ajaxErrorInfo:e})}`;const o=f===404,s=f===401||f===403,l=f===-1,h=n.getCurrentTime();if(o)this.handleMsbDisable(),this.setLastMsbEnabledTime(undefined),this.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,404,h,undefined,{tenantId:"",isEnabled:!1,tenantDisplayName:"",iconLarge:"",iconLargeIsDefault:!1,navColor:"",fontColor:"",isEdu:!1,tenantVariants:[],tenantGroup:""});else{const n=this.getLocalTenantSettingState();this.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,f,h,n===null||n===void 0?void 0:n.lastMsbEnabledTimestamp,n===null||n===void 0?void 0:n.tenantSettings)}if(f!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const i=o?"Wsb Fetch Tenant Settings Non MSB":"Wsb Fetch Tenant Settings Failed",{message:u,errorMessage:h,responseText:c,stackTrace:l,serverTraceId:a,requestSentTime:v,responseReceivedTime:y,isBrowserOnline:p,hResultString:w}=e,t=n.msbHost.tenantManager.getIsMsbInternalTenant()?`ResponseText: ${c}, ErrorMessages: ${h}`:"",b=s?`${t}, token=${JSON.stringify(n.getReducedTokenInfo(BingAtWork.wsb.wsbAccessToken))}`:t,k=n.msbHost.tenantManager.getIsMsbInternalTenant()?l:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(i,u,{stackTrace:k,serverTraceId:a,statusCode:f,additionalMessage:b},{caller:r,Online:p,HResult:w,ReqTS:v,ResTS:y})}this.fetchingTenant=!1;o?t():i({hasTokenIssue:s,hasNativeIssue:l})};n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsRequested,f);n.msbHost.dataAccess.getTenantSetting(h,c)}}updateTenantSettingStateCache(n,t,i,r,u){const f=this.getLocalTenantSettingState(),o=(f===null||f===void 0?void 0:f.failedTimes)||0;let e=o+1;(t===200||t===404||t==-1)&&(e=0);const s=this.getNextIntervalWaitTime(t,e),h={lastMsbEnabledTimestamp:r,lastTimestamp:i,nextRequestIntervalInMinutes:s,failedTimes:e,routingHint:n,tenantSettings:u};this.setLocalTenantSettingState(h)}shouldGetTenantSettings(n,t){const i=this.getLocalTenantSettingState();let r=!0;if(i){const{lastTimestamp:u,nextRequestIntervalInMinutes:f,routingHint:e}=i;t===e&&(r=n>u+f*6e4)}return r}handleMsbDisable(){this.setTenantMsbDisabledStatus();this.tenantDisabledHandlers&&this.tenantDisabledHandlers.forEach(t=>{n.safeExecute(()=>t(),"MsbTenantManager::fireTenantDisabled")})}getLocalTenantSetting(){const n=this.getLocalTenantSettingState();if(n!==null&&n!==void 0)return n.tenantSettings}updateTenantFlags(t,i,r){const{isEnabled:u,isEdu:f,tenantVariants:e}=t;u?(this.setTenantMsbEnabledStatus(),this.setIsMsbEduTenantEnabled(f),this.setMsbTenantVariants(e),this.tenantEnabledHandlers&&this.tenantEnabledHandlers.forEach(t=>{n.safeExecute(()=>t(i===null||i===void 0?void 0:i.RoutingHint,r),"MsbTenantManager::fireTenantEnabled")})):this.handleMsbDisable()}getNextIntervalWaitTime(t,u){let f=0;if(t===200||t===404)f=n.getRandomNumInRange(i,r);else if(u<=n.config.msbTenantSettingRetryNoWaitFailedTimes||t==-1)f=0;else{const e=(u-n.config.msbTenantSettingRetryNoWaitFailedTimes)*n.config.msbTenantSettingRetryInMin;f=t==503||t==429?f+e*3:f+e*4;f>=i+r&&(f=n.getRandomNumInRange(i,r))}return f}}n.MsbTenantManager=h}(WSB||(WSB={})),function(n){const f=21600,e=10080,t=1440,i=360,r="MsbUserConfig",u=1,o=4;class s{constructor(t,i){this.msbTokenManager=t;this.msbTenantManager=i;this.fetchingUserConfig=!1;n.Host.bindAccountChanged(()=>{this.cleanLocalUserConfigState(),this.setHasEduAssignmentsFlags(!1)});i.bindTenantEnabled(()=>{i.getIsMsbEduTenantEnabled()&&this.checkUserConfig(()=>{},()=>{},"MsbUserConfigManagerTenantEnabled",t.getMsbAccountRoutingHint())});t.bindTokenChanged(()=>{i.getIsMsbEduTenantEnabled()&&this.checkUserConfig(()=>{},()=>{},"MsbUserConfigManagerTokenChanged",t.getMsbAccountRoutingHint())})}setHasEduAssignmentsFlags(n){this.hasEduAssignments=n}getHasEduAssignmentsFlags(){return this.hasEduAssignments}checkUserConfig(t,i,r,u){let e=t,f;n.msbPerfLogger&&(typeof this.lastPerfMarkCallId=="undefined"&&(this.lastPerfMarkCallId=0),f=this.lastPerfMarkCallId++,n.msbPerfLogger.mark(n.MsbPerfProbe.UserConfigStarted,f),e=()=>{n.msbPerfLogger.mark(n.MsbPerfProbe.UserConfigReturned,f),t()});const o=n.getCurrentTime();this.shouldGetUserConfigState(o,u)?this.checkUserConfigFromServer(e,n=>{(n===null||n===void 0?void 0:n.hasNativeIssue)||_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch User Config Auth Fails and No Cached Results Available"),i(n)},r,u,undefined):this.checkUserConfigFromCache(()=>undefined,()=>undefined,r,u)}shouldGetUserConfigState(n,t){const i=this.getLocalUserConfigState();let r=!0;if(i){const{lastTimestamp:u,nextRequestIntervalInMinutes:f,routingHint:e}=i;t===e&&(r=n>u+f*6e4)}return r}checkUserConfigFromCache(n,t){var i;const r=(i=this.getLocalUserConfigState())===null||i===void 0?void 0:i.userConfig;r?this.setHasEduAssignmentsFlags(r.hasAssignments):t({})}getUserConfigsRequest(){return{clientContext:{clientType:"Wsb"},requiredConfigs:["LicenseSettings","EduSettings"]}}checkUserConfigFromServer(t,i,r,u,f){if(!this.fetchingUserConfig){this.fetchingUserConfig=!0;const e=n.msbHost.urlUtils.getMsbUrl("v3/user/data/configs"),o={url:e,body:JSON.stringify(this.getUserConfigsRequest()),requestType:"POST",onSuccess:(e,o)=>{var s,h;if(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.UserConfigResponded,f),e===null||e===void 0?void 0:e.user){const i={id:e.user.id,hasAssignments:(s=e.eduSettings)===null||s===void 0?void 0:s.hasAssignments,hasClasses:(h=e.eduSettings)===null||h===void 0?void 0:h.hasClasses,LicenseNames:e.licenseSettings?e.licenseSettings.enabledLicenses:[]},r=n.getCurrentTime();this.setHasEduAssignmentsFlags(i===null||i===void 0?void 0:i.hasAssignments);this.updateUserConfigStateCache(u,200,r,r,i);this.fetchingUserConfig=!1;t()}else{const n=`Response: ${JSON.stringify(e)}`;const t=this.msbTenantManager.getIsMsbInternalTenant()?n:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Empty User Config","",{serverTraceId:o,statusCode:200,additionalMessage:t},{caller:r});this.fetchingUserConfig=!1;i({})}},onError:(f,e)=>{const l=`[MSB.Error] checkUserConfig: onError: ${JSON.stringify({statusCode:f,ajaxErrorInfo:e})}`;const o=f===404,s=f===401||f===403,a=f===-1,h=n.getCurrentTime();if(o)this.updateUserConfigStateCache(u,404,h,undefined,{id:"",hasAssignments:!1,hasClasses:!1});else{const n=this.getLocalUserConfigState();this.updateUserConfigStateCache(u,f,h,n===null||n===void 0?void 0:n.lastMsbEnabledTimestamp,n===null||n===void 0?void 0:n.userConfig)}const v=o?"Wsb Fetch User Config Not found":"Wsb Fetch User Config Failed",{message:y,errorMessage:p,responseText:w,stackTrace:b,serverTraceId:k,requestSentTime:d,responseReceivedTime:g,isBrowserOnline:nt,hResultString:tt}=e,c=this.msbTenantManager.getIsMsbInternalTenant()?`ResponseText: ${w}, ErrorMessages: ${p}`:"",it=s?`${c}, token=${JSON.stringify(n.getReducedTokenInfo(BingAtWork.wsb.wsbAccessToken))}`:c,rt=this.msbTenantManager.getIsMsbInternalTenant()?b:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(v,y,{stackTrace:rt,serverTraceId:k,statusCode:f,additionalMessage:it},{caller:r,Online:nt,HResult:tt,ReqTS:d,ResTS:g});this.fetchingUserConfig=!1;o?t():i({hasTokenIssue:s,hasNativeIssue:a})}};n.Msb.sendAjax(o)}}updateUserConfigStateCache(t,i,u,f,e){var o;const s=this.getLocalUserConfigState(),c=(o=s===null||s===void 0?void 0:s.failedTimes)!==null&&o!==void 0?o:0;let h=c+1;(i===200||i===404||i==-1)&&(h=0);const l=this.getNextIntervalWaitTime(i,h),a={lastMsbEnabledTimestamp:f,lastTimestamp:u,nextRequestIntervalInMinutes:l,failedTimes:h,routingHint:t,userConfig:e};n.LightweightStorage.setItem(r,JSON.stringify(a))}getNextIntervalWaitTime(r,s){let h=0;if(r===200)h=n.getRandomNumInRange(f,e);else if(r===404)h=n.getRandomNumInRange(t,i);else if(s<=u||r==-1)h=0;else{const f=(s-u)*o;h=r==503||r==429?h+f*3:h+f*4;h>=t+i&&(h=n.getRandomNumInRange(t,i))}return h}cleanLocalUserConfigState(){n.LightweightStorage.removeItem(r)}getLocalUserConfigState(){const t=n.LightweightStorage.getItem(r);if(t)try{return JSON.parse(t)}catch(i){this.cleanLocalUserConfigState()}return null}}n.MsbUserConfigManager=s}(WSB||(WSB={})),function(n){var t;(function(t){function h(t,i){var f,e,o,s,h,v;const u=(n,i)=>{if(t.onError!=null)t.onError(n,i)};if(t==null||!t.url){u(n.ClientErrorCode.UrlUnavailable,{message:"MsbAjax.sendAjax: no url available for request, won't send the request."});return}let r;if(t.useToken==="WSB3S"){if(r=(e=(f=_w.BingAtWork)===null||f===void 0?void 0:f.wsb)===null||e===void 0?void 0:e.wsb3sAccessToken,!r){u(n.ClientErrorCode.NoToken,{message:"MsbAjax.sendAjax: no WSB/3S access token, won't send the request."});return}}else if(t.useToken==="WSBLoki"){if(r=(s=(o=_w.BingAtWork)===null||o===void 0?void 0:o.wsb)===null||s===void 0?void 0:s.wsbLokiAccessToken,!r){u(n.ClientErrorCode.NoMsbLokiAccessToken,{message:"MsbAjax.sendAjax: no WSB/Loki access token, won't send the request."});return}}else{if(r=(v=(h=_w.BingAtWork)===null||h===void 0?void 0:h.wsb)===null||v===void 0?void 0:v.wsbAccessToken,!r){u(n.ClientErrorCode.NoToken,{message:"MsbAjax.sendAjax: no WSB access token, won't send the request."});return}const t=c();if(t){u(n.ClientErrorCode.MsbTokenExpiredBeforeRequest,t);return}}t.url[0]==="/"&&(t.url=(_w==null?"":_w.location.origin)+t.url);n.config.msbUseXmlHttpRequest?a(t,r,u,i):l(t,r,u,i)}function c(){var i,r;const t=(i=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||i===void 0?void 0:i.wsbAccessTokenJwtExp;if(t){const i=n.getCurrentTime(),u=t-i;if(u<0){const n=(r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||r===void 0?void 0:r.wsbAccessTokenRefreshTime,f=i-(n||0);return{message:`${"Wsb token expired before request"} {[MsbAjax].sendAjax}, rt=${n}, jwtExp=${t}, now=${i}`}}}return undefined}function l(t,i,r,e){let h=0;switch(t.requestType){case"POST":h=1;break;case"PUT":h=4}const c=SearchAppWrapper.CortanaApp,a=c.createStringMap(),s=c.createStringMap();s["User-Agent"]=navigator.userAgent;s.Authorization=`Bearer ${i}`;s.Accept="*/*";a["Content-Type"]="application/json";for(const n in t.headers)s[n]=t.headers[n];const v=performance.now(),l=new Date,o=l.getTime();n.Async.safeChain("makeHttpRequestAsync_MsbAjax_Ajax",()=>c.makeHttpRequestAsync(h,t.url,s,t.body||"",a),i=>{const h=n.getCurrentTime(),{serverTraceId:s,serverTime:c,serverLatency:a}=f(i===null||i===void 0?void 0:i.headers);if(u(t,c,o,s,"MsbAjax::sendCortanaAppHttpRequest"),t.onRoundTripReport){const n=i.statusCode==200?undefined:`HTTP${i.statusCode}`,r=performance.now(),u=new Date,f=i.statusCode;t.onRoundTripReport({startTime:v,endTime:r,startDateTime:l,endDateTime:u,serverLatency:a,errorMessage:n,status:f,traceId:s})}i.statusCode===200?n.Async.safeChain(`msbajax_ReadResponse`,()=>i.readAsStringAsync(),i=>{if(t.onSuccess!=null){let u=null;if(i!=="")try{u=e?i:JSON.parse(i)}catch(f){r(n.ClientErrorCode.ResponseJsonParseError,{message:"Bad data",responseText:i,serverTraceId:s,requestSentTime:o,responseReceivedTime:h});return}t.onSuccess(u,s)}},t=>{r(n.ClientErrorCode.ReadResponseError,{message:"readAsStringAsync_makeHttpRequestAsync_MsbAjax Error",errorMessage:`Name: ${t.name}, message: ${t.message}`,stackTrace:`${t.stack}`,serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},undefined,undefined,0):n.Async.safeChain("readNon200Response",()=>i.readAsStringAsync(),n=>{r(i.statusCode,{message:`Ajax call failed with status ${i.statusCode.toString()}. No retries attempted.`,responseText:n,serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},t=>{r(n.ClientErrorCode.ReadResponseError,{message:"readAsStringAsync_Non200_makeHttpRequestAsync_MsbAjax Error",errorMessage:`Name: ${t.name}, Message: ${t.message}`,stackTrace:`${t.stack}`,serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},undefined,undefined,0)},i=>{if(t.onRoundTripReport){const i=`Promise error makeHttpRequestAsync_MsbAjax Error`,r=performance.now(),u=new Date,f=n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError;t.onRoundTripReport({startTime:v,endTime:r,startDateTime:l,endDateTime:u,errorMessage:i,status:f})}const u={message:`Promise error makeHttpRequestAsync_MsbAjax Error`,errorMessage:`Name: ${i.name}, Message: ${i.message}, RequestType: ${h}, RequestUrl: ${t.url} `,stackTrace:`${i.stack}`,requestSentTime:o,responseReceivedTime:n.getCurrentTime(),isBrowserOnline:navigator.onLine},f=i===null||i===void 0?void 0:i.number;typeof f=="number"&&(u.hResultString=n.formatHResultString(f));r(n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError,u)},undefined,undefined,0)}function a(t,i,r,s){const h={};h.Authorization=`Bearer ${i}`;h["Content-Type"]="application/json";for(const n in t.headers)h[n]=t.headers[n];const a=t.body||"",y=performance.now(),l=new Date,c=l.getTime(),w=i=>{var o;const h=n.getCurrentTime(),{serverTraceId:e,serverTime:a,serverLatency:w}=f(i===null||i===void 0?void 0:i.responseHeaders);if(u(t,a,c,e,"MsbAjax::sendXmlHttpRequest"),t.onRoundTripReport){const n=(i===null||i===void 0?void 0:i.status)==200?undefined:`HTTP${i===null||i===void 0?void 0:i.status}-RequestState${i===null||i===void 0?void 0:i.result}`,r=performance.now(),u=new Date,f=i.status;t.onRoundTripReport({startTime:y,endTime:r,startDateTime:l,endDateTime:u,serverLatency:w,errorMessage:n,status:f,traceId:e})}if((i===null||i===void 0?void 0:i.result)==0&&i.status==200){try{const n=s?i.responseText:JSON.parse(i.responseText);v(t);(o=t.onSuccess)===null||o===void 0?void 0:o.call(t,n,e)}catch(k){r(n.ClientErrorCode.ResponseJsonParseError,{message:"[MsbAjax]sendXmlHttpRequest Bad data",responseText:i.responseText,serverTraceId:e,requestSentTime:c,responseReceivedTime:h})}return}const b=(i===null||i===void 0?void 0:i.status)?i.status:p(i.result);r(b,{message:`[MsbAjax]sendXmlHttpRequest Error. ResponseStatus=${i===null||i===void 0?void 0:i.status}, ResultCode=${i.result}`,responseText:i===null||i===void 0?void 0:i.responseText,serverTraceId:e,requestSentTime:c,responseReceivedTime:h})};n.fetchUrl(t.url,h,a,w,undefined,undefined,undefined,o,undefined,t.requestType,e)}function u(t,i,r,u,f){if(n.config.msbServerClientTimeSkewLimitMins&&t.checkServerTime&&i){const e=i-r,o=`[${f}] returned, ServerTime=${i}, ClientTime=${r}, diff=${e}, urlBase=${n.msbHost.urlUtils.getUrlBaseInfo(t.url)}`,h=`Target URL: ${t.url}`;if(Math.abs(e)>n.config.msbServerClientTimeSkewLimitMins*s){const t=n.msbHost.tenantManager.getIsMsbInternalTenant()?h:undefined;bfbWsbTel.logError("Wsb server and client time mismatch",o,{serverTraceId:u,additionalMessage:t})}}}function v(n){const t=y(n.url);!t||bfbWsbTel.logValue("SuccessRequest",t)}function y(n){return n.indexOf("v2/tenant/my/settings")>-1?"v2/tenant/my/settings":n.indexOf("v3/user/token/Substrate")>-1?"v3/user/token/Substrate":n.indexOf("search/api/v2/query")>-1?"search/api/v2/query":undefined}function p(t){switch(t){case 2:return n.ClientErrorCode.Aborted;case 3:return n.ClientErrorCode.XhrError;case 1:return n.ClientErrorCode.TimedOut;default:return n.ClientErrorCode.XhrCompleted}}function f(t){const u=t===null||t===void 0?void 0:t[i],f=t===null||t===void 0?void 0:t[r];if(u||f)return{serverTraceId:u,serverLatency:f};const e=n.getMsEdgeRef(t),{traceId:o,timestamp:s}=e||{};return{serverTraceId:o,serverTime:s}}const i="request-id",r="x-end2endlatencyms",e=["x-msedge-ref",i,r],o=1e4,s=6e4;t.sendAjax=h})(t=n.Msb||(n.Msb={}))}(WSB||(WSB={})),function(n){class t{constructor(t,i,r){this.responseContext=t;this.errorMessage=i;this.innerError=r;this.isBrowserOnline=navigator.onLine;t.statusCode===n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError&&typeof(r===null||r===void 0?void 0:r.number)=="number"&&(this.hResultString=n.formatHResultString(r.number))}}n.MsbHttpError=t;const i=6e4;class r{async sendHttpAsync(t){return this.validateRequest(t),this.validateTokenExpiry(t),n.config.msbDsbUseFetch||t.url.startsWith("http://localhost")?await this.fetchWrapperAsync(t):await this.makeHttpRequestWrapperAsync(t)}validateRequest(i){if(!i.url){const i=`[MsbHttpWrapper].sendHttpAsync failed with no url`;throw new t({statusCode:n.ClientErrorCode.UrlUnavailable},{publicMessage:i});}try{new URL(i.url)}catch(r){const u=`[MsbHttpWrapper].sendHttpAsync failed with ill-formed url`;throw new t({statusCode:n.ClientErrorCode.UrlUnavailable},{publicMessage:u,privateMessage:i.url},r);}if(!(i===null||i===void 0?void 0:i.token)){const i=`[MsbHttpWrapper].sendHttpAsync failed with no token.`;throw new t({statusCode:n.ClientErrorCode.NoToken},{publicMessage:i});}}async makeHttpRequestWrapperAsync(n){const r=this.buildMakeHttpRequestParameters(n),t=await this.callMakeHttpRequestApiAsync(r),{responseContext:i}=t;this.checkServerTime(n,i,"makeHttpRequestWrapperAsync");const u=await this.parseApiCallResultAsync(t,"makeHttpRequestWrapperAsync");return{responseContext:i,result:u}}buildMakeHttpRequestParameters(i){try{const{method:f,url:e,token:o,headers:r,body:s}=i,h=f==="POST"?1:0,t=SearchAppWrapper.CortanaApp.createStringMap();t["User-Agent"]=navigator.userAgent;t.Authorization=`Bearer ${o}`;t.Accept="*/*";t["X-Search-TrafficType"]="WsbClient";t["X-MSEdge-UILang"]=n.Host.getLanguage();const u=SearchAppWrapper.CortanaApp.createStringMap();u["Content-Type"]="application/json";for(const n in r)n.toLowerCase().startsWith("content-")?u[n]=r[n]:t[n]=r[n];const c=s||"";return{requestMethod:h,url:e,requestHeaders:t,body:c,contentHeaders:u}}catch(r){throw new t({statusCode:n.ClientErrorCode.MsbHttpBuildApiParameterError},{publicMessage:`[MsbHttpWrapper].buildMakeHttpRequestParameters failed`},r);}}async callMakeHttpRequestApiAsync(i){const{requestMethod:s,url:h,requestHeaders:c,body:l,contentHeaders:a}=i;let f,e,r;try{if(f=n.getCurrentTime(),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbHttpFail)==="at-call")throw new Error("mocked failed error at call");r=await SearchAppWrapper.CortanaApp.makeHttpRequestAsync(s,h,c,l,a);e=n.getCurrentTime()}catch(o){return Promise.reject(new t({statusCode:n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError},{publicMessage:`[MsbHttpWrapper].callMakeHttpRequestApiAsync failed when calling API`},o))}let u;try{if((n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbHttpFail)==="at-read")throw new Error("mocked failed error at read");u=await r.readAsStringAsync()}catch(o){return Promise.reject(new t({statusCode:r.statusCode},{publicMessage:`[MsbHttpWrapper].callMakeHttpRequestApiAsync failed when reading response`,privateMessage:u},o))}const{traceId:v,timestamp:y}=n.getMsEdgeRef(r.headers)||{},p={statusCode:r.statusCode,serverTraceId:v,requestSentTime:f,responseReceivedTime:e,serverTime:y};return{responseContext:p,responseText:u}}async fetchWrapperAsync(n){const r=this.buildFetchParameters(n),t=await this.callFetchApiAsync(r),{responseContext:i}=t;this.checkServerTime(n,i,"fetchWrapperAsync");const u=await this.parseApiCallResultAsync(t,"fetchWrapperAsync");return{responseContext:i,result:u}}buildFetchParameters(i){try{const{method:r,url:f,token:e,body:o,headers:u}=i,t=new Headers;t.append("User-Agent",navigator.userAgent);t.append("Authorization",`Bearer ${e}`);t.append("X-Search-TrafficType","WsbClient");t.append("X-MSEdge-UILang",n.Host.getLanguage());t.append("Content-Type","application/json");for(const n in u)t.append(n,u[n]);const s=r=="GET"?undefined:o||"";return{url:f,method:r,body:s,headers:t}}catch(r){throw new t({statusCode:n.ClientErrorCode.MsbHttpBuildApiParameterError},{publicMessage:`[MsbHttpWrapper].buildFetchParameters failed`},r);}}async callFetchApiAsync(i){const{url:s,method:h,body:c,headers:l}=i;let f,e,r;try{if(f=n.getCurrentTime(),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbHttpFail)==="at-call")throw new Error("mocked failed error at call");r=await fetch(s,{method:h,body:c,headers:l});e=n.getCurrentTime()}catch(o){return Promise.reject(new t({statusCode:n.ClientErrorCode.FetchError},{publicMessage:`[MsbHttpWrapper].callFetchApiAsync failed when calling API`},o))}let u;try{if((n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbHttpFail)==="at-read")throw new Error("mocked failed error at read");u=await r.text()}catch(o){return Promise.reject(new t({statusCode:r.status},{publicMessage:`[MsbHttpWrapper].callFetchApiAsync failed when reading response`,privateMessage:u},o))}const{traceId:a,timestamp:v}=n.getMsEdgeRef(r.headers)||{},y={statusCode:r.status,serverTraceId:a,requestSentTime:f,responseReceivedTime:e,serverTime:v};return{responseContext:y,responseText:u}}async parseApiCallResultAsync(n,i){const{responseContext:u,responseText:r}=n;if(u.statusCode==200)try{return JSON.parse(r)}catch(f){const e=r==="";let n="";return f instanceof SyntaxError&&(n=`, syntaxError=${f.message}`),Promise.reject(new t(u,{publicMessage:`[MsbHttpWrapper].parseApiCallResultAsync(${i}) failed, emptyResponse=${e}`+n,privateMessage:r},f))}else return Promise.reject(new t(u,{publicMessage:`[MsbHttpWrapper].parseApiCallResultAsync(${i}) failed non-HTTP200`,privateMessage:r}))}validateTokenExpiry(i){const r=i.tokenJwtExp;if(r){const u=n.getCurrentTime(),f=r-u;if(f<0){const e=i.tokenRefreshTime,o=u-(e||0);throw new t({statusCode:n.ClientErrorCode.MsbTokenExpiredBeforeRequest},{publicMessage:`{[MsbHttpWrapper].sendHttpAsync}, rt=${e}, jwtExp=${r}, now=${u}`});}}}checkServerTime(t,r,u){if(n.config.msbServerClientTimeSkewLimitMins&&t.checkServerTime){const{serverTime:f,requestSentTime:e,serverTraceId:o}=r;if(f&&e){const r=f-e,s=`[MsbHttpWrapper].${u} returned, ServerTime=${f}, ClientTime=${e}, diff=${r}, urlBase=${n.msbHost.urlUtils.getUrlBaseInfo(t.url)}`,h=`Target URL: ${t.url}`;if(Math.abs(r)>n.config.msbServerClientTimeSkewLimitMins*i){const t=n.msbHost.tenantManager.getIsMsbInternalTenant()?h:undefined;bfbWsbTel.logError("Wsb server and client time mismatch",s,{serverTraceId:o,additionalMessage:t})}}}}}n.MsbHttpWrapper=r}(WSB||(WSB={})),function(n){const i={["Person"]:"People",["Group"]:"Group",["Bookmark"]:"Bookmark",["Building"]:"Building",["Qna"]:"EditorialQnA",["File"]:"File",["Acronym"]:"Acronym"},r=6048e5,t=/[0-9a-zA-Z]/,u=/\s+/g;class f{getTenantSetting(t,i){n.msbHost.tokenManager.refreshMsbTokenAndCall(()=>{this.fetchTenantSettings(t,i)},()=>{i(n.ClientErrorCode.RefreshTokenFailure,{message:"MsbDataAccess.getTenantSetting"})},undefined,"GetTenantSetting")}fetchTenantSettings(t,i){const r=n.msbHost.urlUtils.getMsbUrl("v2/tenant/my/settings"),u=n.config.msbTenantSettingThemeOff?n.msbHost.urlUtils.insertParameter(r,"variants=msbtntthemeoff"):r,f={url:u,checkServerTime:!0,onSuccess:t,onError:i};n.Msb.sendAjax(f)}fetchSearchResponse(t,i,r,u,f){n.msbHost.tokenManager.refresh3sTokenAndCall(()=>{this.fetchMsb3sQueryResponse(t,i,r,u,f)},()=>{_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane No Msb 3s Token",""),u()},(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbDataAccess::fetchSearchResponse"]:undefined)}fetchMsb3sQueryResponse(t,i,r,u,f){var e;const s={[0]:n.config.msb3sQueryUrl,[1]:n.config.msb3sQueryUrl,[2]:n.config.msbUsGov3sQueryUrl},h=((e=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||e===void 0?void 0:e.gccRegion)?s[BingAtWork.wsb.gccRegion]:n.config.msb3sQueryUrl,o=this.buildMsb3sQueryRequest(t,i),c=JSON.stringify(o);this.fireResetSearchOptions(f);const l={url:h,useToken:"WSB3S",requestType:"POST",body:c,onSuccess:(f,e)=>{if(f)if(this.is3sResponseEmpty(f,i)){const i=`[MSB.Error] fetchMsb3sQueryResponse received empty searchResponse or searchResponse.results for query ${t}`;const r=n.msbHost.tenantManager.getIsMsbInternalTenant()?i:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Search Response Empty Results","",{serverTraceId:e,additionalMessage:r});u()}else r(f,o);else{const n=`[MSB.Error] fetchMsb3sQueryResponse received empty response for query ${t} of intent ${i}`;_w.bfbWsbTel&&bfbWsbTel.logError("Wsb 3S Query Response is Empty","",{serverTraceId:e});u()}},onError:(r,f)=>{const{responseText:e,message:o,errorMessage:c,stackTrace:s,serverTraceId:h,requestSentTime:l,responseReceivedTime:a,isBrowserOnline:v,hResultString:y}=f,p=`[MSB.Error] fetchMsb3sQueryResponse failed, details=${JSON.stringify({queryText:t,intent:i,statusCode:r,responseText:e,message:o,stackTrace:s,serverTraceId:h})}`;if(r!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const u=n.msbHost.tenantManager.getIsMsbInternalTenant()?`Query: ${t}, intent: ${i}, responseText: ${e}, errorMEssage: ${c}`:"",f=n.msbHost.tenantManager.getIsMsbInternalTenant()?s:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Search Response Failed",o,{stackTrace:f,serverTraceId:h,statusCode:r,additionalMessage:u},{Online:v,HResult:y,ReqTS:l,ResTS:a})}u()},onRoundTripReport:n=>{this.fireRoundTripTime("SubstrateSearch_RoundTripTime",n)},headers:{["X-Client-LocalTime"]:n.getDateWithTimezone()}};n.Msb.sendAjax(l)}getPersonPhotoData(t,i,r){n.msbHost.tokenManager.refreshMsbTokenAndCall(()=>this.fetchPersonPhotoData(t,i,r),()=>{r(undefined)},undefined,"GetPersonPhotoData")}fetchPersonPhotoData(t,i,r){let u="",f="";const e={};let o="GET";const s=t.indexOf("@")>-1,h=i?n.msbHost.urlUtils.getMsbUrl("v3/search/person/photo"):n.msbHost.urlUtils.getMsbUrl("v3/search/group/photo");if(s){u=h;o="POST";const n={clientContext:{clientType:"Wsb"},id:t};f=JSON.stringify(n)}else{const n=`clientType=Wsb&id=${t}`;u=`${h}?${n}`;e.Accept="application/json"}const c={url:u,requestType:o,body:f,headers:e,onSuccess:n=>{const t=n&&(n.imageInBase64||n.ImageInBase64);t?r(`data:image/jpeg;base64,${t}`):r(undefined)},onError:(t,u)=>{const{responseText:h,message:f,stackTrace:c,serverTraceId:e,requestSentTime:l,responseReceivedTime:a,isBrowserOnline:v,hResultString:y}=u,o=`[MSB.Error] fetching person/group photo, details=${JSON.stringify({statusCode:t,responseText:h,message:f,stackTrace:c,serverTraceId:e})}`;if(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const r=n.msbHost.tenantManager.getIsMsbInternalTenant()?o:"",u=i?"Wsb Fetch Person Photo Failed":"Wsb Fetch Group Photo Failed",h=s?"ByEmail":"ById";_w.bfbWsbTel&&bfbWsbTel.logHttpError(u,`${h}-${f}`,{serverTraceId:e,additionalMessage:r,statusCode:t},{Online:v,HResult:y,ReqTS:l,ResTS:a})}r(undefined)}};n.Msb.sendAjax(c)}fireResetSearchOptions(t){var i,r;const u={messageType:"MSB_RESET_SEARCH_OPTIONS",payload:{wsbIG:(i=window===null||window===void 0?void 0:window._G)===null||i===void 0?void 0:i.IG,wsbCvid:n.Host.getConversationId(),wsbLogicalId:(r=window===null||window===void 0?void 0:window._G)===null||r===void 0?void 0:r.IG,clientType:n.msbHost.getClientType(t)}};n.safeExecute(()=>{window.postMessage(u,window.location.origin)},"fireResetSearchOptions")}fireSearchResponse(t,i,r){const u=this.buildMsb3sQueryRequest(t),f=n.Host.createGuid(),e={messageType:"MSB_SET_3S_QUERY_RESPONSE",payload:{requestId:f,request:u,response:r,queryText:i}};n.safeExecute(()=>{window.postMessage(e,window.location.origin)},"fireSearchResponse")}fireClientQfResponse(t,i,r){this.fireResetSearchOptions(r);const u=i,f=this.buildMsb3sQueryRequest(t),e={messageType:"MSB_SET_CLIENT_QF_RESPONSE",payload:{request:f,response:u}};n.safeExecute(()=>{window.postMessage(e,window.location.origin)},"fireClientQfResponse")}fireRoundTripTime(t,i){const r=Object.assign({eventId:t},i);const u={messageType:"MSB_SEARCH_RTT",payload:r};n.safeExecute(()=>{window.postMessage(u,window.location.origin)},"fireRoundTripTime")}buildMsb3sQueryRequest(t,r){var f,e;const u=r&&i[r],o=u!=null?[u]:[];switch(r){case"File":return{Cvid:n.Host.getConversationId(),LogicalId:(f=window===null||window===void 0?void 0:window._G)===null||f===void 0?void 0:f.IG,EntityRequests:[{Query:{QueryString:t,DisplayQueryString:t},ContentSources:["SharePoint","OneDriveBusiness"],EntityType:u!==null&&u!==void 0?u:"",From:0,Size:1}],Scenario:{Name:"Wsb.PreviewPane"},TextDecorations:"Off"};default:return{Cvid:n.Host.getConversationId(),LogicalId:(e=window===null||window===void 0?void 0:window._G)===null||e===void 0?void 0:e.IG,AnswerEntityRequests:[{Query:{QueryString:t},EntityTypes:o,From:0,Size:r=="Acronym"&&n.config.msbClientQfEnableAcronymAllResult?10:1}],Scenario:{Name:"Wsb.PreviewPane"},TextDecorations:"Off"}}}is3sResponseEmpty(n,t){if(t==="File"){const t=n;return!t.EntitySets||t.EntitySets.length===0}else{const t=n;return!t.AnswerEntitySets||t.AnswerEntitySets.length===0}}createGetPersonIcon(t,i,u,f){return(e,o)=>{let s=!1;const h=n.LightweightStorage.getItem(n.msbHost.qfUtils.getPersonIconStorageKey(t));if(h){let i;try{i=JSON.parse(h)}catch(u){const i=`[MSB.Error] MsbQfSuggestionsParser.createGetPersonIcon: Person icon cache is broken.
                            uid=${t},
                            cacheString=${h},
                            error.message=${u===null||u===void 0?void 0:u.message}`;const r=n.msbHost.tenantManager.getIsMsbInternalTenant()?i:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb person icon cache broken","",{additionalMessage:r});n.LightweightStorage.removeItem(n.msbHost.qfUtils.getPersonIconStorageKey(t))}i&&(n.getCurrentTime()-i.lastUpdatedTime<r?(o(i.data),s=!0):n.LightweightStorage.removeItem(n.msbHost.qfUtils.getPersonIconStorageKey(t)))}s&&f||this.getPersonPhotoData(t,i,i=>{let r=u;if(i){r=n.toIcon(i,"createGetPersonIcon");const u={data:r,lastUpdatedTime:n.getCurrentTime()};(t.indexOf("@")>-1||n.config.msbUseCacheForPhotos)&&n.LightweightStorage.setItem(n.msbHost.qfUtils.getPersonIconStorageKey(t),JSON.stringify(u))}r.className="peopleIcon";s||o(r)})}}getBookmarkIcon(){return{content:"&#xEB8F",type:2}}getAcronymIcon(){return{content:"&#xE82D",type:2}}getMsbQnaIcon(n,t){t({type:0,className:"msb-suggIcon",content:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDQ4IDIwNDgiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+DQogIDxwYXRoIGQ9Ik0xNzYyIDE1OTBxNjYgMzIgMTE4IDgwdDkwIDEwOCA1OCAxMjggMjAgMTQyaC0xMjhxMC03OS0zMC0xNDl0LTgzLTEyMi0xMjItODItMTQ5LTMxcS03OSAwLTE0OSAzMHQtMTIyIDgzLTgyIDEyMi0zMSAxNDloLTEyOHEwLTczIDIwLTE0MXQ1Ny0xMjggOTAtMTA4IDExOS04MXEtNzUtNTQtMTE2LTEzNXQtNDItMTc1cTAtNzkgMzAtMTQ5dDgyLTEyMiAxMjItODMgMTUwLTMwcTc5IDAgMTQ5IDMwdDEyMiA4MiA4MyAxMjMgMzAgMTQ5cTAgOTMtNDEgMTc0dC0xMTcgMTM2em0tMjI2LTU0cTUzIDAgOTktMjB0ODItNTUgNTUtODEgMjAtMTAwcTAtNTMtMjAtOTl0LTU1LTgyLTgxLTU1LTEwMC0yMHEtNTMgMC05OSAyMHQtODIgNTUtNTUgODEtMjAgMTAwcTAgNTMgMjAgOTl0NTUgODIgODEgNTUgMTAwIDIwem01MTItMTQwOHYxMDI0cTAtNDgtOS04NHQtMjUtNjctNDAtNjAtNTQtNjNWMjU2SDEyOHYxMTUyaDI1NnYyNjdsMjY3LTI2N2gzOTBxOCAzNCAyMSA2NnQzMSA2Mkg3MDRsLTQ0OCA0NDh2LTQ0OEgwVjEyOGgyMDQ4eiIgLz4NCjwvc3ZnPg=="})}getLocationIcon(){return{content:"&#xECAF",type:2}}getDefaultIcon(n){let i;const r=n.trim().replace(u," ").split(" ",2);if(r.length>0){const n=r[0][0];if(t.test(n)&&(i=n),r.length==2){const n=r[1][0];i&&t.test(n)?i+=n:i=""}}return{type:i?5:2,content:i?i.toUpperCase():"&#xE77B",className:"peopleIcon"}}}n.MsbDataAccess=f}(WSB||(WSB={})),function(n){const t="wsb.ux.workserp",i="msb.ux.workserp";class r{constructor(){var n;this.msbPrefetch=_w.BingAtWork;this.msbContext=(n=_w.BingAtWork)===null||n===void 0?void 0:n.context}FetchMsbUnifiedSearch(r){var u;if(((u=this.msbPrefetch)===null||u===void 0?void 0:u.substrateUnifiedSearch)&&this.msbContext){this.msbContext.query=r;const u=n.config.msbWorkScopeScenarioNameEnabled?t:i;this.msbPrefetch.substrateUnifiedSearch("All",undefined,!0,u)}}FetchTenantSettings(){var t;if((t=this.msbPrefetch)===null||t===void 0?void 0:t.fetchTenantSettings){const t=n.msbHost.urlUtils.getMsbUrl("v2/tenant/my/settings");this.msbPrefetch.fetchTenantSettings(t);this.msbPrefetch.isTenantSettingsPrefetchStarted=!1}}FetchUserConfigs(){var t;if((t=this.msbPrefetch)===null||t===void 0?void 0:t.fetchUserConfigs){const t=n.msbHost.urlUtils.getMsbUrl("v3/user/data/configs");this.msbPrefetch.fetchUserConfigs(t)}}}n.MsbPrefetchManager=r}(WSB||(WSB={})),function(n){function t(n){return n===null?null:n===undefined?undefined:typeof n=="number"||typeof n=="string"||typeof n=="boolean"?n:Array.isArray(n)?n.map(t):Object.keys(n).reduce((i,r)=>{const u=`${r[0].toUpperCase()}${r.slice(1)}`;return i[u]=typeof n[r]=="object"?t(n[r]):n[r],i},{})}const i="MSBLS_bfbSubstrateToken";n.VerticalConfigLocalStorageKey="WsbMsbVerticalConfig";const r=6;class u{constructor(t,i){this.tokenManager=t;this.tenantManager=i;this.cachedVerticalItems=[];this.isVerticalConfigApiCallInProgress=!1;n.Host.bindAccountChanged(()=>this.clearWorkScopeTokenStorage());i.bindTenantEnabled((n,t)=>this.refreshVerticalItems(!0,t,n));i.bindTenantDisabled(()=>this.refreshVerticalItems(!1,"MsbVerticalManager:TenantDisabled"))}getSyntheticSuggestions(t,i){return(t===null||t===void 0?void 0:t.queryToFetch)&&t.scope===n.Scope.Work&&n.config.msbVerticalWorkScopeEnabled?this.createSuggestionList(t,i):[]}getWorkSuggestionAnnotation(){return n.Host.getLocString(this.tenantManager.getIsMsbEduTenantEnabled()?"SchoolResults":"WorkResults")}createSuggestionList(t,i){let r=[];if(t.scope===n.Scope.Work){const u=this.cachedVerticalItems.filter(n=>{var t;return((t=n.verticalId)===null||t===void 0?void 0:t.toLowerCase())==="all"}).map(n=>this.createSuggestion(n,t,i,!1))[0],f=this.cachedVerticalItems.filter(n=>{var t;return((t=n.verticalId)===null||t===void 0?void 0:t.toLowerCase())!=="all"}).map(n=>this.createSuggestion(n,t,i,!0));if(u){u.childSuggestions=u.childSuggestions||[];for(const t of f){const i=t;u.childSuggestions.push(i);i.parent=u;i.displayed=!0;i.groupType=n.GroupType.Related}const i=n.SequenceNumberManager.getSequenceNumber();r=[u];const t=[];t.push(u);f.map(n=>t.push(n));n.InstrumentationHelper.instrumentDataSource(i,"MSBV",t,{})}}return r}cleanupCachedVerticalItems(){this.cachedVerticalItems=[]}clearWorkScopeTokenStorage(){n.LightweightStorage.removeItem(i)}refreshVerticalItems(n,t,i){if(n&&this.tenantManager.isWorkScopeApplicable()){i=`v1-${i||this.tokenManager.getMsbAccountRoutingHint()}`;const n=this.getCachedVerticalConfig(i);n?this.setupVerticalItems(n):this.getAndSetVerticalItems(i,t)}else this.cleanupCachedVerticalItems(),this.cleanCachedVerticalConfig()}getAndSetVerticalItems(t,i){n.msbHost.isThorProxyEnabled()?this.tokenManager.refreshMsbTokenAndCall(()=>this.verticalConfigSuccessHandler(t,i),this.verticalConfigFailureHandle,undefined,"MsbVerticalManager"):this.tokenManager.refreshLokiTokenAndCall(()=>this.verticalConfigSuccessHandler(t,i),this.verticalConfigFailureHandle,"MsbVerticalManager")}verticalConfigSuccessHandler(t,i){const r=n.Host.getConversationId();this.isVerticalConfigApiCallInProgress?n.config.msbVerticalConfigMultipleCallLogsEnabled&&(bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logValue("Wsb Multiple Vertical Config Requested",i,{conversationId:r})):(this.isVerticalConfigApiCallInProgress=!0,this.fetchVerticalConfig(n=>{this.isVerticalConfigApiCallInProgress=!1,this.setupVerticalItems(n),this.cacheVerticalConfig(n,t)},(t,u)=>{this.isVerticalConfigApiCallInProgress=!1;this.cleanupCachedVerticalItems();const{message:f,stackTrace:e,serverTraceId:o,requestSentTime:s,responseReceivedTime:h,isBrowserOnline:c,hResultString:l}=u;(t!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest)&&(bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logHttpError("Wsb Fetch Vertical Config Failed",f,{statusCode:t,stackTrace:e,serverTraceId:o,cvid:r},{Online:c,HResult:l,ReqTS:s,ResTS:h,caller:i}))}))}verticalConfigFailureHandle(n){bfbWsbTel===null||bfbWsbTel===void 0?void 0:bfbWsbTel.logError("VerticalConfigAccessTokenNotFound",n)}cacheVerticalConfig(t,i){if(t&&t.length>0){const u=new Date,f={data:t,expiry:u.setHours(u.getHours()+r),routingHint:i};n.LightweightStorage.setItem(n.VerticalConfigLocalStorageKey,JSON.stringify(f))}}cleanCachedVerticalConfig(){n.LightweightStorage.removeItem(n.VerticalConfigLocalStorageKey)}getCachedVerticalConfig(t){const i=n.LightweightStorage.getItem(n.VerticalConfigLocalStorageKey);let r;if(i)try{const u=JSON.parse(i);u.routingHint===t&&u.expiry>n.getCurrentTime()?r=u.data:this.cleanCachedVerticalConfig()}catch(u){this.cleanCachedVerticalConfig()}return r}getDisplayName(t,i,r,u){let f="";switch(i===null||i===void 0?void 0:i.toLowerCase()){case"all":f=u||this.tenantManager.isWorkScopeListViewEnabled()?n.Host.getLocString("MsbVerticalChildAll"):n.Host.getLocString("MsbVerticalParentPattern");break;case"people":f=u||n.Host.getLocString("MsbVerticalChildPeople");break;case"sites":f=u||n.Host.getLocString("MsbVerticalChildSites");break;case"files":f=u||n.Host.getLocString("MsbVerticalChildFiles");break;case"groups":f=u||n.Host.getLocString("MsbVerticalChildGroups");break;case"messages":f=n.Host.getLocString("MsbVerticalChildMessages");break;case"yammer":f=n.Host.getLocString("MsbVerticalChildYammer");break;case"assignments":f=u||n.Host.getLocString("MsbVerticalChildAssignments");break;default:r===1&&(f=n.Host.getLocString("MsbVerticalChildConnectorsPattern").replace("{display-name}",u||t))}return f}setupVerticalItems(t){var i,r,u;if(this.cleanupCachedVerticalItems(),t){let f,e,o,s,h,c,l;const a=[];if(t.length)for(const n of t){const{Id:t,VerticalType:i,DisplayName:r,State:u}=n;switch(t===null||t===void 0?void 0:t.toLowerCase()){case"all":u===1&&(f={verticalId:t,displayName:this.getDisplayName("",t,i,r),verticalHash:"",navDomain:"",navDomainId:"",type:"MVALL"});break;case"people":u===1&&(e={verticalId:t,displayName:this.getDisplayName("Person",t,i,r),verticalHash:`${"Person"}-${t}`,navDomain:"Person",navDomainId:t,icon:{content:"&#xE716",type:2},type:"MVPPL"});break;case"sites":u===1&&(s={verticalId:t,displayName:this.getDisplayName("Site",t,i,r),verticalHash:`${"Site"}-${t}`,navDomain:"Site",navDomainId:t,icon:{content:"&#xE737",type:2},type:"MVSIT"});break;case"files":u===1&&(h={verticalId:t,displayName:this.getDisplayName("File",t,i,r),verticalHash:`${"File"}-${t}`,navDomain:"File",navDomainId:t,icon:{content:"&#xEF6C",type:2},type:"MVFIL"});break;default:u===1&&i===1&&a.push({verticalId:t,displayName:this.getDisplayName("Connectors",t,i,r),verticalHash:`${"Connectors"}-${t}`,navDomain:"Connectors",navDomainId:t,icon:{content:"&#xE737",type:2},type:"MVCON"})}}(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.tenantManager.getIsMsbInternalTenant())||(o={verticalId:"Group",displayName:this.getDisplayName("Group","Groups"),verticalHash:"Group",navDomain:"Group",navDomainId:"",icon:{content:"&#xE902",type:2},type:"MVGRP"});const y={verticalId:"Message",displayName:this.getDisplayName("Message","Messages"),verticalHash:`${"Message"}-conversations`,navDomain:"Message",navDomainId:"conversations",icon:{content:"&#xE901",type:2},type:"MVMES"},v=(i=n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.tenantManager)===null||i===void 0?void 0:i.isEduScopeApplicable(),p=((r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||r===void 0?void 0:r.gccRegion)===1||((u=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||u===void 0?void 0:u.gccRegion)===2;p||v||(c={verticalId:"Yammer",displayName:this.getDisplayName("Yammer","Yammer"),verticalHash:"Yammer",navDomain:"Yammer",navDomainId:"yammer",icon:{content:"&#xE901",type:2},type:"MVYAM"});v&&(l={verticalId:"Assignments",displayName:this.getDisplayName("EducationAssignment","Assignments"),verticalHash:"EducationAssignment",navDomain:"EducationAssignment",navDomainId:"",icon:{content:"&#xE9D3",type:2},type:"MVASG"});this.cachedVerticalItems=[f,e,o,s,h,y,c,l,...a].filter(n=>n!=null)}}createSuggestion(t,i,r,u){const o=this.tenantManager.getStoredMsbTenantName(),e=this.tenantManager.isWorkScopeListViewEnabled(),l=o?n.Host.getLocString("MsbWorkVerticalSuggestionGroupName",o):n.Host.getLocString("MsbVerticalSuggestionGroupName");let s=t.displayName;const a=t.verticalId.toLowerCase()==="all";let h=e?"":`${t.displayName} ${this.getWorkSuggestionAnnotation()}`;if(a){const r=t.displayName.replace("{query-text}",encodeURIComponent(i.queryToFetch));s=e?t.displayName:HitHighlightingParser.addMarkers(decodeURIComponent(r),i.queryToFetch);h=e?"":`${n.Host.getLocString("MsbVerticalAll")} ${this.getWorkSuggestionAnnotation()}`}const c=t.type,f=n.createSuggestion(i,s,undefined,t.icon||{content:"&#xE721",type:2},c,i.queryToFetch,n.InstrumentedItem.createInstrumentedItem(r,c),21,r,!0,t.verticalHash,undefined,u,t.verticalHash);return f.navDomain=t.navDomain,f.navDomainId=t.navDomainId,f.autoOpenPreviewPaneWhenOnTopHit=!1,f.msbVerticalHash=t.verticalHash,f.rankingScore=-9900,f.skipRerank=!0,f.sourceForGroup=0,f.previewPaneType=n.config.msbVerticalDebugDisableMiniSerp?undefined:1,f.primaryMetadata=h,f.id=`ws-${t.verticalId.toLowerCase()}`,f.template=0,f.groupDisplayName=l,this.tenantManager.isWorkMruEnabled()&&(f.getMruData=()=>n.getMruUrlSuggestionData(f,"")),f}mergeArgsIntoUrl(n,t){const i=_w.BingAtWork;return typeof(i===null||i===void 0?void 0:i.mergeArgsIntoUrl)=="function"&&(n=i.mergeArgsIntoUrl(n,t)),n}getLokiVerticalConfigUrl(){let t=n.msbHost.urlUtils.getLokiUrl("v1/search/configuration/verticals");if(t){const{conversationId:n,sessionId:i}=BingAtWork.context,r={RootCorrelationId:n!==null&&n!==void 0?n:"",conversationId:n!==null&&n!==void 0?n:"",ClientCorrelationId:i,ConvertGetPost:"true"};t=this.mergeArgsIntoUrl(t,r)}return t}getThorVerticalConfigUrl(){let t=n.msbHost.urlUtils.getMsbUrl("thor/api/v1/search/configuration/verticals");if(t)t=this.mergeArgsIntoUrl(t,{ConvertGetPost:"true"});return t}fetchThorVerticalConfig(i,r){const u=this.getThorVerticalConfigUrl();if(u){const{sessionId:f}=BingAtWork.context,e={Accept:"text/plain, application/json, text/json","X-ClientFeature":"Search","X-ClientType":n.msbHost.getClientType(n.Scope.Work),"X-ClientCorrelationId":f||""},o={url:u,requestType:"POST",body:JSON.stringify(e),checkServerTime:!0,onSuccess:n=>i(t(n)),onError:(n,t)=>r(n,t)};n.Msb.sendAjax(o)}else r(n.ClientErrorCode.UrlUnavailable,{message:"Url is undefined because not able to resolve Thor domain"})}fetchLokiVerticalConfig(i,r){const u=this.getLokiVerticalConfigUrl();if(u){const f={"X-ClientType":n.msbHost.getClientType(n.Scope.Work)},e={url:u,useToken:"WSBLoki",requestType:"POST",body:JSON.stringify(f),checkServerTime:!0,onSuccess:n=>i(t(n)),onError:(n,t)=>r(n,t)};n.Msb.sendAjax(e)}else r(n.ClientErrorCode.UrlUnavailable,{message:"Url is undefined because not able to resolve Loki domain"})}fetchVerticalConfig(t,i){n.msbHost.isThorProxyEnabled()?this.fetchThorVerticalConfig(t,i):this.fetchLokiVerticalConfig(t,i)}}n.MsbVerticalManager=u}(WSB||(WSB={})),function(n){const r=36e5;let i;(function(n){n[n.None=0]="None";n[n.EdgeWorth=1]="EdgeWorth";n[n.People=2]="People";n[n.Groups=3]="Groups";n[n.Bookmarks=4]="Bookmarks";n[n.Qna=5]="Qna";n[n.Buildings=6]="Buildings";n[n.EducationAssignments=7]="EducationAssignments";n[n.UserHistory=8]="UserHistory";n[n.Connector=9]="Connector";n[n.TopBookmarks=10]="TopBookmarks";n[n.ServerTrie=11]="ServerTrie";n[n.Acronym=13]="Acronym"})(i||(i={}));let t;(function(n){n[n.NoBingAtWork=-2]="NoBingAtWork";n[n.None=-1]="None";n[n.Empty=0]="Empty";n[n.Partial=1]="Partial";n[n.Complete=2]="Complete"})(t||(t={}));let u;(function(n){n.ValidResults="Valid Results";n.Empty="Empty";n.EmptyFromParseError="EmptyFromParseError";n.EmptyFromExpired="EmptyFromExpired";n.NoResults="No Results";n.Invalid="Invalid";n.Error="Error";n.Expired="Expired";n.NotApplicable="NotApplicable";n.Initialized="Initialized"})(u=n.MsbQfCacheState||(n.MsbQfCacheState={}));n.QuickWorkSearchCacheStorageKey="QwsCache";n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE=n.mapOSFormCode("WSBWS0");class f{constructor(){this.isClientQfSyncDocEventSucceed=!1;this.clientQfStatusResult="";this.PersonIconCacheStorageKeyPrefix="MsbPersonIcon";this.MsbClientQfTokenReadyStorageKey="MsbQfReady";this.earlyLoadWindow=5e3;this.startTime=n.getCurrentTime()}getMsbClientQfTrieState(){if(typeof BingAtWork=="undefined")return{inputState:t.NoBingAtWork};const n=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.CQFDebugInfo,i=n===null||n===void 0?void 0:n.trieState;return this.convertCqfTrieState(i)}convertCqfTrieState(n){if(!n)return{inputState:t.None};const r=this.convertInputSources(n);let i;return n.lastRefreshTime&&(i=this.covertTimeToInHours(n.lastRefreshTime)),{inputState:n.inputState,inputSources:r,lastRefreshInHours:i,version:n.version}}covertTimeToInHours(t){const i=n.getCurrentTime()-t;return Math.ceil(i/r)}convertInputSources(n){var t;const r=n===null||n===void 0?void 0:n.inputSources;if(!r)return undefined;const u={};if(Array.isArray(r))r.forEach(n=>{const t=this.convertInputSourceState(n);t&&(u[n.sourceType]=t)});else for(const r in i){const i=this.convertInputSourceState((t=n===null||n===void 0?void 0:n.inputSources)===null||t===void 0?void 0:t[r]);i&&(u[r]=i)}return u}convertInputSourceState(n){if(!n)return undefined;let t,i,r;return n.lastFullSyncTime&&(t=this.covertTimeToInHours(n.lastFullSyncTime)),n.lastDeltaSyncTime&&(i=this.covertTimeToInHours(n.lastDeltaSyncTime)),n.entityType&&(r=n.entityType),{sourceType:n.sourceType,isComplete:n.isComplete,entityType:r,lastFullSyncInHours:t,lastDeltaSyncInHours:i}}isClientQfReady(){if(typeof BingAtWork=="undefined")return!1;if(n.MockUrlParameters)return!0;const t=BingAtWork.msbDataContext;return(t===null||t===void 0?void 0:t.initializeFired)&&(t===null||t===void 0?void 0:t.exposedAccessTokenApiFired)&&(t===null||t===void 0?void 0:t.readyFired)}getMsbClientQfState(){if(typeof BingAtWork=="undefined")return"BingAtWorkNotReady";const n=BingAtWork.msbDataContext;if(n){if(n.dataLoadFired)return"DataLoaded";if(n.readyFired)return"Ready"}return"NotReady"}isWaitForBackfillEnabled(t){return t===n.Scope.People&&n.msbHost.tenantManager.getIsMsbInternalTenant()?!0:!n.config.msbClientQfNoWaitBackfill}isClientQfBackgroundRefreshEnabled(){return n.msbHost.tenantManager.getIsMsbInternalTenant()&&n.config.msbClientQfBackgroundRefreshMs||!n.msbHost.tenantManager.getIsMsbInternalTenant()&&n.config.msbClientQfBackgroundRefreshNonMs}setClientQfSyncDocEventFired(t,i){this.isClientQfSyncDocEventSucceed=t;const r={Success:t?"1":"0",EventSource:i};n.InstrumentationHelper===null||n.InstrumentationHelper===void 0?void 0:n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbClientQfSyncDoc",n.SequenceNumberManager.getSequenceNumber(),r)}getClientQfSyncDocEventFired(){return this.isClientQfSyncDocEventSucceed}is3sFileDisabled(){return n.config.msb3sFileOff&&n.msbHost.tenantManager.isTenantMsbEnabled()&&this.isMsbFileReady()}isMsbFileEnabled(){return n.msbHost.tenantManager.getIsMsbInternalTenant()&&n.config.msbEnableFileMS||n.config.msbEnableFile}isMsbFileReady(){const t=this.isClientQfSyncDocEventSucceed||typeof n.MockUrlParameters!="undefined";return this.isMsbFileEnabled()&&this.isClientQfReady()&&t}isMsbAcronymEnabled(){return n.msbHost.tenantManager.getIsMsbInternalTenant()&&n.config.msbClientQfEnableAcronymMS||n.config.msbClientQfEnableAcronym}isMsbAcronymReady(){return this.isMsbAcronymEnabled()&&this.isClientQfReady()}isDocumentZeroQueryEnabled(){return n.config.msbEnableDocumentZQ}setClientQFTrieRefreshStartedEventFired(t,i){this.clientQFTrieRefreshStartedTime=parseInt(t);const r={Started:"1",StartTime:t?t:"",RefreshType:i};n.InstrumentationHelper===null||n.InstrumentationHelper===void 0?void 0:n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbClientQfTrieRefreshStart",n.SequenceNumberManager.getSequenceNumber(),r)}setClientQFTrieRefreshFinishedEventFired(t,i,r){const u=this.clientQFTrieRefreshStartedTime,f=parseInt(i),e=u&&f&&!isNaN(u)&&!isNaN(f)&&f-u?(f-u).toString():"",o={ReturnStatus:t!==undefined?t:"",TrieRefreshDurationInMS:e,StartTime:u?u.toString():"",FinishTime:i?i:"",RefreshType:r};n.InstrumentationHelper===null||n.InstrumentationHelper===void 0?void 0:n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbClientQfTrieRefreshFinished",n.SequenceNumberManager.getSequenceNumber(),o)}setClientQfStatusMessage(n){this.clientQfStatusResult=n!==undefined?n:""}getClientQfStatusMessage(){return this.clientQfStatusResult}setQuickWorkSearchCache(t){t?n.LightweightStorage.setItem(n.QuickWorkSearchCacheStorageKey,t):n.LightweightStorage.removeItem(n.QuickWorkSearchCacheStorageKey)}getQuickWorkSearchCache(){return n.LightweightStorage.getItem(n.QuickWorkSearchCacheStorageKey)}clearQuickWorkSearchPersonImageCache(){n.LightweightStorage.removeItemsWithKeyPrefix(this.PersonIconCacheStorageKeyPrefix)}getPersonIconStorageKey(n){return`${this.PersonIconCacheStorageKeyPrefix}_${n}`}setIsMsbClientQfTokenReady(t){n.LightweightStorage.setItem(this.MsbClientQfTokenReadyStorageKey,t?"1":"0")}clearIsMsbClientQfTokenReady(){n.LightweightStorage.removeItemsWithKeyPrefix(this.MsbClientQfTokenReadyStorageKey)}getIsMsbClientQfTokenReady(){return(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.bfbMock)!=null||n.LightweightStorage.getItem(this.MsbClientQfTokenReadyStorageKey)==="1"}isMsbQfInScriptsEarlyLoadState(){return n.config.msbLoadQfScriptEarly&&n.msbHost.tenantManager.shouldForceEnterpriseAccount()&&n.getCurrentTime()-this.startTime<this.earlyLoadWindow}getOnRampButtonSuggestion(t,i){const r=n.getSyntheticSuggestion(t,i,"ORB",undefined,23,undefined,!1,()=>{var t,i;const r=n.Host.getQuery(),u=(i=(t=n.ScopeConfig===null||n.ScopeConfig===void 0?void 0:n.ScopeConfig[n.Scope.Documents])===null||t===void 0?void 0:t.prefixes)===null||i===void 0?void 0:i[0],f=`${u}: ${r.queryToFetch}`;n.Host.reformulateNonForcedMiniSerp(f,r.isSearchHomeZI,undefined);n.InstrumentationHelper.logClientInstEvent("Select","OnRampButtonToDocumentScope",undefined)});return r.staticGroupType=n.GroupType.MsbOnRampButton,r.query=t.queryToFetch,r.text=n.Host.getLocString("FindMoreDocuments"),r.narratorText=n.getNarratorText(r),r.classNames=["onRampButton"],r.suppressed=!0,r}setMsbMruSuggestionProperties(t,i){this.setIconForMsbMruSuggestion(t,i);t.click=()=>{var r,u,f;t.type==="MFIL"?n.launchDocument((r=i.url)!==null&&r!==void 0?r:"",(u=i.webUrl)!==null&&u!==void 0?u:"",(f=i.fileExtension)!==null&&f!==void 0?f:""):n.config.msbMruRedirectToBingWorkVerticalEnabled?n.msbHost.urlUtils.buildBfbSearchUrlAsync(t.query,"None","",n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE).then(t=>n.Host.launchUri(t)):n.Host.switchToScope(n.Scope.Work,t.query)};t.narratorText=n.getNarratorText(t)}setIconForMsbMruSuggestion(t,i){switch(t.type){case"MGRP":case"MPPL":{const r=n.msbHost.dataAccess.getDefaultIcon(t.query);t.getIcon=n.msbHost.dataAccess.createGetPersonIcon(i.id,!0,r,!0);t.icon=r;break}case"MBKS":t.icon=n.msbHost.dataAccess.getBookmarkIcon();break;case"MQNA":t.getIcon=n.msbHost.dataAccess.getMsbQnaIcon;t.icon=n.msbHost.dataAccess.getDefaultIcon(t.query);break;case"MBLD":t.icon=n.msbHost.dataAccess.getLocationIcon();break;case"MFIL":{const r=n.ScopeConfig[n.Scope.Documents].icon;t.getIcon=n.getIconForTypeAsync(r,"."+i.fileExtension);t.icon=r;break}default:t.icon={type:0,className:n.config.mirrorMruLBSHItemIcon?"LBSHSpyglassSV2":"LBSHSpyglass"}}}}n.MsbQfUtils=f}(WSB||(WSB={})),function(n){function at(t){switch(t.cacheState){case n.MsbQfCacheState.Empty:return p;case n.MsbQfCacheState.Error:return d;case n.MsbQfCacheState.Expired:return k;case n.MsbQfCacheState.Invalid:return b;case n.MsbQfCacheState.NoResults:return w;default:return it}}function vt(t,i){return{suggestionConfidenceOptions:r(),serverSuggestionOptions:yt(),domains:wt(t,i),count:t?n.config.msbQfResultsCountL1ForFile:n.config.msbQfResultsCountL1,scope:"All"}}function r(){return{domainOptions:{["Person"]:{spaceInTheMiddleRequired:!1,minimumMatchCount:n.config.msbMinMatchPerson||t},["Bookmark"]:{minimumMatchCount:n.config.msbMinMatchBookmark||t},["Acronym"]:{minimumMatchCount:n.config.msbMinMatchAcronym||t},["Building"]:{minimumMatchCount:n.config.msbMinMatchBuilding||t},["Group"]:{minimumMatchCount:n.config.msbMinMatchGroup||t},["Qna"]:{minimumMatchCount:n.config.msbMinMatchQna||t},["File"]:{minimumMatchCount:n.config.msbMinMatchFile||t}},ignoreChars:"parenDash",domainTriggerOptions:{["Person"]:{minimumMatchCount:n.config.msbTGOMinMatchPerson||i},["Bookmark"]:{minimumMatchCount:n.config.msbTGOMinMatchBookmark||i},["Acronym"]:{minimumMatchCount:n.config.msbTGOMinMatchAcronym||i},["Building"]:{minimumMatchCount:n.config.msbTGOMinMatchBuilding||i},["Group"]:{minimumMatchCount:n.config.msbTGOMinMatchGroup||i},["Qna"]:{minimumMatchCount:n.config.msbTGOMinMatchQna||i},["File"]:{minimumMatchCount:n.config.msbTGOMinMatchFile||i}}}}function yt(){const t=r().domainOptions;let n=Number.MAX_VALUE;for(const i in t)n=t[i].minimumMatchCount<n?t[i].minimumMatchCount:n;return{minimumQueryLength:n}}function pt(t){return t.isSearchHomeZI?n.msbHost.tenantManager.getIsMsbEduTenantEnabled()&&n.config.msbQwsEnabledInEdu?lt:ct:!n.isL2(t)||n.msbHost.tenantManager.isMsbWorkScope(undefined,t===null||t===void 0?void 0:t.scope)?vt(n.msbHost.qfUtils.isMsbFileReady(),n.msbHost.qfUtils.isMsbAcronymReady()):t.scope===n.Scope.People?ot:t.scope===n.Scope.Web?st:t.scope===n.Scope.Documents?ht:undefined}function wt(t,i){let r=["Person","Bookmark","Group","Qna"];return n.config.msbDisableBuilding||r.push("Building"),t&&r.push("File"),i&&r.push("Acronym"),r}function bt(){switch(n.config.msbQwsDomains){case 0:return["Person","Bookmark"];case 2:return["Bookmark"];case 1:return["Person"];default:return["Person","Bookmark"]}}function kt(){return["Bookmark"]}function dt(){let t=["Bookmark","Qna"];return n.config.msbDisableBuilding||t.push("Building"),t}function gt(){return["File"]}function ni(n){return n.length>0&&(n.toLowerCase()==="cancelled"||n.toLowerCase()==="time out")?n:"unknown"}function h(n){return n.length>1&&n[1].eventSource?n[1].eventSource:""}function ti(n){let t=n.length>1?n[1].returnStatus:"";return t!==undefined?t:""}function ii(n){let t=n.length>1?n[1].qfStatusResult:"";return t!==undefined?t:""}function c(n){return n.length>1&&n[1].timestamp?n[1].timestamp:""}function l(n){return n.length>1&&n[1].dataRefreshType?n[1].dataRefreshType:""}const a="CS",v="NE",u="MAAD",y="NQO",p="EREC",w="ERNC",b="ERIC",k="ERCX",d="ERCE",g="GSF",nt="EXSF",tt="ZQSF",it="ZQUE",rt="TKNR",t=6,i=6,f="msb:qf:atrdy",ut="msb:qf:sydoc",ft="msb:qf:sydoc:fail",e="msb:qf:dld",o="msb:qf:trs",s="msb:qf:trf",et="msb:qf:sts",ot={suggestionConfidenceOptions:r(),domains:["Person","Group"],count:n.config.msbQfResultsCountL2,scope:"People"},st={suggestionConfidenceOptions:r(),domains:dt(),count:n.config.msbQfResultsCountL2,scope:"Web"},ht={suggestionConfidenceOptions:r(),domains:gt(),count:n.config.msbQfResultsCountL2,scope:"Documents"},ct={suggestionConfidenceOptions:r(),domains:bt(),count:n.config.msbQfResultsCountQws,dynamicRanking:n.config.msbEnableQwsDynamicRanking},lt={suggestionConfidenceOptions:r(),domains:kt(),count:n.config.msbQfResultsCountQws,dynamicRanking:n.config.msbEnableQwsDynamicRanking};const ri=6048e5;class ui{constructor(t,i){this.dataSource=t;this.msbTokenManager=i;this.tokenChangedFired=!1;this.clientQfReadyForAccessToken=!1;this.clientQfTokenReady=!1;this.clientQfInitTime=0;this.accountChanging=!1;this.logId=`${this.getName()}[${this.dataSource}]`;this.msbDataModule=_w.BingAtWork;n.msbHost.qfUtils.clearIsMsbClientQfTokenReady();n.Host.bindAccountChanged(()=>{this.accountChanging=n.config.msbEnableMultiAad?!0:!1,n.msbHost.qfUtils.setQuickWorkSearchCache(undefined),n.msbHost.qfUtils.clearQuickWorkSearchPersonImageCache()});this.msbTokenManager.bindTokenChanged(()=>{this.tokenChangedFired=!0,this.updateClientQfAccessToken()});const r=()=>{this.clientQfReadyForAccessToken=!0,this.updateClientQfAccessToken(),sj_evt.unbind(f,r)};sj_evt.bind(f,r,!0,undefined,!0);const y=t=>{const i=h(t);n.msbHost.qfUtils.setClientQfSyncDocEventFired(!0,i)};sj_evt.bind(ut,y,!0,undefined,!0);const p=t=>{const i=h(t);n.msbHost.qfUtils.setClientQfSyncDocEventFired(!1,i)};sj_evt.bind(ft,p,!0,undefined,!0);const u=t=>{const r=c(t),i=l(t);n.msbHost.qfUtils.setClientQFTrieRefreshStartedEventFired(r,i);sj_evt.unbind(o,u)};sj_evt.bind(o,u,!0,undefined,!0);const a=t=>{const i=ti(t),u=c(t),r=l(t);n.msbHost.qfUtils.setClientQFTrieRefreshFinishedEventFired(i,u,r);sj_evt.unbind(s,a)};sj_evt.bind(s,a,!0,undefined,!0);const w=t=>{const i=ii(t);n.msbHost.qfUtils.setClientQfStatusMessage(i)};sj_evt.bind(et,w,!0,undefined,!0);const v=()=>{this.setLogClintQFDelay(),sj_evt.unbind(e,v)};sj_evt.bind(e,v,!0,undefined,!0);n.config.msbQwsCleanCache&&n.LightweightStorage.removeItemsWithKeyPrefix(n.QuickWorkSearchCacheStorageKey)}getName(){return"MsbClientQfDataProvider"}fetch(t,i,r,f,e){var c;let p=this.checkAllowedAadUser();if(n.config.msbEnableDeltaSync&&n.msbHost.qfUtils.isMsbFileEnabled()&&n.msbHost.qfUtils.isClientQfReady()&&t.isSearchHomeZI&&this.clientQfTokenReady&&!this.accountChanging&&this.initDeltaSyncCall(),!n.isDataSourceEnabled(this.dataSource,t)){let u=n.msbHost.tenantManager.shouldForceEnterpriseAccount(),f=u&&!n.msbHost.qfUtils.getIsMsbClientQfTokenReady();if(n.msbHost.isAuthLogEnabled()&&t.isSearchHomeZI&&n.msbHost.enableQws()){const n=u?f?"Token not ready":"No cached result":"Not force enterprise account";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search data source disabled",n)}let r;r=f?rt:undefined;r&&i(this.dataSource,[],r);return}if(n.config.msbEnableMultiAad&&this.accountChanging){this.accountChanging=!1;i(this.dataSource,[],u);return}if(!n.config.msbEnableMultiAad&&!p){_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search disabled from multiAad","Not allowedAadUser");i(this.dataSource,[],u);return}let o={isCachedResultsReturned:!1},h;const s=(r,u,f,e,o,s)=>{t.isSearchHomeZI&&(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryReturned,h)),i(r,u,f,e,o,s)};if(t.isSearchHomeZI&&n.msbHost.enableQwsCache()&&!(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbSHNoClientQf)){n.msbPerfLogger&&(typeof this.lastShZiPerfMarkCallId=="undefined"&&(this.lastShZiPerfMarkCallId=0),h=this.lastShZiPerfMarkCallId++,n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryStarted,h));const t=n.msbHost.qfUtils.getQuickWorkSearchCache();if(t){let i;try{i=JSON.parse(t)}catch(r){const i=`[MSB.Error]  ${this.logId}.fetch: QWS cache is broken.
                            cacheString=${t},
                            error.message=${r===null||r===void 0?void 0:r.message}`;const u=n.msbHost.tenantManager.getIsMsbInternalTenant()?i:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search cache broken","",{additionalMessage:u});o.cacheState=n.MsbQfCacheState.Error;n.msbHost.qfUtils.setQuickWorkSearchCache(undefined)}if(i)if(n.getCurrentTime()-i.lastUpdatedTime<ri){const t=((c=i.results)===null||c===void 0?void 0:c.length)>0;t?(s(this.dataSource,i.results,undefined),o.isCachedResultsReturned=!0,o.cacheState=n.MsbQfCacheState.ValidResults):(o.cacheState=n.MsbQfCacheState.NoResults,n.msbHost.isAuthLogEnabled()&&_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work return empty suggestions from cache"))}else o.cacheState=n.MsbQfCacheState.Expired,n.msbHost.qfUtils.setQuickWorkSearchCache(undefined);else o.cacheState!=n.MsbQfCacheState.Error&&(o.cacheState=n.MsbQfCacheState.Invalid)}else o.cacheState=n.MsbQfCacheState.Empty}if(!n.msbHost.tenantManager.isTenantMsbEnabled()){o.isCachedResultsReturned||(t.isSearchHomeZI&&n.msbHost.isAuthLogEnabled()&&_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search tenant not enabled",o.cacheState),s(this.dataSource,undefined,v));return}if(!(n.msbHost.qfUtils.isClientQfReady()&&(this.clientQfTokenReady||n.msbHost.qfUtils.isMsbQfInScriptsEarlyLoadState())||n.MockUrlParameters)){if(!o.isCachedResultsReturned&&(s(this.dataSource,undefined,a),n.msbHost.isAuthLogEnabled())){const n=t.isSearchHomeZI?"SearchHome":"NotSearchHome";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb no suggestions in cold start",o.cacheState,{additionalMessage:n})}return}const l=pt(t);if(!l){o.isCachedResultsReturned||s(this.dataSource,undefined,y);return}this.clientQfTokenReady&&this.msbTokenManager.refreshMsbTokenAndCall(()=>{},undefined,(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbClientQfDataProvider::fetch"]:undefined,"MsbClientQfDataProvider:fetch");this.fetchSuggestionsWithServerBackfill(t,s,e,l,o,h)}fetchSuggestionsWithServerBackfill(t,i,r,u,f,e){const o={isFirstStageProcessed:!1,enoughSuggestionsReceived:!1};t.isSearchHomeZI?n.MockUrlParameters&&typeof n.MockQwsResponse=="object"?this.processClientQwsResponse(n.MockQwsResponse,i,r,f):(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryRequested,e),this.msbDataModule.getZeroQfSuggestions(t=>{if(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.SearchHomeQueryResponded,e),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbSHNoClientQf)&&(t=[]),n.msbHost.enableQwsCache()){if(f.isCachedResultsReturned||this.processClientQwsResponse(t,i,r,f),t.length>0){const i={results:t,lastUpdatedTime:n.getCurrentTime()};n.msbHost.qfUtils.setQuickWorkSearchCache(JSON.stringify(i))}}else this.processClientQwsResponse(t,i,r,f)},t=>{const u=JSON.stringify(t);const e=n.msbHost.tenantManager.getIsMsbInternalTenant()?u:ni(u);_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search fetch threw error",f.cacheState,{additionalMessage:e});f.isCachedResultsReturned||this.processClientQwsResponse([],i,r,f,!0)},u)):(this.msbDataModule.getExtraSuggestions(t.queryToFetch,n=>{this.processClientQfResponseTwoStage(t,n,i,o,r,u)},n=>{this.processClientQfResponseTwoStage(t,[],i,o,r,u,nt)}),this.msbDataModule.getSuggestions(t.queryToFetch,n=>{this.processClientQfResponseTwoStage(t,n,i,o,r,u)},n=>{this.processClientQfResponseTwoStage(t,[],i,o,r,u,g)},u))}processClientQfResponseTwoStage(t,i,r,u,f,e,o){const s=n.msbHost.qfUtils.isWaitForBackfillEnabled(t===null||t===void 0?void 0:t.scope);if(f()&&!u.enoughSuggestionsReceived&&(!u.isFirstStageProcessed||s)){i||(i=[]);u.enoughSuggestionsReceived=!!(e.count&&i.length>=e.count);const h=!(u.enoughSuggestionsReceived||u.isFirstStageProcessed||!s);r(this.dataSource,i,o,0,!1,h);u.isFirstStageProcessed=!0}}processClientQwsResponse(t,i,r,u,f){if(r()){t||(t=[]);let e;t.length===0&&(e=f?tt:at(u),n.msbHost.isAuthLogEnabled()&&_w.bfbWsbTel&&!f&&bfbWsbTel.logError("Wsb quick work search return empty suggestions",u.cacheState));i(this.dataSource,t,e,0,!1,!1)}}setLogClintQFDelay(){const t=n.getCurrentTime()-this.clientQfInitTime;n.config.msbEnableClientQFDelayLog&&bfbWsbTel.logValue("ClientQFDelay",t)}updateClientQfAccessToken(){if(this.clientQfInitTime==0&&(this.clientQfInitTime=n.getCurrentTime()),this.tokenChangedFired&&this.clientQfReadyForAccessToken&&n.msbHost.tenantManager.isTenantMsbEnabled()){const t=this.msbTokenManager.getMsbToken();t&&this.msbDataModule.setAccessToken(t,()=>{this.clientQfTokenReady=!0,n.msbHost.qfUtils.setIsMsbClientQfTokenReady(!0)},n=>{})}}initDeltaSyncCall(){this.msbTokenManager.refreshMsbTokenAndCall(()=>{this.msbDataModule.initDeltaSyncCall(!1,()=>{},n=>{})},()=>{},(n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["MsbClientQfDataProvider::initDeltaSyncCall"]:undefined,"InitDeltaSyncCall")}checkAllowedAadUser(){return!this.allowedAadId&&n.msbHost.tenantManager.isTenantMsbEnabled()?(this.allowedAadId=this.msbTokenManager.getSelectedAccountId(),!0):this.allowedAadId==this.msbTokenManager.getSelectedAccountId()}}n.MsbClientQfDataProvider=ui}(WSB||(WSB={})),function(n){const t=n.mapOSFormCode("BFBWSL"),i=1,u=.6,f=2,e=4,o=4,r={["Person"]:"MPPL",["Group"]:"MGRP",["Bookmark"]:"MBKS",["Building"]:"MBLD",["Qna"]:"MQNA",["File"]:"MFIL",["Acronym"]:"MACR"},s=25;class h{constructor(n){this.msbDataAccess=n}parse(t,i,r,u,f,e){if(n.isDataSourceEnabled(r,t)){if(!u||u.length<1){e(r,[],{});return}const s=this.pickUpClientQfResults(t,u),o=this.createClientQfSuggestionsFor(t,i,s);if(t.isSearchHomeZI&&t.scope===n.Scope.All&&(o===null||o===void 0?void 0:o.length)>0){const n=this.getSHComponents(o);_w.bfbWsbTel&&bfbWsbTel.logSearchHomeImpression(n)}e(r,o,{})}}getSHComponents(n){let t=[];return n.findIndex(n=>n.msbDomain==="Person")>-1&&t.push("People"),n.findIndex(n=>n.msbDomain==="Bookmark")>-1&&t.push("Bookmarks"),t.join("_")}setRankingValues(n,t,i){n.suggestionLogMeta=`40000:"${t}";40001:"${i}"`}createMsbSuggestion(t,i,u,f,e,o,s,h,c,l,a,v,y,p,w){const k=r[s],d=t.isSearchHomeZI?i:HitHighlightingParser.addMarkers(i,t.originalQuery);let b=n.createSuggestion(t,d,f,e,k,i,n.InstrumentedItem.createInstrumentedItem(o,k),17,o,!0);return u&&(b.autoOpenPreviewPaneWhenOnTopHit=!0,b.allowedInGroups=!0),c&&(b.primaryMetadata=c),b.previewCallback=a,b.click=this.isQwsRequerysEnabled(t)?()=>{this.reformulateOnQwsSuggestionClick(t,i,s)}:v,b.msbDomain=s,b.msbId=h,b.reactKey=k+s+h,b.classNames.push(...l),b.additionalInfoText=y,b.groupDisplayName=p,b.sourceForGroup=w,t.isSearchHomeZI&&n.msbHost.qwsShowTopList()&&k=="MPPL"&&this.adjustPersonName(b),n.msbHost.tenantManager.isWorkMruEnabled()&&(b.getMruData=()=>this.getMsbMruSuggestionData(b)),b}getMsbMruSuggestionData(t){return Object.assign(Object.assign({},n.getMruWebSuggestionData(t)),{id:t.msbId,fileExtension:t.fileExtension,title:t.primaryMetadata,url:t.url,webUrl:t.webUrl})}setWorkQFGroupHeaderLabel(t,i){return(!t||t&&t.length>s)&&(t=n.msbHost.tenantManager.getIsMsbEduTenantEnabled()?n.Host.getLocString("School"):n.Host.getLocString("Work")),t+" - "+i}pickUpClientQfResults(t,r){let s=!1,h=0;const y=n.isL2(t),p=!!n.msbHost.tenantManager.isMsbWorkScope(undefined,t===null||t===void 0?void 0:t.scope),l=[],c=[],a=[];let v={};for(const f of r)if((!t.isSearchHomeZI||f.domain!=="Person"||!(h>=e||n.msbHost.tenantManager.getIsMsbEduTenantEnabled()))&&(t.scope!=n.Scope.All||f.domain!=="Person"||!(h>=o))&&(f.domain!=="Group"||f.identifiers!=null&&f.identifiers.uniqueName!=null)&&(f.domain!=="File"||f.identifiers.url!=null||f.identifiers.webUrl!=null)){if(f.confidence==="High"){s=!0;const n=!v[f.domain],t={msbSuggestion:f,isHero:(!y||p)&&n,score:i};v[f.domain]=!0;n?l.push(t):a.push(t)}else{s||f.confidence==null||(s=!0);const n={msbSuggestion:f,isHero:!1,score:u};c.push(n)}f.domain==="Person"&&h++}if(!s)for(let n=0;n<f;n++){const t=c[n];t&&(t.isHero=!0,t.score=i)}return[...l,...a,...c]}createClientQfSuggestionsFor(n,t,i){const r=[];for(let u=0;u<i.length;u++){const f=i[u],e=this.buildClientQfSuggestion(n,t,f);this.setRankingValues(e,u,f.score);r.push(e)}return r}buildClientQfSuggestion(i,r,u){const{msbSuggestion:f,isHero:g}=u,y=f.query,l=f.query,k=i.isSearchHomeZI,o=i.scope===n.Scope.Work,c=!o||n.config.msbWorkScopeTenantGroupTitle;let a,s,b=["fbig"],h=()=>{},p=f.title,d=undefined,e=undefined,w;switch(f.domain){case"Bookmark":{s=n.msbHost.dataAccess.getBookmarkIcon();const t=f.identifiers;h=()=>{var i;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(f.domain);_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulation_Click",(i=window===null||window===void 0?void 0:window._G)===null||i===void 0?void 0:i.IG);n.Host.launchUri(t.url)};i.isSearchHomeZI||(e=this.setDefaultGroupDisplayName(c,e));break}case"Person":{const r=n.msbHost.dataAccess.getDefaultIcon(y);a=n.msbHost.dataAccess.createGetPersonIcon(f.id,!0,r,k);s=r;b.push("msb-people");h=()=>{var i;const r=f.identifiers;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(f.domain);_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulation_Click",(i=window===null||window===void 0?void 0:window._G)===null||i===void 0?void 0:i.IG);n.msbHost.urlUtils.buildBfbSearchUrlAsync(l,"Person",r.uniqueName,o?n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE:t).then(t=>n.Host.launchUri(t))};n.isL2(i)&&(w=6);c&&!i.isSearchHomeZI&&(e=this.setWorkQFGroupHeaderLabel(n.SubstrateTenantName,n.getScopeDisplayName(n.ScopeConfig[n.Scope.People])));break}case"Group":{const r=n.msbHost.dataAccess.getDefaultIcon(y);a=n.msbHost.dataAccess.createGetPersonIcon(f.id,!1,r,k);s=r;b.push("msb-people");h=()=>{var i;const r=f.identifiers;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(f.domain);_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulation_Click",(i=window===null||window===void 0?void 0:window._G)===null||i===void 0?void 0:i.IG);n.msbHost.urlUtils.buildBfbSearchUrlAsync(l,"Group",r.uniqueName,o?n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE:t).then(t=>n.Host.launchUri(t))};c&&(e=this.setWorkQFGroupHeaderLabel(n.SubstrateTenantName,n.getScopeDisplayName(n.ScopeConfig[n.Scope.People])));n.isL2(i)&&(w=5,o&&!n.config.msbWorkScopeTenantGroupTitle&&(e=n.Host.getLocString("MsbVerticalChildGroups")));break}case"Building":s=n.msbHost.dataAccess.getLocationIcon();h=()=>{var i;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(f.domain);_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulation_Click",(i=window===null||window===void 0?void 0:window._G)===null||i===void 0?void 0:i.IG);n.msbHost.urlUtils.buildBfbSearchUrlAsync(l,"Building",undefined,o?n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE:t).then(t=>n.Host.launchUri(t))};i.isSearchHomeZI||(e=this.setDefaultGroupDisplayName(c,e));break;case"Qna":{const r=n.msbHost.dataAccess.getDefaultIcon(y);a=n.msbHost.dataAccess.getMsbQnaIcon;s=r;h=()=>{var i;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(f.domain);_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulation_Click",(i=window===null||window===void 0?void 0:window._G)===null||i===void 0?void 0:i.IG);n.msbHost.urlUtils.buildBfbSearchUrlAsync(l,"Qna",undefined,o?n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE:t).then(t=>n.Host.launchUri(t))};i.isSearchHomeZI||(e=this.setDefaultGroupDisplayName(c,e));break}case"File":{const t=n.ScopeConfig[n.Scope.Documents].icon,i=f.identifiers,r=f,l=n.getScopeDisplayName(n.ScopeConfig[n.Scope.Documents]),u=n.SubstrateTenantName||"";a=n.getIconForTypeAsync(t,"."+r.fileExtension);s=t;h=()=>{var t,u,e;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(f.domain);_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulation_Click",(t=window===null||window===void 0?void 0:window._G)===null||t===void 0?void 0:t.IG);n.launchDocument(i.url,(u=i.webUrl)!==null&&u!==void 0?u:"",(e=r.fileExtension)!==null&&e!==void 0?e:"")};w=7;e=c?this.setWorkQFGroupHeaderLabel(u,n.getScopeDisplayName(n.ScopeConfig[n.Scope.Documents])):o?n.Host.getLocString("MsbVerticalChildFiles"):l+" - "+u;break}case"Acronym":{const r=n.msbHost.dataAccess.getAcronymIcon();s=r;h=()=>{var i;_w.bfbWsbTel&&bfbWsbTel.logQFSuggestionClick(f.domain);_w.bfbWsbTel&&bfbWsbTel.log3SClickedEvent("QueryFormulation_Click",(i=window===null||window===void 0?void 0:window._G)===null||i===void 0?void 0:i.IG);n.msbHost.urlUtils.buildBfbSearchUrlAsync(l,"Acronym",undefined,o?n.MSB_WORK_SCOPE_SUGGESTION_FORM_CODE:t).then(t=>n.Host.launchUri(t))};i.isSearchHomeZI||(e=this.setDefaultGroupDisplayName(c,e));p&&(p=n.Host.getLocString("AcronymTopHitSecondaryText",p));d=" - "+n.Host.getLocString("AcronymNonTopHitAdditionalInfoText");break}}let nt=(t,r,u)=>{const e=this.getQueryText(f);if(f.domain==="File"){if(!(u===null||u===void 0?void 0:u(f.id,f.domain)))return;const n=f;n.locationPath=v.parentFolder;this.msbDataAccess.fireClientQfResponse(e,n,i===null||i===void 0?void 0:i.scope);t===null||t===void 0?void 0:t();return}this.msbDataAccess.fetchSearchResponse(e,f.domain,n=>{(u===null||u===void 0?void 0:u(f.id,f.domain))&&(this.msbDataAccess.fireSearchResponse(e,f.query,n),t===null||t===void 0?void 0:t())},()=>{const t=n.msbHost.tenantManager.getIsMsbInternalTenant()?`fetchSearchResponse: previewpane suggestion of ${e}, domain: ${f.domain} is not returned currently`:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane 3s Fetch Failed",t);r===null||r===void 0?void 0:r(f.query)},i===null||i===void 0?void 0:i.scope)},v=this.createMsbSuggestion(i,y,g,a,s,r,f.domain,f.id,p,b,nt,h,d,e,w);return f.domain==="File"&&this.updateFileSuggestion(i,f,v),n.isL2(i)&&i.scope===n.Scope.People&&(v.template=1,v.classNames.push("people","topResultTemplateInGroups")),v}getProvenance(n){if(!n.source)return null;switch(n.source.toLocaleLowerCase()){case"onedriveforbusiness":return"OneDriveBusiness";case"sharepoint":default:return"SharePoint"}}updateFileSuggestion(t,i,r){var e,o,s;if(r.classNames.push("fbig"),r.author=i.author,i.timestamp&&(r.lastAccessDate=n.toDate(i.timestamp)),r.lastModifiedBy=i.lastModifiedBy,i.lastModifiedTime&&(r.lastModifiedDate=n.toDate(i.lastModifiedTime)),r.url=(e=i.identifiers&&i.identifiers.url)!==null&&e!==void 0?e:"",r.webUrl=((o=i.identifiers)===null||o===void 0?void 0:o.webUrl)||"",r.siteTitle=(s=i.title)!==null&&s!==void 0?s:"",i.fileExtension){r.fileExtension=i.fileExtension;const n=`.${i.fileExtension}`;r.extensionLC=n.toLocaleLowerCase();r.query.endsWith(n)||(r.query=r.query+n);r.text!==r.query&&(r.text=r.query)}const c=this.getProvenance(i);n.setDocumentLocationProperties(r,i.query,c,!1);const u=r.author,f=r.lastModifiedBy,h=n.getEffectiveQuery(t);n.matchesOnPropertyHH(u,h)?r.match=n.createMatch(n.MatchType.Author,u!==null&&u!==void 0?u:""):n.matchesOnPropertyHH(f,h)&&(r.match=n.createMatch(n.MatchType.LastModifiedBy,f!==null&&f!==void 0?f:""));n.setFileTemplate(t,h,n.isL2(t),r)}reformulateOnQwsSuggestionClick(t,i,u){var f,e;const c=n.msbHost.tenantManager.isMsbWorkScopeSHRedirectEnabled(),o=c?((e=(f=n.ScopeConfig===null||n.ScopeConfig===void 0?void 0:n.ScopeConfig[n.Scope.Work])===null||f===void 0?void 0:f.prefixes)===null||e===void 0?void 0:e[0])||"Work":"";let l=o?`${o}: ${i}`:i,s=r[u];const h=u==="Person"?"People":"Bookmarks";_w.bfbWsbTel&&bfbWsbTel.logSearchHomeClick(h,{redirectTo:n.msbHost.tenantManager.redirectScope(h)});n.msbHost.substrateLogger.logSearchEntityActions("Wsb.SearchHome");n.Host.reformulateNonForcedMiniSerp(l,t.isSearchHomeZI,s);n.Host.setFocusInSearchBox(null,`${s}.click`)}isQwsRequerysEnabled(t){return t.isSearchHomeZI&&n.msbHost.enableQws()&&n.config.msbEnableQwsRequery}getQueryText(n){let t=n.query;switch(n.domain){case"Person":case"Group":t=n.identifiers&&n.identifiers.uniqueName||t;break;case"File":const i=n;t=t+"."+i.fileExtension}return t}adjustPersonName(t){const i=n.getFirstAndLastName(t.text);if(i){const{firstName:n,lastName:r}=i;t.text=n;t.additionalInfoText=r}}setDefaultGroupDisplayName(t){const i=n.SubstrateTenantName||"";return t?this.setWorkQFGroupHeaderLabel(i,n.Host.getLocString("ResultsList")):n.Host.getLocString("TenantBookmarksGroup",i)}}n.MsbQfSuggestionsParser=h}(WSB||(WSB={})),function(n){const t="QWQS",i="QMAD";class r{getName(){return"MsbQuickWorkQueriesDataProvider"}constructor(){this.accountChanging=!1;this.hasEduAssignments=!1;n.Host.bindAccountChanged(()=>{this.accountChanging=n.config.msbEnableMultiAad?!0:!1,this.hasEduAssignments=!1})}fetch(r,u){var f,e;if(r===null||r===void 0?void 0:r.enabledDataSources[t]){if(this.accountChanging){this.accountChanging=!1;u(t,undefined,i,undefined,undefined,!0);this.fetch(r,u);return}let o;this.hasEduAssignments=n.config.msbQwqsForceNonLMS?!1:(e=(f=n.msbHost.userConfigManager)===null||f===void 0?void 0:f.getHasEduAssignmentsFlags())!==null&&e!==void 0?e:!1;let s=this.getQuickWorkQueryKeys();o=this.createQuickWorkSearchResponse(s);u(t,o)}}getQuickWorkQueryKeys(){return this.hasEduAssignments?n.config.msbQwqsLmsQuickWorkQueryKeys:(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.tenantManager.isEduMessagesCardEnabled())?n.config.msbQwqsDefaultQuickWorkQueryMessagesCardEnabledKeys:n.config.msbQwqsDefaultQuickWorkQueryKeys}createQuickWorkSearchResponse(n){let i=[],t=Object.keys(n);t&&t.length>0&&t.forEach(t=>{let r=this.getQuickWorkSearchSuggestion(t,n[t]);r&&i.push(r)});return{suggestions:i,isLms:this.hasEduAssignments}}getQuickWorkSearchSuggestion(t,i){if(!t)return undefined;let r=n.config.msbQwqsUseEnglishQuery&&t!=="MsbQwqsAssignmentsKey"?n.Host.getEnUsLocString(t):n.Host.getLocString(t),u=n.Host.getLocString(i);if(!t)return undefined;return{displayText:u,displayTextKey:i,query:r,queryKey:t}}}n.MsbQuickWorkQueriesDataProvider=r}(WSB||(WSB={})),function(n){const t="qwqs-lms",i="qwqs-wrkq",r=n.mapOSFormCode("BFBQWQ");class u{constructor(n,t){this.accessTokenManager=n;this.substrateProfilePictureProvider=t}parse(r,u,f,e,o,s){if(!e||!e.suggestions||e.suggestions.length<1){s(f,[],{});return}let h=[],c={};e.suggestions.forEach((f,o)=>{let l=this.getSuggestionType(f===null||f===void 0?void 0:f.queryKey),s=n.createSuggestion(r,f===null||f===void 0?void 0:f.displayText,this.retrieveGetIcon(f===null||f===void 0?void 0:f.queryKey),this.getIcon(f===null||f===void 0?void 0:f.queryKey),l,f===null||f===void 0?void 0:f.query,n.InstrumentedItem.createInstrumentedItem(u,l),17,u,!1);s.tooltip=f===null||f===void 0?void 0:f.displayText;e.isLms&&s.classNames.push(t);s.classNames.push(i);s.reactKey="qwqs"+(f===null||f===void 0?void 0:f.query)+o;s.click=()=>this.onSuggestionClick(f,l);h.push(s);c[this.getEduSearchHomeComponent(f)]=!0});const l=Object.keys(c);r.isSearchHomeZI&&l.length>0&&_w.bfbWsbTel&&bfbWsbTel.logSearchHomeImpression(l.sort().join("_"));s(f,h,{})}onSuggestionClick(t,i){var u,f;if(_w.bfbWsbTel&&bfbWsbTel.logSearchHomeClick(n.Host.getEnUsLocString(t===null||t===void 0?void 0:t.displayTextKey)),n.msbHost.substrateLogger.logSearchEntityActions("Wsb.SearchHome"),n.config.msbQwqsEnableWsbClickTarget){const e=n.Host.getQuery(),r=((f=(u=n.ScopeConfig===null||n.ScopeConfig===void 0?void 0:n.ScopeConfig[n.Scope.Web])===null||u===void 0?void 0:u.prefixes)===null||f===void 0?void 0:f[0])||"",o=r?`${r}: ${t===null||t===void 0?void 0:t.query}`:t===null||t===void 0?void 0:t.query;n.Host.reformulateNonForcedMiniSerp(o,e.isSearchHomeZI,i)}else n.msbHost.urlUtils.buildBfbSearchUrlAsync(t===null||t===void 0?void 0:t.query,"AllResults",undefined,r).then(t=>n.Host.launchUri(t))}getIcon(t){if(!t)return undefined;switch(t){case"MsbQwqsAssignmentsKey":return{type:0,content:n.ASSIGNMENTS_SVG_URL};case"MsbQwqsClassesKey":return{type:0,content:n.CLASSES_SVG_URL};case"MsbQwqsFilesKey":return{type:0,content:n.FILES_SVG_URL};case"MsbQwqsMessagesKey":return{type:0,content:n.MESSAGES_SVG_URL};case"MsbQwqsCalendarKey":return{type:0,content:n.CALENDAR_SVG_URL};case"MsbQwqsMyProfileKey":let t=this.getSelectedAccount();return t&&t.accountUserName?this.substrateProfilePictureProvider.getPersonDefaultIcon(t.accountUserName):undefined;default:return n.getSearchSuggestionIcon()}}retrieveGetIcon(n){if(!n)return undefined;switch(n){case"MsbQwqsMyProfileKey":let n=this.getSelectedAccount();if(n&&n.accountUserName){let t=this.substrateProfilePictureProvider.getPersonDefaultIcon(n.accountUserName),i=n.accountProviderAuthority=="consumers"?0:1;return this.substrateProfilePictureProvider.getProfilePictureIcon(i,n.accountUserName,t)}return undefined;default:return undefined}}getSelectedAccount(){return this.accessTokenManager.getSelectedAccountInfo((n.Host===null||n.Host===void 0?void 0:n.Host.isAuthInvestigation())?["HeaderFooterViewModel::getUserProfileButtonData"]:undefined)}getSuggestionType(n){switch(n){case"MsbQwqsAssignmentsKey":return"QWQA";case"MsbQwqsClassesKey":return"QWQC";default:return"QWQS"}}getEduSearchHomeComponent(n){switch(n.queryKey){case"MsbQwqsAssignmentsKey":return"Assignments";case"MsbQwqsClassesKey":return"Classes";case"MsbQwqsFilesKey":return"Files";case"MsbQwqsMessagesKey":return"Messages";case"MsbQwqsCalendarKey":return"Calendar";case"MsbQwqsMyProfileKey":return"MyProfile";default:return"Unknown"}}}n.MsbQuickWorkQueriesSuggestionsParser=u}(WSB||(WSB={})),function(n){class t{constructor(t){this.page=t;this.hasFocusValue=!1;this.readyToBlurValue=!0;this.uxCheckingTimer=null;this.uxCheckingInRetry=!1;this.keyNav=new n.XyFocusKeyNavManager(this);n.Host.bindSearchBoxGotFocus(()=>{this.blur()});n.Host.bindDismissed(()=>{window.postMessage({messageType:"MSB_FLUSH_LOGGER"},window.location.origin),_w.bfbWsbTel&&bfbWsbTel.flushLogger()});window.addEventListener("message",n=>{var t;const i=(t=n===null||n===void 0?void 0:n.data)===null||t===void 0?void 0:t.messageType;if((i==="MSB_SET_SEARCH_RESPONSE"||i==="MSB_SET_3S_QUERY_RESPONSE")&&!this.uxCheckingInRetry){const t=Object.assign({},n.data);this.checkUxRendering(t)}})}init(n){this.previewPaneViewModelParent=n}finalizeKeystroke(){}update(n,t,i,r,u,f){const e=this.previewedSuggestion,o=n;this.onPreviewPaneRendered=u;this.onPreviewPaneErrored=f;e!=null&&o!=null&&e.msbDomain===o.msbDomain&&e.msbId===o.msbId||(this.previewedSuggestion=n,this.partialQuery=t,this.keyNav.ensureInit(),this.render())}hasFocus(){return this.hasFocusValue}focus(){n.Host.setFocusInWebView("msbPP focus");this.hasFocusValue=!0;this.readyToBlurValue=!1;this.keyNav.moveFocus("down",40);this.keyNav.moveFocus("down",40)}readyToBlur(){return this.readyToBlurValue}blur(){n.Host.setFocusInSearchBox(null,"msbPP blur");this.hasFocusValue=!1}clear(){this.previewedSuggestion=null;this.partialQuery=null;this.clearUx()}getSelectableItems(){return[]}getSelectableItemsByGroup(){return[]}getSelectedItem(){return null}select(){}onAfterKeyDown(){return!1}onAfterMoveFocus(n){this.readyToBlurValue=n;n&&this.blur()}getDataModel(){return{suggestion:this.previewedSuggestion}}render(){const t=this.onPreviewPaneRendered;this.clearUx();const n=this.previewedSuggestion,i=this.getSuggestionMsbId(n),r=this.getSuggestionMsbDomain(n);if(n){const u=_ge("b_bfb");u&&u.addEventListener("click",n=>this.handleClickEvent(n));this.previewedSuggestion.previewCallback&&this.previewedSuggestion.previewCallback(()=>t(!0,!1,null),t=>this.showErrorPage(t,i,r,n.type,"CallbackError"),(n,t)=>this.isCurrentPreviewSuggestion(n,t))}}isCurrentPreviewSuggestion(n,t){const i=this.getSuggestionMsbId(this.previewedSuggestion),r=this.getSuggestionMsbDomain(this.previewedSuggestion);return n===i&&t===r}getSuggestionMsbId(n){if(n){const t=n;return t&&t.msbId}return null}getSuggestionMsbDomain(n){if(n){const t=n;return t&&t.msbDomain}return null}isMsbRendered(){const n=_d.querySelector("#b_bfb .ms-search-ribbon div[class|='contentRow']");return n!=null&&n.hasChildNodes()}clearUx(){this.clearUxCheckingTimer(!0);this.page.updateMsbPreviewContainerView(this.getDataModel())}clearUxCheckingTimer(n){this.uxCheckingTimer!=null&&(sb_ct(this.uxCheckingTimer),this.uxCheckingTimer=null);n&&(this.uxCheckingInRetry=!1)}checkUxRendering(t){const e=()=>this.isMsbRendered(),i=this.previewedSuggestion,r=n.msbHost.tenantManager.getIsMsbInternalTenant()?`${i===null||i===void 0?void 0:i.query}`:"",u=this.getSuggestionMsbId(i),f=this.getSuggestionMsbDomain(i),o=()=>{const n=`MsbPreviewPaneViewModel.checkUxRendering: UX wasn't rendered correctly for preview pane.`;_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane UX not Rendered","",{additionalMessage:r});window.postMessage(t,window.location.origin)},s=()=>{const n=`MsbPreviewPaneViewModel.checkUxRendering: UX wasn't rendered correctly for preview pane after retry.`;_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane UX not Rendered after Retry","",{additionalMessage:r});const t=(i===null||i===void 0?void 0:i.query)||"";this.showErrorPage(t,u,f,i===null||i===void 0?void 0:i.type,"UxError")},h=()=>this.isCurrentPreviewSuggestion(u,f);this.pollUxRenderingChecking(e,1,o,s,h)}pollUxRenderingChecking(t,i,r,u,f){this.clearUxCheckingTimer(!1);this.uxCheckingTimer=n.safeSetTimeout(()=>{f()?t()?this.uxCheckingInRetry=!1:i>0?(this.uxCheckingInRetry=!0,r(),this.pollUxRenderingChecking(t,i-1,r,u,f)):(this.uxCheckingInRetry=!1,u()):this.uxCheckingInRetry=!1},500,"MsbPreviewPaneViewModel.pollUxRenderingChecking",`retries=${i}`)}showErrorPage(t,i,r,u,f){var e;this.instrumentMsbPreviewPaneError(f,u);((e=this.partialQuery)===null||e===void 0?void 0:e.scope)===n.Scope.Work?this.isCurrentPreviewSuggestion(i,r)&&this.buildErrorPageDataModel(t):this.buildErrorPageDataModel(t)}instrumentMsbPreviewPaneError(t,i){_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Preview Pane Error Page",t);const r={Reason:t,SuggestionType:i};n.InstrumentationHelper.logClientInstEvent("ClientInst","MsbPreviewPaneRenderError",n.SequenceNumberManager.getSequenceNumber(),r)}buildErrorPageDataModel(t){let i=n.Host.getLocString("PreviewPaneErrorMessage").split("{0}"),r=[],u=n.Host.getLocString("PreviewPaneErrorMessage",t);for(let n=0;n<i.length;n++)r.push({text:i[n]});const f={isOnline:n.isBrowserOnline(),previewPaneTitle:"",previewPaneItems:r,fullPartialQuery:t,narratorMessage:u};this.onPreviewPaneErrored(f)}handleClickEvent(t){let u=n.getCurrentTime(),f=n.getInputType(t),r=10;this.previewPaneViewModelParent.onBeforeItemLaunch(u,f,r);const i=this.findBfbAnchor(t.target);i&&i.href&&(t.preventDefault(),n.Host.launchUri(i.href));this.previewPaneViewModelParent.onAfterItemLaunch(r)}findBfbAnchor(n){return n?n.tagName==="a"||n.tagName==="A"?n:this.findBfbAnchor(n.parentElement):undefined}}n.MsbPreviewPaneViewModel=t}(WSB||(WSB={})),function(n){var t;(function(n){n.MsbBrandingBar=i=>{const{dataModel:r}=i;if(!r||!r.msbBranding)return null;const{backColor:u}=r.msbBranding,f={background:u},e=n.classNames("rightHeaderButtons brandingBarContainer",{"brandingBarContainer-minimal":r.isWin11DSB&&!r.areScopesVisibile});return React.createElement("div",{className:e,style:f},React.createElement(t,Object.assign({},i)))};const t=n=>{const{dataModel:i}=n,{logoDataUri:t,companyName:r,fontColor:u,iconLargeIsDefault:f}=i.msbBranding,e={color:u};return t&&!f?React.createElement("img",{className:"brandingBarImage",src:t}):React.createElement("span",{className:"brandingBarText",style:e},r)}})(t=n.View||(n.View={}))}(WSB||(WSB={}));1